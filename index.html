<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nest Displacement</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“è¥é€ å¤å¤æ„Ÿ */
      background-color: #fff;
      color: #000;
      overflow: hidden;
      filter: grayscale(100%); /* æ·»åŠ è¿™ä¸€è¡Œï¼Œä½¿æ•´ä¸ªé¡µé¢å˜æˆé»‘ç™½ */
    }

    .initial-state {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .hello {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 14px;
    }

    .start-button {
      font-family: monospace;
      font-size: 16px;
      padding: 10px 20px;
      margin: 20px;
      background: none;
      border: 1px solid #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .start-button:hover {
      background-color: #000;
      color: #fff;
    }

    .skip-link {
      font-size: 12px;
      color: #666;
      text-decoration: none;
      margin-top: 10px;
    }

    .skip-link:hover {
      text-decoration: underline;
    }

    /* éšè—çš„å†…å®¹ï¼Œç­‰å¾…è§£é” */
    .hidden {
      display: none;
    }

    /* è§£é”åçš„æ ·å¼å˜åŒ– */
    .stage-1 {
      background-color: #f5f5f5;
      transition: background-color 2s ease;
    }

    .stage-2 {
      font-family: 'Times New Roman', serif;
      transition: font-family 1s ease;
    }

    .stage-3 {
      color: #333;
      transition: color 1s ease;
    }

    /* æ·»åŠ æ–°çš„æ ·å¼ */
    .journey-stage-1 {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 1s ease;
    }

    .text-fragment {
      position: absolute;
      padding: 10px;
      background: #fff;
      border: 1px solid #000;
      cursor: move;
      font-size: 14px;
      max-width: 300px;
      text-align: left;
      transition: all 0.3s ease;
      opacity: 0;
      line-height: 1.6;
      user-select: none;
    }

    .text-fragment.visible {
      opacity: 1;
    }

    .text-fragment:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .collected-text {
      font-size: 12px;
      line-height: 1.6;
      margin: 0;
      padding: 5px 0;
      transition: all 0.5s ease;
    }

    .collected-text:not(:last-child) {
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .feather-outline {
      position: absolute;
      width: 500px;
      min-height: 300px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid;
      border-color: #dfdfdf #808080 #808080 #dfdfdf;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      transition: all 0.3s ease;
    }

    .feather-outline.minimizing {
      transform: translate(-50%, -50%) scale(0.1);
      opacity: 0;
    }

    /* è®°äº‹æœ¬æ ‡é¢˜æ  */
    .notepad-title {
      background: #000080;
      color: white;
      padding: 3px 5px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notepad-title-buttons {
      display: flex;
      gap: 2px;
    }

    .title-button {
      width: 16px;
      height: 14px;
      background: #c0c0c0;
      border: 1px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
    }

    /* æœ€å°åŒ–æŒ‰é’®æ ·å¼ */
    .title-button.minimize {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
    }

    .title-button.minimize.active {
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
    }

    /* æ”¾å¤§å’Œå…³é—­æŒ‰é’®çš„ç¦ç”¨æ ·å¼ */
    .title-button.maximize,
    .title-button.close {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
      background: #d4d4d4;
    }

    /* è®°äº‹æœ¬å†…å®¹åŒº */
    .notepad-content {
      flex: 1;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #808080;
      border-top: 2px solid #808080;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-y: auto;
      min-height: 250px;
      outline: none;
      caret-color: #000;
    }

    .notepad-content::selection {
      background: #000080;
      color: #fff;
    }

    /* æ–‡æœ¬ç¢ç‰‡çš„åˆå§‹ä½ç½® */
    .text-fragment:nth-child(1) {
      top: 30%;
      left: 20%;
    }

    .text-fragment:nth-child(2) {
      top: 50%;
      right: 25%;
    }

    /* ç®€åŒ–æç¤ºå…ƒç´ çš„æ ·å¼ï¼Œç§»é™¤è¿‡æ¸¡åŠ¨ç”» */
    .unlock-text {
      position: absolute;
      left: 25%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
    }

    .unlock-emoji {
      position: absolute;
      right: 25%;
      top: 50%;
      transform: translate(50%, -50%);
      font-size: 48px;
      opacity: 0;
      visibility: hidden;
      z-index: 1000;
      cursor: pointer;
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* æ·»åŠ å¼¹æ€§åŠ¨ç”» */
    }

    /* æ·»åŠ æ‚¬åœæ•ˆæœ */
    .unlock-emoji:hover {
      transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      animation: wiggle 0.5s infinite alternate;
    }

    /* æ·»åŠ æ‘‡æ™ƒåŠ¨ç”» */
    @keyframes wiggle {
      0% {
        transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      }
      100% {
        transform: translate(50%, -50%) rotate(15deg) scale(1.2);
      }
    }

    /* ç®€åŒ–æ˜¾ç¤ºç±» */
    .unlock-text.show,
    .unlock-emoji.show {
      opacity: 1;
      visibility: visible;
    }

    /* ä¿®æ”¹æ˜Ÿå·æŒ‰é’®æ ·å¼ï¼Œç¡®ä¿åªæœ‰ä¸€å¤„å®šä¹‰é¢œè‰² */
    .star-button {
      position: fixed;
      top: 17px;
      left: 20px;
      font-family: monospace;
      font-size: 24px;
      user-select: none;
      z-index: 2000;
      display: none;
      color: #000 !important; /* ä½¿ç”¨ !important ç¡®ä¿é¢œè‰²ä¸è¢«å…¶ä»–æ ·å¼è¦†ç›– */
      pointer-events: none;
    }

    .star-button.unlocked {
      pointer-events: auto;
      cursor: pointer;
      /* ç§»é™¤ä»»ä½•é¢œè‰²ç›¸å…³çš„æ ·å¼ */
    }

    /* ä¿®æ”¹èœå•æ ·å¼ */
    .effects-menu {
      position: fixed;
      top: 0;
      left: 0;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      display: none;
      z-index: 1999;
      background: white;
    }

    .menu-title {
      margin-bottom: 20px;
      margin-left: 35px; /* ä¸æ˜Ÿå·å¯¹é½ */
      white-space: pre;
    }

    .section-title {
      white-space: pre;
      margin-left: 45px; /* æ¯”æ˜Ÿå·ä½ç½®ç¨å¾®é å³ä¸€ç‚¹ */
      margin-top: -20px; /* ä¸Šç§»åˆ°ä¸æ˜Ÿå·åŒä¸€æ°´å¹³çº¿ */
    }

    .effects-list {
      margin-left: 2px;
      margin-top: 10px; /* ä»20pxæ”¹ä¸º10pxï¼Œå‘ä¸Šç§»åŠ¨10åƒç´  */
      white-space: pre;
    }

    .effect-item {
      display: flex;
      align-items: center;
      gap: 10px; /* æ·»åŠ é€‰é¡¹æ¡†å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
      color: #888;
      cursor: default;
    }

    .effect-item.unlocked {
      color: #000;
      cursor: pointer;
    }

    .checkbox {
      font-family: monospace;
      user-select: none;
    }

    /* é€‰ä¸­çŠ¶æ€çš„æ ·å¼ */
    .effect-item.checked .checkbox {
      content: '[*]';
    }

    /* ä¿®æ”¹å­èœå•æ ·å¼ */
    .color-submenu {
      position: fixed;
      top: 0;
      right: 0; /* æ”¹ä¸º0ï¼Œç›´æ¥è´´ä½å³è¾¹ */
      background: white;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      display: none;
      z-index: 1998;
    }

    .slider-group {
      margin-bottom: 30px; /* å¢åŠ æ»‘å—ç»„ä¹‹é—´çš„é—´è· */
      width: 200px; /* å›ºå®šå®½åº¦ */
    }

    .slider-label {
      margin-bottom: 10px;
      white-space: pre;
    }

    .color-slider {
      width: 100%; /* ä½¿ç”¨çˆ¶å…ƒç´ çš„å®½åº¦ */
      -webkit-appearance: none;
      appearance: none;
      height: 2px;
      background: #000;
      outline: none;
      position: relative;
    }

    .color-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 20px;
      background: #000;
      cursor: pointer;
    }

    /* æ·»åŠ æ»‘å—ä¸¤ç«¯çš„çº¿æ¡ */
    .color-slider::before,
    .color-slider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 20px;
      height: 2px;
      background: #000;
    }

    .color-slider::before {
      left: -20px;
    }

    .color-slider::after {
      right: -20px;
    }

    /* æ·»åŠ ç¦ç”¨çŠ¶æ€çš„æ ·å¼ */
    .effect-checkbox[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .effect-item {
      opacity: 0.5; /* åˆå§‹çŠ¶æ€æ˜¾ç¤ºä¸ºåŠé€æ˜ */
      transition: opacity 0.3s ease;
    }

    .effect-item.unlocked {
      opacity: 1; /* è§£é”åæ˜¾ç¤ºä¸ºå®Œå…¨ä¸é€æ˜ */
      cursor: pointer;
    }

    /* æ·»åŠ æœ€å°åŒ–ç›¸å…³çš„æ ·å¼ */
    .minimized-notepad {
      position: fixed;
      left: 20px;
      bottom: 20px;
      cursor: pointer;
      z-index: 9999;
      display: none;
    }

    .notepad-icon {
      width: 64px;
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 5px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: 2px 2px 0 #000;
    }

    .icon-image {
      font-size: 32px;
      display: inline-block;
      margin-bottom: 5px;
    }

    .icon-text {
      font-family: monospace;
      font-size: 12px;
      text-align: center;
    }

    /* ä¿®æ”¹æœ€å°åŒ–æŒ‰é’®æ ·å¼ */
    .title-button.minimize {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
    }

    .title-button.minimize.active {
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
    }

    .minimized-icon {
      position: fixed;
      left: 50%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-size: 48px;
      cursor: move;
      z-index: 9999;
      margin: 0;
      padding: 0;
      pointer-events: auto;
      user-select: none;
      text-align: center;
    }

    .icon-label {
      font-family: monospace;
      font-size: 14px;
      margin-top: 5px;
      color: #000;
      white-space: nowrap;
      text-align: center;
    }

    /* æ‹–åŠ¨æ—¶çš„æ ·å¼ */
    .minimized-icon.dragging {
      opacity: 0.7;
    }

    /* æ·»åŠ é‡å¤æç¤ºçš„æ ·å¼ */
    .repeat-text {
      position: fixed;
      left: 25%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .again-text {
      position: fixed;
      right: 25%;
      top: 50vh;
      transform: translate(50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .repeat-text.show,
    .again-text.show {
      opacity: 1;
      visibility: visible;
    }

    /* æ·»åŠ ç‚¼é‡‘æœ¯è§£é”æç¤ºçš„æ ·å¼ */
    .alchemy-text {
        position: absolute;
      left: 17%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .alchemy-emoji {
        position: absolute;
      right: 17%;
      top: 50vh;
      transform: translate(50%, -50%);
      font-size: 48px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .alchemy-text.show,
    .alchemy-emoji.show {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>
<body>
  <div class="initial-state">
    <div class="hello">Hello, world!</div>
    <button class="start-button" onclick="startJourney()">Start</button>
    <a href="#" class="skip-link" onclick="skipToNest()">Skip to nest</a>
  </div>

  <!-- éšè—çš„å†…å®¹ï¼Œç­‰å¾…è§£é” -->
  <div id="journey-content" class="hidden">
    <div class="journey-stage-1">
      <div class="unlock-emoji">ğŸ</div>
      <div class="unlock-text">Colors unlocked</div>
      <div class="feather-outline">
        <div class="notepad-title">
          <span>Untitled - Notepad</span>
          <div class="notepad-title-buttons">
            <button class="title-button minimize">_</button>
            <button class="title-button maximize">â–¡</button>
            <button class="title-button close">Ã—</button>
          </div>
        </div>
        <div class="notepad-content" id="dropZone" contenteditable="true" spellcheck="false"></div>
      </div>
    </div>
  </div>

  <div id="nest-generator" class="hidden">
    <!-- æœ€ç»ˆçš„ç”Ÿæˆå™¨å·¥å…· -->
  </div>

  <!-- ä¿®æ”¹èœå•HTMLç»“æ„ -->
  <div class="star-button">*</div>
  <div class="effects-menu">
    <div class="menu-title">Nest Displacement</div>
    <div class="menu-section">
      <div class="section-title">/EFFECTS</div>
      <div class="effects-list">
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">COLOR</span>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ é¢œè‰²æ§åˆ¶å­èœå• -->
  <div class="color-submenu">
    <div class="slider-group">
      <div class="slider-label">HUE</div>
      <input type="range" class="color-slider" id="hueSlider" min="0" max="360" value="180">
    </div>
    <div class="slider-group">
      <div class="slider-label">BRIGHTNESS</div>
      <input type="range" class="color-slider" id="brightnessSlider" min="0" max="100" value="50">
    </div>
    <div class="slider-group">
      <div class="slider-label">SATURATION</div>
      <input type="range" class="color-slider" id="saturationSlider" min="0" max="100" value="50">
    </div>
  </div>

  <!-- åœ¨ body ä¸­æ·»åŠ æœ€å°åŒ–åçš„å›¾æ ‡å®¹å™¨ -->
  <div class="minimized-notepad">
    <div class="notepad-icon">
      <span class="icon-image">ğŸ“</span>
      <span class="icon-text">Untitled</span>
    </div>
  </div>

  <div class="minimized-icon" style="display: none;">
    ğŸ—’ï¸
    <div class="icon-label">Alchemy furnace</div>
  </div>

  <!-- æ·»åŠ é‡å¤æç¤ºçš„HTML -->
  <div class="repeat-text">Repeat</div>
  <div class="again-text">Again</div>

  <!-- æ·»åŠ ç‚¼é‡‘æœ¯è§£é”æç¤ºçš„HTML -->
  <div class="alchemy-text">Alchemy Setup Unlocked</div>
  <div class="alchemy-emoji">ğŸ</div>

  <script>
    // æ·»åŠ æ–‡æœ¬æ•°ç»„
    const textSequence = [
      "Pet lovebirds often use their beaks to carefully cut pieces of paper and tuck them into their tail feathers.",
      "Despite being born and raised in artificial environments, they retain their instinctual drive as animals to collect diverse materials for nesting.",
      "Consequently, it's common to observe domestic lovebirds decorating themselves with objects produced by human society,",
      "resulting in a quirky yet fascinating sight. Inspired by this behavior,",
      "I've coined a new artistic term, Nest Displacement, to describe instinct-driven creative behaviors within artificial contexts, encompassing adaptation and mutation,",
      "or how individuals seek new possibilities within predefined structures.",
      "Another term, Nest-Grafting, combining the concepts of 'embedding' and 'nesting,'",
      "refers to an individual's appropriation and transformation of surrounding materials, describing artistic actions that incorporate heterogeneous elements into one's own system."
    ];

    let currentTextIndex = 0;
    let isColorUnlocked = false; // æ·»åŠ ä¸€ä¸ªçŠ¶æ€æ ‡è®°
    let isMenuUnlocked = false;

    // æ·»åŠ é¸Ÿç±»åç§°æ•°ç»„
    const birds = [
      'Common_lovebird',
      'Rosy-faced_lovebird',
      'Fischer%27s_lovebird',
      'Yellow-collared_lovebird',
      'Budgerigar',
      'Cockatiel',
      'African_grey_parrot',
      'Galah',
      'Rainbow_lorikeet',
      'Monk_parakeet'
    ];

    function startJourney() {
      document.querySelector('.initial-state').style.display = 'none';
      const journeyContent = document.getElementById('journey-content');
      journeyContent.classList.remove('hidden');
      
      // æ˜¾ç¤ºæ˜Ÿå·æŒ‰é’®ï¼Œç¡®ä¿æ˜¯é»‘è‰²
      const starButton = document.querySelector('.star-button');
      starButton.style.display = 'block';
      starButton.style.color = '#000'; // ç¡®ä¿æ˜¾ç¤ºæ—¶å°±æ˜¯é»‘è‰²
      
      setTimeout(() => {
        const stage1 = document.querySelector('.journey-stage-1');
        stage1.style.opacity = '1';
        initDragAndDrop();
        initNotepad();
        showNextText();
      }, 100);
    }

    function skipToNest() {
      document.querySelector('.initial-state').style.display = 'none';
      const nestGenerator = document.getElementById('nest-generator');
      nestGenerator.classList.remove('hidden');
      // ç›´æ¥æ¿€æ´»æ‰€æœ‰åŠŸèƒ½
      activateAllFeatures();
    }

    function initDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      const notepad = document.querySelector('.feather-outline');
      
      // é˜²æ­¢è®°äº‹æœ¬çª—å£æ¥æ”¶æ‹–æ”¾
      notepad.addEventListener('dragover', (e) => {
        if (e.target !== dropZone && !dropZone.contains(e.target)) {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      // åªå…è®¸å†…å®¹åŒºåŸŸæ¥æ”¶æ‹–æ”¾
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#f0f0f0';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = '#ffffff';
      });

      dropZone.addEventListener('drop', handleDrop);
    }

    function showNextText() {
      if (currentTextIndex >= textSequence.length) {
        // è§£é”èœå•
        const starButton = document.querySelector('.star-button');
        starButton.classList.add('unlocked');
        
        // è§£é” COLOR é€‰é¡¹
        isColorUnlocked = true;
        const colorEffect = document.querySelector('.effect-item');
        colorEffect.classList.add('unlocked');
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.disabled = false;
        
        showUnlockEffects();
        startStage2();
        return;
      }

      const fragment = document.createElement('div');
      fragment.className = 'text-fragment';
      fragment.textContent = textSequence[currentTextIndex];
      fragment.draggable = true;
      
      // éšæœºä½ç½®
      const randomPosition = getRandomPosition();
      fragment.style.left = randomPosition.x + 'px';
      fragment.style.top = randomPosition.y + 'px';

      document.querySelector('.journey-stage-1').appendChild(fragment);

      // æ·»åŠ æ‹–æ‹½äº‹ä»¶
      fragment.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', fragment.textContent);
        e.target.style.opacity = '0.5';
      });

      fragment.addEventListener('dragend', (e) => {
        e.target.style.opacity = '1';
      });

      setTimeout(() => fragment.classList.add('visible'), 100);
    }

    function handleDrop(e) {
      e.preventDefault();
      
      // ç¡®ä¿åªæœ‰å†…å®¹åŒºåŸŸå¯ä»¥æ¥æ”¶æ‹–æ”¾
      const dropZone = document.getElementById('dropZone');
      if (e.target !== dropZone && !dropZone.contains(e.target)) {
        return; // å¦‚æœä¸æ˜¯æ‹–åˆ°å†…å®¹åŒºåŸŸï¼Œç›´æ¥è¿”å›
      }

      dropZone.style.backgroundColor = '#ffffff';

      // è·å–æ‹–åŠ¨çš„æ–‡æœ¬
      const text = e.dataTransfer.getData('text/plain');
      
      // è·å–å½“å‰å…‰æ ‡ä½ç½®æˆ–æœ«å°¾
      const selection = window.getSelection();
      let range;
      
      if (selection.rangeCount > 0) {
        range = selection.getRangeAt(0);
      } else {
        range = document.createRange();
        range.selectNodeContents(dropZone);
        range.collapse(false);
      }

      // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
      const textNode = document.createTextNode(
        (dropZone.textContent ? '\n\n' : '') + text
      );
      range.insertNode(textNode);

      // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥æ–‡æœ¬çš„æœ«å°¾
      range.setStartAfter(textNode);
      range.setEndAfter(textNode);
      selection.removeAllRanges();
      selection.addRange(range);

      // ç§»é™¤åŸå§‹æ‹–åŠ¨çš„æ–‡æœ¬
      const draggedText = document.querySelector('.text-fragment');
      draggedText.remove();

      // æ˜¾ç¤ºä¸‹ä¸€æ®µæ–‡æœ¬
      currentTextIndex++;
      showNextText();

      // ä¿æŒç„¦ç‚¹
      dropZone.focus();
    }

    function getRandomPosition() {
      const padding = 50;
      const maxWidth = window.innerWidth - 400;
      const maxHeight = window.innerHeight - 100;
      
      // é¿å…ç”Ÿæˆåœ¨ä¸­å¤®åŒºåŸŸ
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      let x, y;
      
      do {
        x = padding + Math.random() * (maxWidth - padding * 2);
      } while (Math.abs(x - centerX) < 300);
      
      do {
        y = padding + Math.random() * (maxHeight - padding * 2);
      } while (Math.abs(y - centerY) < 200);

      return { x, y };
    }

    function startStage2() {
      document.body.classList.add('stage-1');
      // ä¸å†è‡ªåŠ¨ç§»é™¤æ»¤é•œï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç¤¼ç‰©
    }

    function activateAllFeatures() {
      // æ¿€æ´»æ‰€æœ‰é«˜çº§åŠŸèƒ½
      document.body.classList.add('stage-1', 'stage-2', 'stage-3');
      // åˆå§‹åŒ–ç”Ÿæˆå™¨å·¥å…·
      initNestGenerator();
      initDragAndDrop();
    }

    function initNestGenerator() {
      // è¿™é‡Œå°†å®ç°æœ€ç»ˆçš„ç”Ÿæˆå™¨å·¥å…·åŠŸèƒ½
    }

    // æ·»åŠ è®°äº‹æœ¬åˆå§‹åŒ–å‡½æ•°
    function initNotepad() {
      const dropZone = document.getElementById('dropZone');
      
      // è‡ªåŠ¨èšç„¦
      dropZone.focus();

      // æ·»åŠ å¿«æ·é”®æ”¯æŒ
      dropZone.addEventListener('keydown', (e) => {
        // Tabé”®æ”¯æŒ
        if (e.key === 'Tab') {
          e.preventDefault();
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          const tabNode = document.createTextNode('    '); // 4ä¸ªç©ºæ ¼
          range.insertNode(tabNode);
          range.setStartAfter(tabNode);
          range.setEndAfter(tabNode);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      });
    }

    // æ·»åŠ éšæœºé¢œè‰²ç”Ÿæˆå‡½æ•°
    function getRandomPastelColor() {
      // ç”ŸæˆæŸ”å’Œçš„é¢œè‰²
      const hue = Math.floor(Math.random() * 360); // éšæœºè‰²ç›¸
      const saturation = 30 + Math.random() * 20; // 30-50%çš„é¥±å’Œåº¦
      const lightness = 85 + Math.random() * 10; // 85-95%çš„äº®åº¦
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    // ä¿®æ”¹ showUnlockEffects å‡½æ•°
    function showUnlockEffects() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      const notepad = document.querySelector('.feather-outline');
      
      // è·å–è®°äº‹æœ¬çš„ä½ç½®ä¿¡æ¯
      const notepadRect = notepad.getBoundingClientRect();
      const windowWidth = window.innerWidth;
      
      // è®¡ç®—å·¦å³åŒºåŸŸçš„ä¸­ç‚¹
      const leftAreaCenter = notepadRect.left / 2;
      const rightAreaCenter = (windowWidth - notepadRect.right) / 2 + notepadRect.right;
      
      // è®¾ç½®æ–‡å­—å’Œemojiçš„ä½ç½®
      text.style.left = `${leftAreaCenter}px`;
      emoji.style.right = `${windowWidth - rightAreaCenter}px`;
      
      // æ˜¾ç¤ºå…ƒç´ 
      text.classList.add('show');
      emoji.classList.add('show');

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      emoji.addEventListener('click', unlockColors);
    }

    // ä¿®æ”¹ unlockColors å‡½æ•°
    function unlockColors() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      
      // ç§»é™¤é»‘ç™½æ»¤é•œ
      document.body.style.transition = 'filter 1s ease, background-color 1s ease';
      document.body.style.filter = 'grayscale(0%)';
      
      // è®¾ç½®éšæœºèƒŒæ™¯è‰²
      document.body.style.backgroundColor = getRandomPastelColor();
      
      // ç§»é™¤æç¤ºå…ƒç´ 
      emoji.style.visibility = 'hidden';
      text.style.visibility = 'hidden';
      
      // è§£é”èœå•
      isMenuUnlocked = true;
      const starButton = document.querySelector('.star-button');
      starButton.classList.add('unlocked');
      
      // è§£é” COLOR é€‰é¡¹
      isColorUnlocked = true;
      const colorEffect = document.querySelector('.effect-item');
      colorEffect.classList.add('unlocked');
      const checkbox = colorEffect.querySelector('.checkbox');
      checkbox.disabled = false;
      
      // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤è§¦å‘
      emoji.removeEventListener('click', unlockColors);
    }

    // æ·»åŠ ä½ç½®æ£€æŸ¥å’Œè°ƒæ•´å‡½æ•°
    function adjustSubmenuPosition() {
      const submenu = document.querySelector('.color-submenu');
      if (!submenu || submenu.style.display === 'none') return;

      const rect = submenu.getBoundingClientRect();
      const windowHeight = window.innerHeight;

      // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè§†çª—åº•éƒ¨
      if (rect.bottom > windowHeight) {
        // è°ƒæ•´ä½ç½®ï¼Œç¡®ä¿åœ¨è§†çª—å†…
        submenu.style.top = 'auto';
        submenu.style.bottom = '20px';
        submenu.style.transform = 'none';
      }
    }

    // ä¿®æ”¹é¢œè‰²æ§åˆ¶é€»è¾‘
    function initializeColorControl() {
      const colorEffect = document.querySelector('.effect-item');
      const colorSubmenu = document.querySelector('.color-submenu');
      const hueSlider = document.getElementById('hueSlider');
      const brightnessSlider = document.getElementById('brightnessSlider');
      const saturationSlider = document.getElementById('saturationSlider');
      let isChecked = false;

      // ç‚¹å‡» COLOR é€‰é¡¹çš„å¤„ç†
      colorEffect.addEventListener('click', (e) => {
        if (!colorEffect.classList.contains('unlocked')) return;

        isChecked = !isChecked;
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.textContent = isChecked ? '[*]' : '[ ]';
        colorEffect.classList.toggle('checked');
        colorSubmenu.style.display = isChecked ? 'block' : 'none';
      });

      // æ»‘å—æ§åˆ¶é¢œè‰²
      function updateColor() {
        const hue = hueSlider.value;
        const brightness = brightnessSlider.value;
        const saturation = saturationSlider.value;
        
        document.body.style.backgroundColor = 
          `hsl(${hue}, ${saturation}%, ${brightness}%)`;
      }

      // æ·»åŠ æ»‘å—äº‹ä»¶ç›‘å¬
      hueSlider.addEventListener('input', updateColor);
      brightnessSlider.addEventListener('input', updateColor);
      saturationSlider.addEventListener('input', updateColor);
    }

    // ä¿®æ”¹æ˜Ÿå·æŒ‰é’®çš„åˆå§‹åŒ–
    function initializeMenu() {
      const starButton = document.querySelector('.star-button');
      const menu = document.querySelector('.effects-menu');
      let isMenuOpen = false;

      starButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!isMenuUnlocked) return;

        isMenuOpen = !isMenuOpen;
        menu.style.display = isMenuOpen ? 'block' : 'none';
      });

      document.addEventListener('click', (e) => {
        if (isMenuOpen && !menu.contains(e.target)) {
          isMenuOpen = false;
          menu.style.display = 'none';
        }
      });

      initializeColorControl();
    }

    // æ·»åŠ çª—å£å¤§å°æ”¹å˜æ—¶çš„ä½ç½®è°ƒæ•´
    window.addEventListener('resize', adjustSubmenuPosition);

    // æ·»åŠ æœ€å°åŒ–åŠŸèƒ½ç›¸å…³çš„ä»£ç 
    function initializeMinimize() {
      const minimizeButton = document.querySelector('.title-button');
      const notepad = document.querySelector('.feather-outline');
      const minimizedIcon = document.querySelector('.minimized-icon');
      const dropZone = document.getElementById('dropZone');
      const repeatText = document.querySelector('.repeat-text');
      const againText = document.querySelector('.again-text');
      const alchemyText = document.querySelector('.alchemy-text');
      const alchemyEmoji = document.querySelector('.alchemy-emoji');
      let isFirstRestore = true;
      let interactionCount = 0;
      let alchemyUnlocked = false;
      let alchemyShown = false;
      
      // åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºç¦ç”¨
      minimizeButton.classList.add('minimize');

      // åœ¨è§£é”é¢œè‰²æ—¶æ¿€æ´»æœ€å°åŒ–æŒ‰é’®
      function activateMinimizeButton() {
        minimizeButton.classList.add('active');
      }

      // è·å–éšæœºé¸Ÿç±»å›¾ç‰‡
      async function getRandomBirdImage() {
        const randomBird = birds[Math.floor(Math.random() * birds.length)];
        try {
          // æ·»åŠ å¿…è¦çš„å‚æ•°ä»¥æ”¯æŒCORSå’ŒJSONæ ¼å¼
          const url = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages|pageprops&format=json&piprop=thumbnail&titles=${randomBird}&pithumbsize=300&redirects&origin=*`;
          
          console.log('Fetching image for:', randomBird); // è°ƒè¯•æ—¥å¿—
          const response = await fetch(url);
          if (!response.ok) throw new Error('Network response was not ok');
          
          const data = await response.json();
          console.log('API response:', data); // è°ƒè¯•æ—¥å¿—
          
          if (!data.query || !data.query.pages) throw new Error('Invalid API response');
          
          const pages = data.query.pages;
          const pageId = Object.keys(pages)[0];
          const page = pages[pageId];
          
          if (!page || !page.thumbnail || !page.thumbnail.source) {
            throw new Error('No image found');
          }
          
          // é¢„åŠ è½½å›¾ç‰‡
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(page.thumbnail.source);
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = page.thumbnail.source;
          });
        } catch (error) {
          console.error('Error fetching bird image:', error);
          return null;
        }
      }

      // æ˜¾ç¤ºé‡å¤æç¤º
      function showRepeatText() {
        // ç¡®ä¿å…ƒç´ å¯è§
        repeatText.style.display = 'block';
        againText.style.display = 'block';
        
        // æ·»åŠ showç±»è§¦å‘è¿‡æ¸¡æ•ˆæœ
        setTimeout(() => {
          repeatText.classList.add('show');
          againText.classList.add('show');
        }, 50);
      }

      // éšè—é‡å¤æç¤º
      function hideRepeatText() {
        repeatText.classList.remove('show');
        againText.classList.remove('show');
        
        // ç­‰å¾…è¿‡æ¸¡æ•ˆæœå®Œæˆåéšè—å…ƒç´ 
        setTimeout(() => {
          repeatText.style.display = 'none';
          againText.style.display = 'none';
        }, 500);
      }

      // æ˜¾ç¤ºç‚¼é‡‘æœ¯è§£é”æç¤º
      function showAlchemyUnlock() {
        if (!alchemyShown) {
          // ç¡®ä¿å…ƒç´ å¯è§
          alchemyText.style.display = 'block';
          alchemyEmoji.style.display = 'block';
          
          // æ·»åŠ showç±»è§¦å‘è¿‡æ¸¡æ•ˆæœ
          setTimeout(() => {
            alchemyText.classList.add('show');
            alchemyEmoji.classList.add('show');
          }, 50);
          
          alchemyShown = true;
        }
      }

      // éšè—ç‚¼é‡‘æœ¯è§£é”æç¤º
      function hideAlchemyUnlock() {
        if (alchemyShown) {
          alchemyText.classList.remove('show');
          alchemyEmoji.classList.remove('show');
          
          setTimeout(() => {
            alchemyText.style.display = 'none';
            alchemyEmoji.style.display = 'none';
          }, 500);
          
          alchemyShown = false;
        }
      }

      // æ£€æŸ¥äº¤äº’æ¬¡æ•°
      function checkInteractions() {
        // åªåœ¨æœ€å°åŒ–æ—¶å¢åŠ è®¡æ•°
        if (notepad.style.display === 'none') {
          interactionCount++;
          console.log('Interaction count:', interactionCount);
          
          if (interactionCount === 3 && !alchemyUnlocked) {
            alchemyUnlocked = true;
            showAlchemyUnlock();
          } else if (interactionCount > 3 && alchemyUnlocked) {
            // åœ¨ç¬¬å››æ¬¡äº¤äº’æ—¶éšè—æç¤º
            hideAlchemyUnlock();
          }
        }
      }

      // æœ€å°åŒ–åŠ¨ç”»
      function minimizeNotepad() {
        if (!minimizeButton.classList.contains('active')) return;
        notepad.style.display = 'none';
        minimizedIcon.style.display = 'block';
        hideRepeatText();
        checkInteractions();
      }

      // åŠ è½½å¹¶æ˜¾ç¤ºé¸Ÿç±»å›¾ç‰‡
      async function loadBirdImage() {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        dropZone.innerHTML = 'Loading bird image...';
        dropZone.style.padding = '10px';
        
        try {
          const imageUrl = await getRandomBirdImage();
          console.log('Image URL:', imageUrl); // è°ƒè¯•æ—¥å¿—
          
          if (imageUrl) {
            dropZone.style.padding = '0';
            dropZone.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
              max-width: 100%;
              height: auto;
              display: block;
              margin: 0 auto;
              object-fit: contain;
            `;
            dropZone.appendChild(img);
            
            // åªåœ¨ç¬¬ä¸€æ¬¡æ˜¾ç¤ºé‡å¤æç¤º
            if (isFirstRestore) {
              showRepeatText();
              isFirstRestore = false;
            }
          } else {
            dropZone.innerHTML = 'Failed to load bird image';
            dropZone.style.padding = '10px';
          }
        } catch (error) {
          console.error('Error displaying image:', error);
          dropZone.innerHTML = 'Failed to load bird image';
          dropZone.style.padding = '10px';
        }
      }

      // è¿˜åŸè®°äº‹æœ¬
      async function restoreNotepad() {
        minimizedIcon.style.display = 'none';
        notepad.style.display = 'flex';
        // æ¯æ¬¡æ‰“å¼€éƒ½åŠ è½½æ–°å›¾ç‰‡
        await loadBirdImage();
      }

      // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
      let isDragging = false;
      let currentX;
      let currentY;
      let initialX;
      let initialY;
      let xOffset = 0;
      let yOffset = 0;

      function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === minimizedIcon) {
          isDragging = true;
          minimizedIcon.classList.add('dragging');
        }
      }

      function dragEnd() {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
        minimizedIcon.classList.remove('dragging');
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;
          xOffset = currentX;
          yOffset = currentY;

          minimizedIcon.style.transform = `translate(${currentX}px, ${currentY}px)`;
        }
      }

      // æ·»åŠ äº‹ä»¶ç›‘å¬
      minimizedIcon.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);
      minimizeButton.addEventListener('click', minimizeNotepad);
      minimizedIcon.addEventListener('dblclick', restoreNotepad);

      // ä¿®æ”¹ unlockColors å‡½æ•°ï¼Œæ·»åŠ æ¿€æ´»æœ€å°åŒ–æŒ‰é’®çš„è°ƒç”¨
      const originalUnlockColors = unlockColors;
      unlockColors = function() {
        originalUnlockColors();
        activateMinimizeButton();
      };
    }

    // åœ¨é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initializeMenu();
      initializeColorControl();
      initializeMinimize();
    });
  </script>
</body>
</html>