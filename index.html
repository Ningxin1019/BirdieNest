<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nest Displacement</title>
  <script src="seam.js" defer></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import {
      getDatabase,
      ref,
      onValue,
      update,
      set
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBzbTuyiCXml_9lqF2XJS7fF0tluvizV7g",
      authDomain: "nestdisplacement.firebaseapp.com",
      databaseURL: "https://nestdisplacement-default-rtdb.firebaseio.com",
      projectId: "nestdisplacement",
      storageBucket: "nestdisplacement.firebasestorage.app",
      messagingSenderId: "707900225193",
      appId: "1:707900225193:web:dca902938e4b41aed95bb8",
      measurementId: "G-M818THVNFF"
    };

    // åœ¨ Firebase åˆå§‹åŒ–è„šæœ¬ä¸­æ·»åŠ æ•°æ®åº“è¿æ¥æµ‹è¯•
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        
        // æµ‹è¯•æ•°æ®åº“è¿æ¥å’Œæƒé™
        const testRef = ref(database, 'grid/test');
        try {
          await set(testRef, {
            timestamp: Date.now()
          });
          console.log('Firebase database connection and permissions verified');
          await set(testRef, null); // æ¸…ç†æµ‹è¯•æ•°æ®
        } catch (error) {
          console.error('Firebase database permission error:', error);
          alert('Firebase database permission error. Please check database rules.');
          return;
        }
        
        // ä¿å­˜ Firebase å®ä¾‹åˆ°å…¨å±€å˜é‡
        window.firebaseApp = app;
        window.firebaseAnalytics = analytics;
        window.firebaseDb = database;
        window.firebaseRef = ref(database, 'grid');
        window.firebaseUpdate = update;
        window.firebaseSet = set;
        window.onValue = onValue;  // æ·»åŠ è¿™ä¸€è¡Œï¼Œä¿å­˜ onValue å‡½æ•°åˆ°å…¨å±€
        
        // åˆå§‹åŒ–ç½‘æ ¼
        window.grid = new CharacterGrid();
      } catch (error) {
        console.error('Error initializing Firebase:', error);
        alert('Failed to initialize Firebase. Please check console for details.');
      }
    });
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: monospace; /* ä½¿ç”¨ç­‰å®½å­—ä½“è¥é€ å¤å¤æ„Ÿ */
      background-color: #fff;
      color: #000;
      overflow: hidden;
      filter: grayscale(100%); /* æ·»åŠ è¿™ä¸€è¡Œï¼Œä½¿æ•´ä¸ªé¡µé¢å˜æˆé»‘ç™½ */
    }

    .initial-state {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 1;
    }

    .initial-state > * {
      pointer-events: auto;
    }

    .hello {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px;
      border-radius: 3px;
    }

    .start-button {
      font-family: monospace;
      font-size: 16px;
      padding: 10px 20px;
      margin: 20px;
      background: none;
      border: 1px solid #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .start-button:hover {
      background-color: #000;
      color: #fff;
    }

    .skip-link {
      font-size: 12px;
      color: #666;
      text-decoration: none;
      margin-top: 10px;
    }

    .skip-link:hover {
      text-decoration: underline;
    }

    /* éšè—çš„å†…å®¹ï¼Œç­‰å¾…è§£é” */
    .hidden {
      display: none;
    }

    /* è§£é”åçš„æ ·å¼å˜åŒ– */
    .stage-1 {
      background-color: #f5f5f5;
      transition: background-color 2s ease;
    }

    .stage-2 {
      font-family: 'Times New Roman', serif;
      transition: font-family 1s ease;
    }

    .stage-3 {
      color: #333;
      transition: color 1s ease;
    }

    /* æ·»åŠ æ–°çš„æ ·å¼ */
    .journey-stage-1 {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 1s ease;
      z-index: 1000;
    }

    .journey-stage-1 > * {
      pointer-events: auto;
    }

    .text-fragment {
      position: absolute;
      padding: 10px;
      background: #fff;
      border: 1px solid #000;
      cursor: move;
      font-size: 14px;
      max-width: 300px;
      text-align: left;
      transition: all 0.3s ease;
      opacity: 0;
      line-height: 1.6;
      user-select: none;
      z-index: 1000;
      pointer-events: auto !important;
    }

    .text-fragment.visible {
      opacity: 1;
    }

    .text-fragment:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .collected-text {
      font-size: 12px;
      line-height: 1.6;
      margin: 0;
      padding: 5px 0;
      transition: all 0.5s ease;
    }

    .collected-text:not(:last-child) {
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .feather-outline {
      position: absolute;
      width: 500px;
      min-height: 300px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid;
      border-color: #dfdfdf #808080 #808080 #dfdfdf;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      transition: none;
      resize: both;
      overflow: auto;
      max-width: 90vw;
      max-height: 80vh;
      z-index: 2;
    }

    .feather-outline.dragging {
      transition: none;
      cursor: move;
    }

    /* è®°äº‹æœ¬æ ‡é¢˜æ  */
    .notepad-title {
      background: #000080;
      color: white;
      padding: 3px 5px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .notepad-title-buttons {
      display: flex;
      gap: 2px;
    }

    .title-button {
      width: 16px;
      height: 14px;
      background: #c0c0c0;
      border: 1px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
    }

    /* æœ€å°åŒ–æŒ‰é’®æ ·å¼ */
    .title-button.minimize {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
    }

    .title-button.minimize.active {
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
    }

    /* æ”¾å¤§å’Œå…³é—­æŒ‰é’®çš„ç¦ç”¨æ ·å¼ */
    .title-button.maximize,
    .title-button.close {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
      background: #d4d4d4;
    }

    /* è®°äº‹æœ¬å†…å®¹åŒº */
    .notepad-content {
      flex: 1;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #808080;
      border-top: 2px solid #808080;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-y: auto;
      min-height: 250px;
      outline: none;
      caret-color: #000;
      max-height: calc(80vh - 30px);
    }

    .notepad-content::selection {
      background: #000080;
      color: #fff;
    }

    /* æ–‡æœ¬ç¢ç‰‡çš„åˆå§‹ä½ç½® */
    .text-fragment:nth-child(1) {
      top: 30%;
      left: 20%;
    }

    .text-fragment:nth-child(2) {
      top: 50%;
      right: 25%;
    }

    /* ç®€åŒ–æç¤ºå…ƒç´ çš„æ ·å¼ï¼Œç§»é™¤è¿‡æ¸¡åŠ¨ç”» */
    .unlock-text {
      position: absolute;
      left: 25%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
    }

    .unlock-emoji {
      position: absolute;
      right: 25%;
      top: 50%;
      transform: translate(50%, -50%);
      font-size: 48px;
      opacity: 0;
      visibility: hidden;
      z-index: 1000;
      cursor: pointer;
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* æ·»åŠ å¼¹æ€§åŠ¨ç”» */
    }

    /* æ·»åŠ æ‚¬åœæ•ˆæœ */
    .unlock-emoji:hover {
      transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      animation: wiggle 0.5s infinite alternate;
    }

    /* æ·»åŠ æ‘‡æ™ƒåŠ¨ç”» */
    @keyframes wiggle {
      0% {
        transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      }
      100% {
        transform: translate(50%, -50%) rotate(15deg) scale(1.2);
      }
    }

    /* ç®€åŒ–æ˜¾ç¤ºç±» */
    .unlock-text.show,
    .unlock-emoji.show {
      opacity: 1;
      visibility: visible;
    }

    /* ä¿®æ”¹æ˜Ÿå·æŒ‰é’®æ ·å¼ï¼Œç¡®ä¿åªæœ‰ä¸€å¤„å®šä¹‰é¢œè‰² */
    .star-button {
      position: fixed;
      top: 17px;
      left: 20px;
      font-family: monospace;
      font-size: 24px;
      user-select: none;
      z-index: 2000;
      display: none;
      color: #000 !important; /* ä½¿ç”¨ !important ç¡®ä¿é¢œè‰²ä¸è¢«å…¶ä»–æ ·å¼è¦†ç›– */
      pointer-events: none;
    }

    .star-button.unlocked {
      pointer-events: auto;
      cursor: pointer;
      /* ç§»é™¤ä»»ä½•é¢œè‰²ç›¸å…³çš„æ ·å¼ */
    }

    /* ä¿®æ”¹èœå•æ ·å¼ */
    .effects-menu {
      position: fixed;
      top: 0;
      left: 0;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      display: none;
      z-index: 1999;
      background: white;
    }

    .menu-title {
      margin-bottom: 20px;
      margin-left: 35px; /* ä¸æ˜Ÿå·å¯¹é½ */
      white-space: pre;
    }

    .section-title {
      white-space: pre;
      margin-left: 45px; /* æ¯”æ˜Ÿå·ä½ç½®ç¨å¾®é å³ä¸€ç‚¹ */
      margin-top: -20px; /* ä¸Šç§»åˆ°ä¸æ˜Ÿå·åŒä¸€æ°´å¹³çº¿ */
    }

    .effects-list {
      margin-left: 2px;
      margin-top: 10px; /* ä»20pxæ”¹ä¸º10pxï¼Œå‘ä¸Šç§»åŠ¨10åƒç´  */
      white-space: pre;
    }

    .effect-item {
      display: flex;
      align-items: center;
      gap: 10px; /* æ·»åŠ é€‰é¡¹æ¡†å’Œæ–‡å­—ä¹‹é—´çš„é—´è· */
      color: #888;
      cursor: default;
    }

    .effect-item.unlocked {
      color: #000;
      cursor: pointer;
    }

    .checkbox {
      font-family: monospace;
      user-select: none;
    }

    /* é€‰ä¸­çŠ¶æ€çš„æ ·å¼ */
    .effect-item.checked .checkbox {
      content: '[*]';
    }

    /* ä¿®æ”¹å­èœå•æ ·å¼ */
    .color-submenu {
      position: fixed;
      top: 0;
      right: 0; /* æ”¹ä¸º0ï¼Œç›´æ¥è´´ä½å³è¾¹ */
      background: white;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      display: none;
      z-index: 1998;
    }

    .slider-group {
      margin-bottom: 30px; /* å¢åŠ æ»‘å—ç»„ä¹‹é—´çš„é—´è· */
      width: 200px; /* å›ºå®šå®½åº¦ */
    }

    .slider-label {
      margin-bottom: 10px;
      white-space: pre;
    }

    .color-slider {
      width: 100%; /* ä½¿ç”¨çˆ¶å…ƒç´ çš„å®½åº¦ */
      -webkit-appearance: none;
      appearance: none;
      height: 2px;
      background: #000;
      outline: none;
      position: relative;
    }

    .color-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 20px;
      background: #000;
      cursor: pointer;
    }

    /* æ·»åŠ æ»‘å—ä¸¤ç«¯çš„çº¿æ¡ */
    .color-slider::before,
    .color-slider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 20px;
      height: 2px;
      background: #000;
    }

    .color-slider::before {
      left: -20px;
    }

    .color-slider::after {
      right: -20px;
    }

    /* æ·»åŠ ç¦ç”¨çŠ¶æ€çš„æ ·å¼ */
    .effect-checkbox[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .effect-item {
      opacity: 0.5; /* åˆå§‹çŠ¶æ€æ˜¾ç¤ºä¸ºåŠé€æ˜ */
      transition: opacity 0.3s ease;
    }

    .effect-item.unlocked {
      opacity: 1; /* è§£é”åæ˜¾ç¤ºä¸ºå®Œå…¨ä¸é€æ˜ */
      cursor: pointer;
    }

    /* æ·»åŠ æœ€å°åŒ–ç›¸å…³çš„æ ·å¼ */
    .minimized-notepad {
      position: fixed;
      left: 20px;
      bottom: 20px;
      cursor: pointer;
      z-index: 9999;
      display: none;
    }

    .notepad-icon {
      width: 64px;
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 5px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: 2px 2px 0 #000;
    }

    .icon-image {
      font-size: 32px;
      display: inline-block;
      margin-bottom: 5px;
    }

    .icon-text {
      font-family: monospace;
      font-size: 12px;
      text-align: center;
    }

    /* ä¿®æ”¹æœ€å°åŒ–æŒ‰é’®æ ·å¼ */
    .title-button.minimize {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
    }

    .title-button.minimize.active {
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
    }

    .minimized-icon {
      position: fixed;
      left: 50%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-size: 48px;
      cursor: move;
      z-index: 9999;
      margin: 0;
      padding: 0;
      pointer-events: auto;
      user-select: none;
      text-align: center;
    }

    .icon-label {
      font-family: monospace;
      font-size: 14px;
      margin-top: 5px;
      color: #000;
      white-space: nowrap;
      text-align: center;
    }

    /* æ‹–åŠ¨æ—¶çš„æ ·å¼ */
    .minimized-icon.dragging {
      opacity: 0.7;
    }

    /* æ·»åŠ é‡å¤æç¤ºçš„æ ·å¼ */
    .repeat-text {
      position: fixed;
      left: 25%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .again-text {
      position: fixed;
      right: 25%;
      top: 50vh;
      transform: translate(50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .repeat-text.show,
    .again-text.show {
      opacity: 1;
      visibility: visible;
    }

    /* æ·»åŠ ç‚¼é‡‘æœ¯è§£é”æç¤ºçš„æ ·å¼ */
    .portal-text {
        position: absolute;
      left: 17%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .portal-emoji {
        position: absolute;
      right: 17%;
      top: 50vh;
      transform: translate(50%, -50%);
      font-size: 48px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .portal-emoji:hover {
      transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      animation: wiggle 0.5s infinite alternate;
    }

    .portal-text.show,
    .portal-emoji.show {
      opacity: 1;
      visibility: visible;
    }

    /* æ·»åŠ  portal Setup å­èœå•æ ·å¼ */
    .portal-submenu {
      position: fixed;
      top: 0;
      right: 0;
      background: white;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      display: none;
      z-index: 1998;
    }

    .mode-option {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #000;
      cursor: pointer;
    }

    .mode-option .checkbox {
      font-family: monospace;
      user-select: none;
    }

    .mode-option.checked .checkbox {
      content: '[*]';
    }

    /* æ·»åŠ  placeholder æ ·å¼ */
    .notepad-content[data-placeholder]:empty:before {
      content: attr(data-placeholder);
      color: #999;
      font-style: italic;
    }

    /* ä¿®æ”¹å›¾ç‰‡æ ·å¼ */
    .notepad-content img {
      max-width: 100%;
      height: auto;
      cursor: pointer;
      transition: transform 0.2s ease;
      pointer-events: auto;  /* ç¡®ä¿å›¾ç‰‡å¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
    }

    .notepad-content img:hover {
      transform: scale(1.02);
    }

    /* ä¿®æ”¹å­—ç¬¦ç½‘æ ¼æ ·å¼ */
    .character-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: monospace;
      font-size: 16px;
      line-height: 1;
      white-space: pre;
      cursor: text;
      z-index: 0;
      background: transparent;
      pointer-events: auto;
      user-select: none;
    }

    .grid-cell {
      position: absolute;
      width: 8px;  /* ä» 16px æ”¹ä¸º 8px */
      height: 8px; /* ä» 16px æ”¹ä¸º 8px */
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      box-sizing: border-box;
      pointer-events: auto;
      border: none;
      color: #000;
      text-shadow: 0 0 1px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
      font-size: 8px;  /* æ·»åŠ å­—ä½“å¤§å°è®¾ç½® */
      line-height: 1;  /* ç¡®ä¿æ–‡å­—å‚ç›´å±…ä¸­ */
    }

    .grid-cell.active {
      background: rgba(0, 0, 255, 0.1) !important;
      border: 1px solid rgba(0, 0, 255, 0.3);
    }

    .grid-cell:not(:empty) {
      background: rgba(255, 255, 255, 0.1);
    }

    /* ç¡®ä¿å…¶ä»–UIå…ƒç´ åœ¨ç½‘æ ¼ä¹‹ä¸Šä½†ä¸é˜»æŒ¡ç‚¹å‡» */
    .initial-state {
      pointer-events: none;
    }

    .initial-state > * {
      pointer-events: auto;
    }

    .journey-stage-1 {
      pointer-events: none;
    }

    .feather-outline,
    .unlock-emoji,
    .unlock-text,
    .effects-menu,
    .color-submenu,
    .portal-submenu,
    .start-button,
    .skip-link,
    .minimized-icon {
      pointer-events: auto;
    }

    /* ä¿®æ”¹ Alchemy Furnace æ ·å¼ */
    .alchemy-furnace {
      position: fixed;
      background: #fff;
      border: 2px solid;
      border-color: #dfdfdf #808080 #808080 #dfdfdf;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      overflow: hidden;
      width: 400px;
      height: 300px;
      min-width: 50px;  /* å‡å°æœ€å°å®½åº¦ */
      min-height: 50px; /* å‡å°æœ€å°é«˜åº¦ */
      z-index: 1001;
      position: relative;
    }

    /* ç§»é™¤ä¹‹å‰çš„ ::after æ ·å¼ */
    .alchemy-furnace::after {
      content: none;
    }

    /* æ·»åŠ å’Œ Portal ç›¸åŒçš„è°ƒæ•´å¤§å°æŒ‡ç¤ºå™¨æ ·å¼ */
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: transparent;
      z-index: 1002;
    }

    .resize-handle.bottom-right {
      right: 0;
      bottom: 0;
      cursor: se-resize;
    }

    .alchemy-title {
      background: #000080;
      color: white;
      padding: 3px 5px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .alchemy-content {
      flex: 1;
      padding: 0;
      margin: 0;
      background: #ffffff;
      display: flex;
      flex-direction: column;  /* ç¡®ä¿å†…å®¹å‚ç›´æ’åˆ— */
      overflow: hidden;
      position: relative;
    }

    .alchemy-content img {
      width: 100%;
      height: 100%;
      object-fit: cover;  /* æ”¹ä¸º cover ç¡®ä¿å›¾ç‰‡å¡«å……æ•´ä¸ªå®¹å™¨ */
      margin: 0;
      padding: 0;
      display: block;
    }

    /* ä¿®æ”¹ Portal ä¸­å›¾ç‰‡çš„æ ·å¼ */
    .notepad-content img {
      max-width: 100%;
      height: auto;
      cursor: pointer;
      transition: transform 0.2s ease;
      pointer-events: auto;  /* ç¡®ä¿å›¾ç‰‡å¯ä»¥æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
    }

    .notepad-content img:hover {
      transform: scale(1.02);
    }

    /* æ·»åŠ  Content-Aware Scale åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    .scale-mode-toggle {
      position: absolute;
      right: 25px;
      top: 3px;
      font-size: 12px;
      color: white;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
    }

    .scale-mode-toggle .checkbox {
      margin-right: 5px;
      font-family: monospace;
    }

    .apply-button {
      background: #c0c0c0;
      border: 1px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      color: #000;
      padding: 1px 8px;
      margin-right: 10px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .apply-button .checkbox {
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="initial-state">
    <div class="hello">Hello, world!</div>
    <button class="start-button" onclick="startJourney()">Start</button>
    <a href="#" class="skip-link" onclick="skipToNest()">Skip to nest</a>
  </div>

  <!-- éšè—çš„å†…å®¹ï¼Œç­‰å¾…è§£é” -->
  <div id="journey-content" class="hidden">
    <div class="journey-stage-1">
      <div class="unlock-emoji">ğŸ</div>
      <div class="unlock-text">Colors unlocked</div>
      <div class="feather-outline">
        <div class="notepad-title">
          <span>Portal</span>
          <div class="notepad-title-buttons">
            <button class="title-button minimize">_</button>
            <button class="title-button maximize">â–¡</button>
            <button class="title-button close">Ã—</button>
          </div>
        </div>
        <div class="notepad-content" id="dropZone" contenteditable="true" spellcheck="false"></div>
      </div>
    </div>
  </div>

  <div id="nest-generator" class="hidden">
    <!-- æœ€ç»ˆçš„ç”Ÿæˆå™¨å·¥å…· -->
  </div>

  <!-- ä¿®æ”¹èœå•HTMLç»“æ„ -->
  <div class="star-button">*</div>
  <div class="effects-menu">
    <div class="menu-title">Nest Displacement</div>
    <div class="menu-section">
      <div class="section-title">/EFFECTS</div>
      <div class="effects-list">
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">COLOR</span>
        </div>
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">SLICE TOOL</span>
        </div>
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">PORTAL SETUP</span>
        </div>
      </div>
    </div>
  </div>

  <!-- æ·»åŠ é¢œè‰²æ§åˆ¶å­èœå• -->
  <div class="color-submenu">
    <div class="slider-group">
      <div class="slider-label">HUE</div>
      <input type="range" class="color-slider" id="hueSlider" min="0" max="360" value="180">
    </div>
    <div class="slider-group">
      <div class="slider-label">BRIGHTNESS</div>
      <input type="range" class="color-slider" id="brightnessSlider" min="0" max="100" value="50">
    </div>
    <div class="slider-group">
      <div class="slider-label">SATURATION</div>
      <input type="range" class="color-slider" id="saturationSlider" min="0" max="100" value="50">
    </div>
  </div>

  <!-- æ·»åŠ  portal Setup å­èœå• -->
  <div class="portal-submenu">
    <div class="mode-option checked" data-mode="bird">
      <span class="checkbox">[*]</span>
      <span class="mode-name">Bird Mode</span>
    </div>
    <div class="mode-option" data-mode="free">
      <span class="checkbox">[ ]</span>
      <span class="mode-name">Free Mode</span>
    </div>
    <div class="mode-option" data-mode="hack">
      <span class="checkbox">[ ]</span>
      <span class="mode-name">Hack Mode</span>
    </div>
  </div>

  <!-- åœ¨ body ä¸­æ·»åŠ æœ€å°åŒ–åçš„å›¾æ ‡å®¹å™¨ -->
  <div class="minimized-notepad">
    <div class="notepad-icon">
      <span class="icon-image">ğŸ“</span>
      <span class="icon-text">Portal</span>
    </div>
  </div>

  <div class="minimized-icon" style="display: none;">
    ğŸ—’ï¸
    <div class="icon-label">Portal</div>
  </div>

  <!-- æ·»åŠ é‡å¤æç¤ºçš„HTML -->
  <div class="repeat-text">Repeat</div>
  <div class="again-text">Again</div>

  <!-- æ·»åŠ ç‚¼é‡‘æœ¯è§£é”æç¤ºçš„HTML -->
  <div class="portal-text">portal Setup Unlocked</div>
  <div class="portal-emoji">ğŸ</div>

  <!-- æ·»åŠ  Alchemy Furnace HTML -->
  <div class="alchemy-furnace">
    <div class="alchemy-title">
      <span>Alchemy Furnace</span>
      <div style="display: flex; align-items: center;">
        <button class="apply-button">
          <span class="checkbox">[ ]</span>
          <span>Apply</span>
        </button>
        <div class="notepad-title-buttons">
          <button class="title-button minimize">_</button>
          <button class="title-button maximize">â–¡</button>
          <button class="title-button close">Ã—</button>
        </div>
      </div>
    </div>
    <div class="alchemy-content"></div>
  </div>

  <script>
    // æ·»åŠ  SeamCarver åŠ è½½æ£€æŸ¥
    let seamCarverLoaded = false;
    document.addEventListener('DOMContentLoaded', () => {
      // æ£€æŸ¥ SeamCarver æ˜¯å¦å·²åŠ è½½
      if (typeof window.SeamCarver === 'undefined') {
        console.log('Waiting for SeamCarver to load...');
        const checkSeamCarver = setInterval(() => {
          if (typeof window.SeamCarver !== 'undefined') {
            console.log('SeamCarver loaded successfully!');
            seamCarverLoaded = true;
            clearInterval(checkSeamCarver);
          }
        }, 100);
      } else {
        console.log('SeamCarver already loaded!');
        seamCarverLoaded = true;
      }
    });

    // æ·»åŠ æ–‡æœ¬æ•°ç»„
    const textSequence = [
      "Pet lovebirds often use their beaks to carefully cut pieces of paper and tuck them into their tail feathers.",
      "Despite being born and raised in artificial environments, they retain their instinctual drive as animals to collect diverse materials for nesting.",
      "Consequently, it's common to observe domestic lovebirds decorating themselves with objects produced by human society,",
      "resulting in a quirky yet fascinating sight. Inspired by this behavior,",
      "I've coined a new artistic term, Nest Displacement, to describe instinct-driven creative behaviors within artificial contexts, encompassing adaptation and mutation,",
      "or how individuals seek new possibilities within predefined structures.",
      "Another term, Nest-Grafting, combining the concepts of 'embedding' and 'nesting,'",
      "refers to an individual's appropriation and transformation of surrounding materials, describing artistic actions that incorporate heterogeneous elements into one's own system."
    ];

    let currentTextIndex = 0;
    let isColorUnlocked = false; // æ·»åŠ ä¸€ä¸ªçŠ¶æ€æ ‡è®°
    let isMenuUnlocked = false;

    // æ·»åŠ é¸Ÿç±»åç§°æ•°ç»„
    const birds = [
      'Rainbow_lorikeet',
      'Budgerigar',
      'Cockatiel',
      'Agapornis',  // æ›´æ”¹ä¸ºå­¦å
      'African_grey_parrot',
      'Galah',
      'Monk_parakeet',
      'Cockatoo',
      'Sun_conure',
      'Pacific_parrotlet'
    ];

    // æ·»åŠ æ¨¡å¼ç®¡ç†å˜é‡
    let currentMode = 'bird';
    let pendingMode = 'bird';
    let lastWord = '';
    let searchTimeout = null;

    function startJourney() {
      document.querySelector('.initial-state').style.display = 'none';
      const journeyContent = document.getElementById('journey-content');
      journeyContent.classList.remove('hidden');
      
      // æ˜¾ç¤ºæ˜Ÿå·æŒ‰é’®ï¼Œç¡®ä¿æ˜¯é»‘è‰²
      const starButton = document.querySelector('.star-button');
      starButton.style.display = 'block';
      starButton.style.color = '#000';
      
      setTimeout(() => {
        const stage1 = document.querySelector('.journey-stage-1');
        stage1.style.opacity = '1';
        
        // ç¡®ä¿è®°äº‹æœ¬å’Œå…¶ä»–UIå…ƒç´ å¯ä»¥æ­£å¸¸äº¤äº’
        const notepad = document.querySelector('.feather-outline');
        notepad.style.pointerEvents = 'auto';
        
        initDragAndDrop();
        initNotepad();
        showNextText();
      }, 100);
    }

    function skipToNest() {
      // éšè—åˆå§‹ç•Œé¢
      document.querySelector('.initial-state').style.display = 'none';
      const nestGenerator = document.getElementById('nest-generator');
      nestGenerator.classList.remove('hidden');
      
      // ç§»é™¤é»‘ç™½æ»¤é•œ
      document.body.style.filter = 'grayscale(0%)';
      document.body.style.backgroundColor = getRandomPastelColor();
      
      // æ˜¾ç¤ºå¹¶è§£é”æ˜Ÿå·æŒ‰é’®
      const starButton = document.querySelector('.star-button');
      starButton.style.display = 'block';
      starButton.classList.add('unlocked');
      isMenuUnlocked = true;
      isColorUnlocked = true;
      
      // éšè—æ‰€æœ‰è§£é”æç¤º
      const unlockEmoji = document.querySelector('.unlock-emoji');
      const unlockText = document.querySelector('.unlock-text');
      const portalText = document.querySelector('.portal-text');
      const portalEmoji = document.querySelector('.portal-emoji');
      const repeatText = document.querySelector('.repeat-text');
      const againText = document.querySelector('.again-text');
      
      [unlockEmoji, unlockText, portalText, portalEmoji, repeatText, againText].forEach(element => {
        if (element) {
          element.style.display = 'none';
          element.classList.remove('show');
        }
      });
      
      // è§£é”æ‰€æœ‰æ•ˆæœé€‰é¡¹
      const effectItems = document.querySelectorAll('.effect-item');
      effectItems.forEach(item => {
        item.classList.add('unlocked');
        const checkbox = item.querySelector('.checkbox');
        if (checkbox) checkbox.disabled = false;
      });
      
      // æ¿€æ´»æœ€å°åŒ–æŒ‰é’®
      const minimizeButton = document.querySelector('.title-button.minimize');
      minimizeButton.classList.add('active');
      
      // åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
      initDragAndDrop();
      initNotepad();
      
      // æ˜¾ç¤ºè®°äº‹æœ¬
      const journeyContent = document.getElementById('journey-content');
      journeyContent.classList.remove('hidden');
      const stage1 = document.querySelector('.journey-stage-1');
      stage1.style.opacity = '1';
      
      // è®¾ç½®æ‰€æœ‰çŠ¶æ€ä¸ºå·²å®Œæˆ
      portalUnlocked = true;
      interactionCount = 4;
      isFirstRestore = false;  // é˜²æ­¢ Repeat/Again æç¤ºæ˜¾ç¤º
      portalShown = true;      // é˜²æ­¢ Portal Setup æç¤ºæ˜¾ç¤º
      
      // ç§»é™¤ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
      const minimizedIcon = document.querySelector('.minimized-icon');
      if (minimizedIcon) {
        minimizedIcon.removeEventListener('dblclick', showRepeatText);
      }
      if (portalEmoji) {
        portalEmoji.removeEventListener('click', unlockportalSetup);
      }
    }

    function initDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      const notepad = document.querySelector('.feather-outline');
      const titleBar = document.querySelector('.notepad-title');
      
      // é˜²æ­¢è®°äº‹æœ¬çª—å£å’Œæ ‡é¢˜æ æ¥æ”¶æ‹–æ”¾
      notepad.addEventListener('dragover', (e) => {
        if (e.target !== dropZone && !dropZone.contains(e.target)) {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      // ç‰¹åˆ«å¤„ç†æ ‡é¢˜æ çš„æ‹–æ”¾
      titleBar.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      titleBar.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      // åªå…è®¸å†…å®¹åŒºåŸŸæ¥æ”¶æ‹–æ”¾
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#f0f0f0';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = '#ffffff';
      });

      dropZone.addEventListener('drop', handleDrop);
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // ç¡®ä¿åªæœ‰å†…å®¹åŒºåŸŸå¯ä»¥æ¥æ”¶æ‹–æ”¾
      const dropZone = document.getElementById('dropZone');
      if (e.target !== dropZone && !dropZone.contains(e.target)) {
        return;
      }

      dropZone.style.backgroundColor = '#ffffff';

      // è·å–æ‹–åŠ¨çš„æ–‡æœ¬
      const text = e.dataTransfer.getData('text/plain');
      
      // è·å–å½“å‰å…‰æ ‡ä½ç½®æˆ–æœ«å°¾
      const selection = window.getSelection();
      let range;
      
      if (selection.rangeCount > 0) {
        range = selection.getRangeAt(0);
      } else {
        range = document.createRange();
        range.selectNodeContents(dropZone);
        range.collapse(false);
      }

      // åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬
      const textNode = document.createTextNode(
        (dropZone.textContent ? '\n\n' : '') + text
      );
      range.insertNode(textNode);

      // ç§»åŠ¨å…‰æ ‡åˆ°æ’å…¥æ–‡æœ¬çš„æœ«å°¾
      range.setStartAfter(textNode);
      range.setEndAfter(textNode);
      selection.removeAllRanges();
      selection.addRange(range);

      // ç§»é™¤åŸå§‹æ‹–åŠ¨çš„æ–‡æœ¬
      const draggedText = document.querySelector('.text-fragment');
      if (draggedText && draggedText.textContent === text) {
      draggedText.remove();
      }

      // æ˜¾ç¤ºä¸‹ä¸€æ®µæ–‡æœ¬
      currentTextIndex++;
      showNextText();

      // ä¿æŒç„¦ç‚¹
      dropZone.focus();
    }

    function showNextText() {
      if (currentTextIndex >= textSequence.length) {
        // è§£é”èœå•
        const starButton = document.querySelector('.star-button');
        starButton.classList.add('unlocked');
        
        // è§£é” COLOR é€‰é¡¹
        isColorUnlocked = true;
        const colorEffect = document.querySelector('.effect-item');
        colorEffect.classList.add('unlocked');
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.disabled = false;
        
        showUnlockEffects();
        startStage2();
        return;
      }

      const fragment = document.createElement('div');
      fragment.className = 'text-fragment';
      fragment.textContent = textSequence[currentTextIndex];
      fragment.draggable = true;
      
      // éšæœºä½ç½®
      const randomPosition = getRandomPosition();
      fragment.style.left = randomPosition.x + 'px';
      fragment.style.top = randomPosition.y + 'px';

      document.querySelector('.journey-stage-1').appendChild(fragment);

      // æ·»åŠ æ‹–æ‹½äº‹ä»¶
      fragment.addEventListener('dragstart', (e) => {
        e.stopPropagation();
        e.dataTransfer.setData('text/plain', fragment.textContent);
        e.target.style.opacity = '0.5';
      });

      fragment.addEventListener('dragend', (e) => {
        e.stopPropagation();
        e.target.style.opacity = '1';
      });

      fragment.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      setTimeout(() => fragment.classList.add('visible'), 100);
    }

    function getRandomPosition() {
      const padding = 50;
      const maxWidth = window.innerWidth - 400;
      const maxHeight = window.innerHeight - 100;
      
      // é¿å…ç”Ÿæˆåœ¨ä¸­å¤®åŒºåŸŸ
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      let x, y;
      
      do {
        x = padding + Math.random() * (maxWidth - padding * 2);
      } while (Math.abs(x - centerX) < 300);
      
      do {
        y = padding + Math.random() * (maxHeight - padding * 2);
      } while (Math.abs(y - centerY) < 200);

      return { x, y };
    }

    function startStage2() {
      document.body.classList.add('stage-1');
      // ä¸å†è‡ªåŠ¨ç§»é™¤æ»¤é•œï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç¤¼ç‰©
    }

    function activateAllFeatures() {
      // æ¿€æ´»æ‰€æœ‰é«˜çº§åŠŸèƒ½
      document.body.classList.add('stage-1', 'stage-2', 'stage-3');
      // åˆå§‹åŒ–ç”Ÿæˆå™¨å·¥å…·
      initNestGenerator();
      initDragAndDrop();
    }

    function initNestGenerator() {
      // è¿™é‡Œå°†å®ç°æœ€ç»ˆçš„ç”Ÿæˆå™¨å·¥å…·åŠŸèƒ½
    }

    // æ·»åŠ è®°äº‹æœ¬åˆå§‹åŒ–å‡½æ•°
    function initNotepad() {
      const dropZone = document.getElementById('dropZone');
      
      // è‡ªåŠ¨èšç„¦
      dropZone.focus();

      // æ·»åŠ å¿«æ·é”®æ”¯æŒ
      dropZone.addEventListener('keydown', (e) => {
        // Tabé”®æ”¯æŒ
        if (e.key === 'Tab') {
          e.preventDefault();
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          const tabNode = document.createTextNode('    '); // 4ä¸ªç©ºæ ¼
          range.insertNode(tabNode);
          range.setStartAfter(tabNode);
          range.setEndAfter(tabNode);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        
        // åœ¨ Free Mode ä¸‹å¤„ç†å›è½¦é”®
        if (currentMode === 'free' && e.key === 'Enter') {
          e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
          
          // è·å–å½“å‰è¾“å…¥çš„æ–‡æœ¬
          const text = dropZone.textContent.trim();
          console.log('Enter pressed, text:', text); // æ·»åŠ æ—¥å¿—
          
          // å¦‚æœæ–‡æœ¬ä¸ä¸ºç©ºï¼Œæ‰§è¡Œæœç´¢
          if (text) {
            // è·å–æœ€åä¸€ä¸ªå•è¯
            const words = text.split(/\s+/);
            lastWord = words[words.length - 1].toLowerCase();
            console.log('Searching for word:', lastWord); // æ·»åŠ æ—¥å¿—
            
            // æ‰§è¡Œæœç´¢
            loadBirdImage();
          }
        }
      });

      // å¤„ç†è¾“å…¥äº‹ä»¶
      dropZone.addEventListener('input', (e) => {
        if (currentMode === 'free') {
          // è·å–å½“å‰è¾“å…¥çš„æ–‡æœ¬
          const text = dropZone.textContent.trim();
          
          // å¦‚æœæ–‡æœ¬ä¸ºç©ºï¼Œæ˜¾ç¤º placeholder
          if (!text) {
            dropZone.setAttribute('data-placeholder', 'Type any English word to search for related images');
          } else {
            dropZone.removeAttribute('data-placeholder');
          }
        }
      });
    }

    // æ·»åŠ éšæœºé¢œè‰²ç”Ÿæˆå‡½æ•°
    function getRandomPastelColor() {
      // ç”ŸæˆæŸ”å’Œçš„é¢œè‰²
      const hue = Math.floor(Math.random() * 360); // éšæœºè‰²ç›¸
      const saturation = 30 + Math.random() * 20; // 30-50%çš„é¥±å’Œåº¦
      const lightness = 85 + Math.random() * 10; // 85-95%çš„äº®åº¦
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    // ä¿®æ”¹ showUnlockEffects å‡½æ•°
    function showUnlockEffects() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      const notepad = document.querySelector('.feather-outline');
      
      // è·å–è®°äº‹æœ¬çš„ä½ç½®ä¿¡æ¯
      const notepadRect = notepad.getBoundingClientRect();
      const windowWidth = window.innerWidth;
      
      // è®¡ç®—å·¦å³åŒºåŸŸçš„ä¸­ç‚¹
      const leftAreaCenter = notepadRect.left / 2;
      const rightAreaCenter = (windowWidth - notepadRect.right) / 2 + notepadRect.right;
      
      // è®¾ç½®æ–‡å­—å’Œemojiçš„ä½ç½®
      text.style.left = `${leftAreaCenter}px`;
      emoji.style.right = `${windowWidth - rightAreaCenter}px`;
      
      // æ˜¾ç¤ºå…ƒç´ 
      text.classList.add('show');
      emoji.classList.add('show');

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶
      emoji.addEventListener('click', unlockColors);
    }

    // ä¿®æ”¹ unlockColors å‡½æ•°
    function unlockColors() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      
      // ç§»é™¤é»‘ç™½æ»¤é•œ
      document.body.style.transition = 'filter 1s ease, background-color 1s ease';
      document.body.style.filter = 'grayscale(0%)';
      
      // è®¾ç½®éšæœºèƒŒæ™¯è‰²
      document.body.style.backgroundColor = getRandomPastelColor();
      
      // ç§»é™¤æç¤ºå…ƒç´ 
      emoji.style.visibility = 'hidden';
      text.style.visibility = 'hidden';
      
      // è§£é”èœå•
      isMenuUnlocked = true;
      const starButton = document.querySelector('.star-button');
      starButton.classList.add('unlocked');
      
      // è§£é” COLOR é€‰é¡¹
      isColorUnlocked = true;
      const colorEffect = document.querySelector('.effect-item');
      colorEffect.classList.add('unlocked');
      const checkbox = colorEffect.querySelector('.checkbox');
      checkbox.disabled = false;
      
      // æ¿€æ´»æœ€å°åŒ–æŒ‰é’®
      const minimizeButton = document.querySelector('.title-button.minimize');
      minimizeButton.classList.add('active');
      
      // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤è§¦å‘
      emoji.removeEventListener('click', unlockColors);
    }

    // æ·»åŠ ä½ç½®æ£€æŸ¥å’Œè°ƒæ•´å‡½æ•°
    function adjustSubmenuPosition() {
      const submenu = document.querySelector('.color-submenu');
      if (!submenu || submenu.style.display === 'none') return;

      const rect = submenu.getBoundingClientRect();
      const windowHeight = window.innerHeight;

      // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè§†çª—åº•éƒ¨
      if (rect.bottom > windowHeight) {
        // è°ƒæ•´ä½ç½®ï¼Œç¡®ä¿åœ¨è§†çª—å†…
        submenu.style.top = 'auto';
        submenu.style.bottom = '20px';
        submenu.style.transform = 'none';
      }
    }

    // ä¿®æ”¹é¢œè‰²æ§åˆ¶é€»è¾‘
    function initializeColorControl() {
      const colorEffect = document.querySelector('.effect-item');
      const colorSubmenu = document.querySelector('.color-submenu');
      const portalEffect = document.querySelector('.effect-item:nth-child(3)');
      const portalSubmenu = document.querySelector('.portal-submenu');
      const modeOptions = document.querySelectorAll('.mode-option');
      const hueSlider = document.getElementById('hueSlider');
      const brightnessSlider = document.getElementById('brightnessSlider');
      const saturationSlider = document.getElementById('saturationSlider');
      let isColorChecked = false;
      let isportalChecked = false;

      // åˆå§‹åŒ–æ¨¡å¼é€‰é¡¹çš„ç‚¹å‡»äº‹ä»¶
      modeOptions.forEach(option => {
        option.addEventListener('click', () => {
          const mode = option.dataset.mode;
          if (mode === currentMode) return; // å¦‚æœç‚¹å‡»å½“å‰æ¨¡å¼ï¼Œä¸åšä»»ä½•äº‹

          // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
          modeOptions.forEach(opt => {
            const checkbox = opt.querySelector('.checkbox');
            if (opt.dataset.mode === mode) {
              checkbox.textContent = '[*]';
              opt.classList.add('checked');
            } else {
              checkbox.textContent = '[ ]';
              opt.classList.remove('checked');
            }
          });

          // è®¾ç½®å¾…åˆ‡æ¢çš„æ¨¡å¼
          pendingMode = mode;
        });
      });

      // ç‚¹å‡» COLOR é€‰é¡¹çš„å¤„ç†
      colorEffect.addEventListener('click', (e) => {
        if (!colorEffect.classList.contains('unlocked')) return;

        isColorChecked = !isColorChecked;
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.textContent = isColorChecked ? '[*]' : '[ ]';
        colorEffect.classList.toggle('checked');
        colorSubmenu.style.display = isColorChecked ? 'block' : 'none';
        
        // å¦‚æœ portal èœå•æ‰“å¼€ï¼Œåˆ™å…³é—­å®ƒ
        if (isColorChecked && isportalChecked) {
          isportalChecked = false;
          const portalCheckbox = portalEffect.querySelector('.checkbox');
          portalCheckbox.textContent = '[ ]';
          portalEffect.classList.remove('checked');
          portalSubmenu.style.display = 'none';
        }
      });

      // ç‚¹å‡» portal SETUP é€‰é¡¹çš„å¤„ç†
      portalEffect.addEventListener('click', (e) => {
        if (!portalEffect.classList.contains('unlocked')) return;

        isportalChecked = !isportalChecked;
        const checkbox = portalEffect.querySelector('.checkbox');
        checkbox.textContent = isportalChecked ? '[*]' : '[ ]';
        portalEffect.classList.toggle('checked');
        portalSubmenu.style.display = isportalChecked ? 'block' : 'none';
        
        // å¦‚æœ Color èœå•æ‰“å¼€ï¼Œåˆ™å…³é—­å®ƒ
        if (isportalChecked && isColorChecked) {
          isColorChecked = false;
          const colorCheckbox = colorEffect.querySelector('.checkbox');
          colorCheckbox.textContent = '[ ]';
          colorEffect.classList.remove('checked');
          colorSubmenu.style.display = 'none';
        }
      });

      // æ»‘å—æ§åˆ¶é¢œè‰²
      function updateColor() {
        const hue = hueSlider.value;
        const brightness = brightnessSlider.value;
        const saturation = saturationSlider.value;
        
        document.body.style.backgroundColor = 
          `hsl(${hue}, ${saturation}%, ${brightness}%)`;
      }

      // æ·»åŠ æ»‘å—äº‹ä»¶ç›‘å¬
      hueSlider.addEventListener('input', updateColor);
      brightnessSlider.addEventListener('input', updateColor);
      saturationSlider.addEventListener('input', updateColor);
    }

    // ä¿®æ”¹æ˜Ÿå·æŒ‰é’®çš„åˆå§‹åŒ–
    function initializeMenu() {
      const starButton = document.querySelector('.star-button');
      const menu = document.querySelector('.effects-menu');
      let isMenuOpen = false;

      starButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!isMenuUnlocked) return;

        isMenuOpen = !isMenuOpen;
        menu.style.display = isMenuOpen ? 'block' : 'none';
      });

      document.addEventListener('click', (e) => {
        if (isMenuOpen && !menu.contains(e.target)) {
          isMenuOpen = false;
          menu.style.display = 'none';
        }
      });

      initializeColorControl();
    }

    // æ·»åŠ çª—å£å¤§å°æ”¹å˜æ—¶çš„ä½ç½®è°ƒæ•´
    window.addEventListener('resize', adjustSubmenuPosition);

    // æ·»åŠ æœ€å°åŒ–åŠŸèƒ½ç›¸å…³çš„ä»£ç 
    function initializeMinimize() {
      const minimizeButton = document.querySelector('.title-button');
      const notepad = document.querySelector('.feather-outline');
      const minimizedIcon = document.querySelector('.minimized-icon');
      const dropZone = document.getElementById('dropZone');
      const repeatText = document.querySelector('.repeat-text');
      const againText = document.querySelector('.again-text');
      const portalText = document.querySelector('.portal-text');
      const portalEmoji = document.querySelector('.portal-emoji');
      let isFirstRestore = true;
      let interactionCount = 0;
      let portalUnlocked = false;
      let portalShown = false;
      
      // åˆå§‹çŠ¶æ€è®¾ç½®ä¸ºç¦ç”¨
      minimizeButton.classList.add('minimize');

      // åœ¨è§£é”é¢œè‰²æ—¶æ¿€æ´»æœ€å°åŒ–æŒ‰é’®
      function activateMinimizeButton() {
        minimizeButton.classList.add('active');
      }

      // è·å–éšæœºé¸Ÿç±»å›¾ç‰‡
      async function getRandomBirdImage() {
        const randomBird = birds[Math.floor(Math.random() * birds.length)];
        try {
          // ä½¿ç”¨æ›´å¯é çš„ REST API ç«¯ç‚¹ï¼Œæ·»åŠ æ›´å¤§çš„å›¾ç‰‡å°ºå¯¸
          const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${randomBird}`;
          
          console.log('Fetching image for:', randomBird); // è°ƒè¯•æ—¥å¿—
          const response = await fetch(url);
          if (!response.ok) throw new Error('Network response was not ok');
          
          const data = await response.json();
          console.log('API response:', data); // è°ƒè¯•æ—¥å¿—
          
          // å¦‚æœæ²¡æœ‰ç¼©ç•¥å›¾ï¼Œå°è¯•è·å–åŸå§‹å›¾ç‰‡
          if (!data.originalimage && (!data.thumbnail || !data.thumbnail.source)) {
            throw new Error('No image found');
          }
          
          // ä¼˜å…ˆä½¿ç”¨åŸå§‹å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ç¼©ç•¥å›¾
          const imageUrl = data.originalimage ? data.originalimage.source : data.thumbnail.source;
          
          // é¢„åŠ è½½å›¾ç‰‡
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(imageUrl);
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = imageUrl;
          });
        } catch (error) {
          console.error('Error fetching bird image:', error);
          return null;
        }
      }

      // æ˜¾ç¤ºé‡å¤æç¤º
      function showRepeatText() {
        // ç¡®ä¿å…ƒç´ å¯è§
        repeatText.style.display = 'block';
        againText.style.display = 'block';
        
        // æ·»åŠ showç±»è§¦å‘è¿‡æ¸¡æ•ˆæœ
        setTimeout(() => {
          repeatText.classList.add('show');
          againText.classList.add('show');
        }, 50);
      }

      // éšè—é‡å¤æç¤º
      function hideRepeatText() {
        repeatText.classList.remove('show');
        againText.classList.remove('show');
        
        // ç­‰å¾…è¿‡æ¸¡æ•ˆæœå®Œæˆåéšè—å…ƒç´ 
        setTimeout(() => {
          repeatText.style.display = 'none';
          againText.style.display = 'none';
        }, 500);
      }

      // æ˜¾ç¤ºç‚¼é‡‘æœ¯è§£é”æç¤º
      function showportalUnlock() {
        if (!portalShown) {
          // ç¡®ä¿å…ƒç´ å¯è§
          portalText.style.display = 'block';
          portalEmoji.style.display = 'block';
          
          // æ·»åŠ showç±»è§¦å‘è¿‡æ¸¡æ•ˆæœ
          setTimeout(() => {
            portalText.classList.add('show');
            portalEmoji.classList.add('show');
          }, 50);
          
          portalShown = true;

          // æ·»åŠ ç‚¹å‡»äº‹ä»¶æ¥è§£é” portal SETUP é€‰é¡¹
          portalEmoji.style.pointerEvents = 'auto'; // ç¡®ä¿å¯ä»¥ç‚¹å‡»
          portalEmoji.addEventListener('click', unlockportalSetup);
        }
      }

      // éšè—ç‚¼é‡‘æœ¯è§£é”æç¤º
      function hideportalUnlock() {
        if (portalShown) {
          portalText.classList.remove('show');
          portalEmoji.classList.remove('show');
          
          setTimeout(() => {
            portalText.style.display = 'none';
            portalEmoji.style.display = 'none';
          }, 500);
          
          portalShown = false;
        }
      }

      // ä¿®æ”¹è§£é” portal SETUP çš„å‡½æ•°
      function unlockportalSetup() {
        console.log('Unlocking portal Setup...'); // æ·»åŠ è°ƒè¯•æ—¥å¿—
        
        // è·å–æ‰€æœ‰ effect-item å…ƒç´ 
        const effectItems = document.querySelectorAll('.effect-item');
        // portal SETUP æ˜¯ç¬¬ä¸‰ä¸ªé€‰é¡¹
        const portalEffect = effectItems[2];
        
        if (portalEffect) {
          console.log('Found portal Setup option'); // æ·»åŠ è°ƒè¯•æ—¥å¿—
          
          // è§£é”é€‰é¡¹
          portalEffect.classList.add('unlocked');
          const checkbox = portalEffect.querySelector('.checkbox');
          if (checkbox) {
            checkbox.disabled = false;
          }
          
          // éšè—è§£é”æç¤º
          hideportalUnlock();
          
          // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤è§¦å‘
          portalEmoji.removeEventListener('click', unlockportalSetup);
        } else {
          console.log('portal Setup option not found'); // æ·»åŠ è°ƒè¯•æ—¥å¿—
        }
      }

      // æ£€æŸ¥äº¤äº’æ¬¡æ•°
      function checkInteractions() {
        // åªåœ¨æœ€å°åŒ–æ—¶å¢åŠ è®¡æ•°
        if (notepad.style.display === 'none') {
          interactionCount++;
          console.log('Interaction count:', interactionCount);
          
          if (interactionCount === 3 && !portalUnlocked) {
            portalUnlocked = true;
            showportalUnlock();
          }
          // ç§»é™¤åœ¨ç¬¬å››æ¬¡äº¤äº’æ—¶è‡ªåŠ¨éšè—æç¤ºçš„é€»è¾‘
        }
      }

      // æœ€å°åŒ–åŠ¨ç”»
      function minimizeNotepad() {
        if (!minimizeButton.classList.contains('active')) return;
        notepad.style.display = 'none';
        minimizedIcon.style.display = 'block';
        hideRepeatText();
        checkInteractions();
      }

      // ä¿®æ”¹åŠ è½½å›¾ç‰‡çš„å‡½æ•°
      async function loadBirdImage() {
        console.log('Loading image in mode:', currentMode);
        
        try {
          if (currentMode === 'bird') {
            // Bird Mode çš„é€»è¾‘ä¿æŒä¸å˜
            dropZone.innerHTML = 'Loading image...';
            dropZone.style.padding = '10px';
          const imageUrl = await getRandomBirdImage();
          
          if (imageUrl) {
            dropZone.style.padding = '0';
            dropZone.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
              max-width: 100%;
              height: auto;
              display: block;
              margin: 0 auto;
              object-fit: contain;
            `;
            dropZone.appendChild(img);
            
            if (isFirstRestore) {
              showRepeatText();
              isFirstRestore = false;
            }
            }
          } else if (currentMode === 'free') {
            // Free Mode æ”¹ä¸ºå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
            if (dropZone.querySelector('.upload-container') === null) {
              // æ¸…ç©ºå†…å®¹
              dropZone.innerHTML = '';
              dropZone.style.padding = '20px';
              
              // åˆ›å»ºä¸Šä¼ å®¹å™¨
              const uploadContainer = document.createElement('div');
              uploadContainer.className = 'upload-container';
              uploadContainer.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                width: 100%;
                height: 100%;
                min-height: 200px;
                border: 2px dashed #999;
                border-radius: 5px;
                padding: 20px;
                box-sizing: border-box;
              `;
              
              // æ·»åŠ æç¤ºæ–‡æœ¬
              const uploadText = document.createElement('div');
              uploadText.textContent = 'Drop image here or click to upload';
              uploadText.style.cssText = `
                font-size: 16px;
                color: #666;
                text-align: center;
              `;
              
              // æ·»åŠ æ–‡ä»¶è¾“å…¥æ¡†
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.style.display = 'none';
              
              // æ·»åŠ ä¸Šä¼ æŒ‰é’®
              const uploadButton = document.createElement('button');
              uploadButton.textContent = 'Choose File';
              uploadButton.style.cssText = `
                padding: 8px 16px;
                background: none;
                border: 1px solid #666;
                border-radius: 4px;
                cursor: pointer;
                font-family: monospace;
                transition: all 0.3s ease;
              `;
              
              uploadButton.addEventListener('mouseover', () => {
                uploadButton.style.background = '#000';
                uploadButton.style.color = '#fff';
              });
              
              uploadButton.addEventListener('mouseout', () => {
                uploadButton.style.background = 'none';
                uploadButton.style.color = '#000';
              });
              
              // å¤„ç†æ–‡ä»¶é€‰æ‹©
              fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.cssText = `
                      max-width: 100%;
                      height: auto;
                      display: block;
                      margin: 20px auto;
                      object-fit: contain;
                    `;
                    dropZone.innerHTML = '';
                    dropZone.style.padding = '0';
                    dropZone.appendChild(img);
                  };
                  reader.readAsDataURL(file);
                }
              });
              
              // å¤„ç†æ‹–æ”¾
              uploadContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadContainer.style.borderColor = '#000';
                uploadContainer.style.background = 'rgba(0,0,0,0.05)';
              });
              
              uploadContainer.addEventListener('dragleave', () => {
                uploadContainer.style.borderColor = '#999';
                uploadContainer.style.background = 'none';
              });
              
              uploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadContainer.style.borderColor = '#999';
                uploadContainer.style.background = 'none';
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.cssText = `
                      max-width: 100%;
                      height: auto;
                      display: block;
                      margin: 20px auto;
                      object-fit: contain;
                    `;
                    dropZone.innerHTML = '';
                    dropZone.style.padding = '0';
                    dropZone.appendChild(img);
                  };
                  reader.readAsDataURL(file);
                }
              });
              
              // ç‚¹å‡»æŒ‰é’®è§¦å‘æ–‡ä»¶é€‰æ‹©
              uploadButton.addEventListener('click', () => {
                fileInput.click();
              });
              
              // ç»„è£…ä¸Šä¼ ç•Œé¢
              uploadContainer.appendChild(uploadText);
              uploadContainer.appendChild(uploadButton);
              uploadContainer.appendChild(fileInput);
              dropZone.appendChild(uploadContainer);
            }
          }
        } catch (error) {
          console.error('Error displaying content:', error);
          if (currentMode === 'bird') {
            dropZone.innerHTML = 'Failed to load image';
          dropZone.style.padding = '10px';
          }
        }
      }

      // è¿˜åŸè®°äº‹æœ¬
      async function restoreNotepad() {
        minimizedIcon.style.display = 'none';
        notepad.style.display = 'flex';
        
        // åº”ç”¨å¾…åˆ‡æ¢çš„æ¨¡å¼
        if (pendingMode !== currentMode) {
          currentMode = pendingMode;
          console.log('Mode switched to:', currentMode);
        }
        
        // æ ¹æ®å½“å‰æ¨¡å¼åŠ è½½å†…å®¹
        await loadBirdImage();
      }

      // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
      let isDragging = false;
      let currentX;
      let currentY;
      let initialX;
      let initialY;
      let xOffset = 0;
      let yOffset = 0;

      function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === minimizedIcon) {
          isDragging = true;
          minimizedIcon.classList.add('dragging');
        }
      }

      function dragEnd() {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
        minimizedIcon.classList.remove('dragging');
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;
          xOffset = currentX;
          yOffset = currentY;

          minimizedIcon.style.transform = `translate(${currentX}px, ${currentY}px)`;
        }
      }

      // æ·»åŠ äº‹ä»¶ç›‘å¬
      minimizedIcon.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);
      minimizeButton.addEventListener('click', minimizeNotepad);
      minimizedIcon.addEventListener('dblclick', restoreNotepad);
    }

    // ä¿®æ”¹è·å–ç»´åŸºç™¾ç§‘å›¾ç‰‡çš„å‡½æ•°
    async function getWikiImage(searchTerm) {
      console.log('Searching for:', searchTerm);
      try {
        const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(searchTerm)}`;
        console.log('API URL:', url);
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('No entry found');
        }
        
        const data = await response.json();
        console.log('API response:', data);
        
        if (!data.thumbnail || !data.thumbnail.source) {
          throw new Error('No image found');
        }
        
        // è¿”å›å›¾ç‰‡ URL å’Œæè¿°æ–‡æœ¬
        return {
          imageUrl: data.thumbnail.source,
          title: data.title,
          extract: data.extract
        };
      } catch (error) {
        console.error('Error fetching wiki image:', error);
        return null;
      }
    }

    // ä¿®æ”¹è®°äº‹æœ¬æ‹–æ‹½åŠŸèƒ½çš„è„šæœ¬
    function initNotepadDrag() {
      const notepad = document.querySelector('.feather-outline');
      const titleBar = document.querySelector('.notepad-title');
      let isDragging = false;
      let startX;
      let startY;
      let notepadX;
      let notepadY;

      function dragStart(e) {
        if (e.target.closest('.notepad-title-buttons')) return;
        
        // è·å–è®°äº‹æœ¬å½“å‰ä½ç½®
        const rect = notepad.getBoundingClientRect();
        notepadX = rect.left;
        notepadY = rect.top;
        
        // è·å–é¼ æ ‡èµ·å§‹ä½ç½®
        startX = e.clientX;
        startY = e.clientY;

        if (e.target.closest('.notepad-title')) {
          isDragging = true;
          notepad.classList.add('dragging');
          
          // ç§»é™¤transformï¼Œæ”¹ç”¨topå’Œleftå®šä½
          notepad.style.transform = 'none';
          notepad.style.left = notepadX + 'px';
          notepad.style.top = notepadY + 'px';
        }
      }

      function dragEnd() {
        isDragging = false;
        notepad.classList.remove('dragging');
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          
          // è®¡ç®—ç§»åŠ¨è·ç¦»
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          
          // æ›´æ–°è®°äº‹æœ¬ä½ç½®
          let newX = notepadX + dx;
          let newY = notepadY + dy;
          
          // è·å–è®°äº‹æœ¬å’Œçª—å£å°ºå¯¸
          const rect = notepad.getBoundingClientRect();
          const maxX = window.innerWidth - rect.width;
          const maxY = window.innerHeight - rect.height;
          
          // ç¡®ä¿è®°äº‹æœ¬ä¸ä¼šå®Œå…¨ç§»å‡ºè§†çª—
          newX = Math.max(-rect.width / 2, Math.min(newX, maxX + rect.width / 2));
          newY = Math.max(-rect.height / 2, Math.min(newY, maxY + rect.height / 2));
          
          notepad.style.left = newX + 'px';
          notepad.style.top = newY + 'px';
        }
      }

      titleBar.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);

      // å¤„ç†çª—å£å¤§å°å˜åŒ–
      window.addEventListener('resize', () => {
        const rect = notepad.getBoundingClientRect();
        const maxX = window.innerWidth - rect.width;
        const maxY = window.innerHeight - rect.height;
        
        // å¦‚æœè®°äº‹æœ¬è¶…å‡ºè§†çª—ï¼Œè°ƒæ•´ä½ç½®
        if (rect.right > window.innerWidth || rect.bottom > window.innerHeight) {
          let newX = parseFloat(notepad.style.left);
          let newY = parseFloat(notepad.style.top);
          
          if (rect.right > window.innerWidth) {
            newX = Math.max(0, maxX);
          }
          if (rect.bottom > window.innerHeight) {
            newY = Math.max(0, maxY);
          }
          
          notepad.style.left = newX + 'px';
          notepad.style.top = newY + 'px';
        }
      });
    }

    // ä¿®æ”¹å›¾ç‰‡åŠ è½½å‡½æ•°
    function handleImageLoad(img) {
      const maxWidth = window.innerWidth * 0.8;  // 80% çš„è§†çª—å®½åº¦
      const maxHeight = window.innerHeight * 0.7;  // 70% çš„è§†çª—é«˜åº¦

      const ratio = Math.min(
        maxWidth / img.naturalWidth,
        maxHeight / img.naturalHeight,
        1  // ä¸è¦æ”¾å¤§å›¾ç‰‡
      );

      img.style.width = `${img.naturalWidth * ratio}px`;
      img.style.height = `${img.naturalHeight * ratio}px`;
    }

    // ä¿®æ”¹å­—ç¬¦ç½‘æ ¼ç³»ç»Ÿçš„è„šæœ¬
    class CharacterGrid {
      constructor() {
        this.container = document.createElement('div');
        this.container.className = 'character-grid';
        document.body.appendChild(this.container);
        
        this.cells = new Map();
        this.activeCellPos = null;
        this.cellSize = 8;
        
        this.setupEventListeners();
        this.createInitialGrid();
        
        // åˆå§‹åŒ– Firebase ç›‘å¬
        if (window.firebaseRef) {
          this.initializeFirebase();
        } else {
          console.warn('Waiting for Firebase to initialize...');
          const checkInterval = setInterval(() => {
            if (window.firebaseRef) {
              console.log('Firebase now available, initializing...');
              this.initializeFirebase();
              clearInterval(checkInterval);
            }
          }, 100);
          
          // è®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
          setTimeout(() => {
            clearInterval(checkInterval);
            console.error('Firebase initialization timeout');
          }, 5000);
        }
      }

      initializeFirebase() {
        try {
          console.log('Setting up Firebase listeners...');
          if (!window.firebaseRef) {
            console.error('Firebase reference not available');
            return;
          }

          // ä½¿ç”¨ window.onValue è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ onValue
          window.onValue(window.firebaseRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
              Object.entries(data).forEach(([key, value]) => {
                if (value === null) return; // è·³è¿‡å·²åˆ é™¤çš„èŠ‚ç‚¹
                
                const [x, y] = key.split(',').map(Number);
                const cell = this.getCell(x, y);
                
                if (value.char) cell.textContent = value.char;
                if (value.backgroundColor) cell.style.backgroundColor = value.backgroundColor;
              });
            }
          }, (error) => {
            if (error.code === 'PERMISSION_DENIED') {
              console.error('Firebase permission denied. Please check database rules.');
              alert('Permission denied. Please check Firebase database rules.');
            } else {
              console.error('Firebase onValue error:', error);
            }
          });
        } catch (error) {
          console.error('Error in initializeFirebase:', error);
        }
      }

      async updateCell(x, y, char, backgroundColor, shouldSync = true) {
        try {
          const cell = this.getCell(x, y);
          
          // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
          if (char !== null) cell.textContent = char;
          if (backgroundColor !== null) cell.style.backgroundColor = backgroundColor;
          
          // åŒæ­¥åˆ° Firebase
          if (shouldSync && window.firebaseRef && window.firebaseUpdate) {
            const key = `${x},${y}`;
            const updates = {};
            
            // åªä¿å­˜éç©ºå€¼
            if (char !== null || backgroundColor !== null) {
              updates[key] = {
                char: char || cell.textContent,
                backgroundColor: backgroundColor || cell.style.backgroundColor || 'transparent'
              };
              
              // å¦‚æœæ•°æ®ä¸ºç©ºï¼Œåˆ™åˆ é™¤è¯¥èŠ‚ç‚¹
              if (!updates[key].char && (!updates[key].backgroundColor || updates[key].backgroundColor === 'transparent')) {
                updates[key] = null;
              }
              
              try {
                await window.firebaseUpdate(window.firebaseRef, updates);
                console.log('Cell updated successfully:', key);
              } catch (error) {
                if (error.code === 'PERMISSION_DENIED') {
                  console.error('Firebase permission denied. Please check database rules.');
                  alert('Permission denied. Please check Firebase database rules.');
                } else {
                  console.error('Failed to update Firebase:', error);
                }
              }
            }
          }
        } catch (error) {
          console.error('Error in updateCell:', error);
        }
      }

      // ä¿®æ”¹ setCharacter æ–¹æ³•
      setCharacter(x, y, char) {
        this.updateCell(x, y, char, null, true);
      }

      // ä¿®æ”¹ setCellBackground æ–¹æ³•
      setCellBackground(x, y, color) {
        this.updateCell(x, y, null, color, true);
      }

      // æ–°å¢ updateCell æ–¹æ³•
      updateCell(x, y, char, backgroundColor, shouldSync = true) {
        const cell = this.getCell(x, y);
        const key = `${x},${y}`;
        
        // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
        if (char !== null) cell.textContent = char;
        if (backgroundColor !== null) cell.style.backgroundColor = backgroundColor;
        
        // åŒæ­¥åˆ° Firebase
        if (shouldSync && window.firebaseRef && window.firebaseUpdate) {
          const updates = {};
          updates[key] = {
            char: char !== null ? char : cell.textContent,
            backgroundColor: backgroundColor !== null ? backgroundColor : cell.style.backgroundColor || 'transparent'
          };
          window.firebaseUpdate(window.firebaseRef, updates).catch(error => {
            console.error('Failed to update Firebase:', error);
          });
        }
      }

      // ä¿®æ”¹ clearCellBackground æ–¹æ³•
      clearCellBackground(x, y) {
        this.updateCell(x, y, null, 'transparent', true);
      }

      createInitialGrid() {
        const viewportWidth = Math.ceil(window.innerWidth / this.cellSize);
        const viewportHeight = Math.ceil(window.innerHeight / this.cellSize);
        
        for (let y = 0; y < viewportHeight; y++) {
          for (let x = 0; x < viewportWidth; x++) {
            this.getCell(x, y);
          }
        }
        
        // æ·»åŠ çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°åˆ›å»ºç½‘æ ¼çš„å¤„ç†
        window.addEventListener('resize', () => {
          this.createInitialGrid();
        });
      }

      setupEventListeners() {
        // æ·»åŠ æ‹–æ”¾äº‹ä»¶ç›‘å¬
        this.container.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
        });

        this.container.addEventListener('drop', (e) => this.handleGridDrop(e));

        // ç‚¹å‡»äº‹ä»¶å¤„ç†
        document.addEventListener('click', (e) => {
          const skipElements = [
            '.feather-outline',
            '.effects-menu',
            '.color-submenu',
            '.portal-submenu',
            '.start-button',
            '.skip-link',
            '.unlock-emoji',
            '.minimized-icon'
          ];

          for (const selector of skipElements) {
            if (e.target.closest(selector)) return;
          }

          const { x, y } = this.positionToGrid(e.clientX, e.clientY);
          
          if (this.activeCellPos) {
            this.getCell(this.activeCellPos.x, this.activeCellPos.y).classList.remove('active');
          }
          this.activeCellPos = { x, y };
          this.getCell(x, y).classList.add('active');
        });

        // é”®ç›˜è¾“å…¥å¤„ç†
        document.addEventListener('keypress', (e) => {
          if (!this.activeCellPos || 
              document.activeElement.tagName === 'INPUT' || 
              document.activeElement.tagName === 'TEXTAREA' ||
              e.target.closest('.feather-outline')) {
            return;
          }
          
          const char = String.fromCharCode(e.keyCode);
          this.setCharacter(this.activeCellPos.x, this.activeCellPos.y, char);
          this.moveCursor(1, 0); // å‘å³ç§»åŠ¨ä¸€æ ¼
        });

        // æ–¹å‘é”®å’Œé€€æ ¼é”®å¤„ç†
        document.addEventListener('keydown', (e) => {
          if (!this.activeCellPos || 
              document.activeElement.tagName === 'INPUT' || 
              document.activeElement.tagName === 'TEXTAREA' ||
              e.target.closest('.feather-outline')) {
            return;
          }
          
          switch(e.key) {
            case 'ArrowLeft':
              e.preventDefault();
              this.moveCursor(-1, 0);
              break;
            case 'ArrowRight':
              e.preventDefault();
              this.moveCursor(1, 0);
              break;
            case 'ArrowUp':
              e.preventDefault();
              this.moveCursor(0, -1);
              break;
            case 'ArrowDown':
              e.preventDefault();
              this.moveCursor(0, 1);
              break;
            case 'Backspace':
              e.preventDefault();
              this.setCharacter(this.activeCellPos.x, this.activeCellPos.y, '');
              this.moveCursor(-1, 0);
              break;
          }
        });
      }

      handleGridDrop(e) {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (!file || !file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => this.processImage(img, Math.floor(e.clientX / this.cellSize), Math.floor(e.clientY / this.cellSize));
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }

      processImage(img, startX, startY) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // è®¾ç½®åˆé€‚çš„å°ºå¯¸ä»¥ä¿æŒå›¾ç‰‡æ¯”ä¾‹
        const maxWidth = 50; // æœ€å¤§å­—ç¬¦å®½åº¦
        const scale = maxWidth / img.width;
        const width = Math.floor(img.width * scale);
        const height = Math.floor(img.height * scale);
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        
        // éå†åƒç´ å¹¶è½¬æ¢ä¸ºå­—ç¬¦
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const i = (y * width + x) * 4;
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // è®¡ç®—äº®åº¦ (0-255)
            const brightness = Math.floor((r + g + b) / 3);
            
            // å°†äº®åº¦æ˜ å°„åˆ°ASCIIå­—ç¬¦
            const charIndex = Math.floor(brightness / 256 * this.asciiRamp.length);
            const char = this.asciiRamp[charIndex];
            
            // åœ¨ç½‘æ ¼ä¸­è®¾ç½®å­—ç¬¦
            this.setCharacter(startX + x, startY + y, char);
          }
        }
      }

      createCell(x, y) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.left = `${x * this.cellSize}px`;
        cell.style.top = `${y * this.cellSize}px`;
        this.container.appendChild(cell);
        return cell;
      }

      getCell(x, y) {
        const key = `${x},${y}`;
        if (!this.cells.has(key)) {
          this.cells.set(key, this.createCell(x, y));
        }
        return this.cells.get(key);
      }

      positionToGrid(clientX, clientY) {
        const rect = this.container.getBoundingClientRect();
        const x = Math.floor((clientX - rect.left) / this.cellSize);
        const y = Math.floor((clientY - rect.top) / this.cellSize);
        return { x, y };
      }

      moveCursor(dx, dy) {
        if (!this.activeCellPos) return;
        
        this.getCell(this.activeCellPos.x, this.activeCellPos.y).classList.remove('active');
        this.activeCellPos.x += dx;
        this.activeCellPos.y += dy;
        
        // ç¡®ä¿åæ ‡ä¸ä¸ºè´Ÿ
        this.activeCellPos.x = Math.max(0, this.activeCellPos.x);
        this.activeCellPos.y = Math.max(0, this.activeCellPos.y);
        
        this.getCell(this.activeCellPos.x, this.activeCellPos.y).classList.add('active');
      }

      // æ·»åŠ è®¾ç½®å½©è‰²å­—ç¬¦çš„æ–¹æ³•
      setColoredCharacter(x, y, color, char = null) {
        const cell = this.getCell(x, y);
        if (!char) {
          // å¦‚æœæ²¡æœ‰æŒ‡å®šå­—ç¬¦ï¼Œä½¿ç”¨éšæœºå­—ç¬¦
          char = this.randomChars[Math.floor(Math.random() * this.randomChars.length)];
        }
        cell.textContent = char;
        cell.style.color = color;
      }
    }

    // æ·»åŠ  Alchemy Furnace åŠŸèƒ½
    function createAlchemyFurnace(imgSrc) {
      const furnace = document.createElement('div');
      furnace.className = 'alchemy-furnace';
      furnace.style.position = 'fixed';
      
      // åˆ›å»ºæ ‡é¢˜æ ï¼Œæ·»åŠ  Apply æŒ‰é’®
      const titleBar = document.createElement('div');
      titleBar.className = 'alchemy-title';
      titleBar.innerHTML = `
        <span>Alchemy Furnace</span>
        <div style="display: flex; align-items: center;">
          <button class="apply-button">
            <span class="checkbox">[ ]</span>
            <span>Apply</span>
          </button>
          <div class="notepad-title-buttons">
            <button class="title-button minimize">_</button>
            <button class="title-button maximize">â–¡</button>
            <button class="title-button close">Ã—</button>
          </div>
        </div>
      `;

      // åˆ›å»ºå†…å®¹åŒºåŸŸ
      const content = document.createElement('div');
      content.className = 'alchemy-content';
      
      // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
      const img = document.createElement('img');
      img.src = imgSrc;
      content.appendChild(img);

      // ç»„è£…çª—å£
      furnace.appendChild(titleBar);
      furnace.appendChild(content);
      
      // æ·»åŠ è°ƒæ•´å¤§å°çš„æ‰‹æŸ„
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle bottom-right';
      furnace.appendChild(resizeHandle);

      // çª—å£çŠ¶æ€
      const state = {
        isDragging: false,
        isResizing: false,
        startX: 0,
        startY: 0,
        furnaceX: 0,
        furnaceY: 0,
        startWidth: 0,
        startHeight: 0,
        seamCarver: null,
        isApplied: false
      };

      // åˆå§‹åŒ– SeamCarver
      const initSeamCarver = () => {
        const tempCanvas = document.createElement('canvas');
        const tctx = tempCanvas.getContext('2d');
        const imgEl = furnace.querySelector('img');

        const MAX_SIZE = 800;
        let scaleFactor = 1;
        if (imgEl.naturalWidth > MAX_SIZE || imgEl.naturalHeight > MAX_SIZE) {
          scaleFactor = MAX_SIZE / Math.max(imgEl.naturalWidth, imgEl.naturalHeight);
          tempCanvas.width = imgEl.naturalWidth * scaleFactor;
          tempCanvas.height = imgEl.naturalHeight * scaleFactor;
        } else {
          tempCanvas.width = imgEl.naturalWidth;
          tempCanvas.height = imgEl.naturalHeight;
        }

        tctx.drawImage(imgEl, 0, 0, tempCanvas.width, tempCanvas.height);
        const imageData = tctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);

        state.seamCarver = new window.SeamCarver(imageData);
        state.seamCarver.scaleFactor = scaleFactor;
      };

      // æ‹–æ‹½åŠŸèƒ½
      titleBar.addEventListener('mousedown', (e) => {
        if (e.target.closest('.notepad-title-buttons')) return;
        
        e.preventDefault();
        e.stopPropagation();
        state.isDragging = true;
        furnace.classList.add('dragging');
        
        const rect = furnace.getBoundingClientRect();
        state.furnaceX = rect.left;
        state.furnaceY = rect.top;
        state.startX = e.clientX;
        state.startY = e.clientY;
      });

      // è°ƒæ•´å¤§å°åŠŸèƒ½
      resizeHandle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        state.isResizing = true;
        
        const rect = furnace.getBoundingClientRect();
        state.startX = e.clientX;
        state.startY = e.clientY;
        state.startWidth = rect.width;
        state.startHeight = rect.height;

        // ç¡®ä¿ SeamCarver å·²åˆå§‹åŒ–
        if (!state.seamCarver) {
          initSeamCarver();
        }
      });

      // å¤„ç†é¼ æ ‡ç§»åŠ¨
      const handleMouseMove = (e) => {
        if (state.isDragging) {
          const dx = e.clientX - state.startX;
          const dy = e.clientY - state.startY;
          
          let newX = state.furnaceX + dx;
          let newY = state.furnaceY + dy;
          
          // é™åˆ¶çª—å£ä¸å®Œå…¨ç§»å‡ºè§†å›¾
          const rect = furnace.getBoundingClientRect();
          const maxX = window.innerWidth - rect.width / 2;
          const maxY = window.innerHeight - rect.height / 2;
          const minX = -rect.width / 2;
          const minY = -rect.height / 2;
          
          newX = Math.max(minX, Math.min(maxX, newX));
          newY = Math.max(minY, Math.min(maxY, newY));
          
          furnace.style.left = `${newX}px`;
          furnace.style.top = `${newY}px`;
        }
        
        if (state.isResizing && state.seamCarver) {
          const dx = e.clientX - state.startX;
          const dy = e.clientY - state.startY;
          
          const minWidth = 50;
          const maxWidth = window.innerWidth * 0.9;
          const newWidth = Math.max(minWidth, Math.min(maxWidth, state.startWidth + dx));
          
          const minHeight = 50;
          const maxHeight = window.innerHeight * 0.9;
          const newHeight = Math.max(minHeight, Math.min(maxHeight, state.startHeight + dy));
          
          furnace.style.width = `${newWidth}px`;
          furnace.style.height = `${newHeight}px`;
          
          const imgEl = furnace.querySelector('img');
          const targetWidth = Math.floor(newWidth * state.seamCarver.scaleFactor);
          const scaled = state.seamCarver.resize(targetWidth);
          const resultCanvas = document.createElement('canvas');
          resultCanvas.width = scaled.width;
          resultCanvas.height = scaled.height;
          resultCanvas.getContext('2d').putImageData(scaled, 0, 0);
          imgEl.src = resultCanvas.toDataURL();
        }
      };

      // å¤„ç†é¼ æ ‡æŠ¬èµ·
      const handleMouseUp = () => {
        if (state.isDragging || state.isResizing) {
          state.isDragging = false;
          state.isResizing = false;
          furnace.classList.remove('dragging');
        }
      };

      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      // å›¾ç‰‡åŠ è½½å®Œæˆååˆå§‹åŒ– SeamCarver
      img.onload = initSeamCarver;

      // æ·»åŠ  Apply åŠŸèƒ½
      const applyButton = titleBar.querySelector('.apply-button');
      const checkbox = applyButton.querySelector('.checkbox');
      
      const applyImageToGrid = () => {
        const rect = furnace.getBoundingClientRect();
        const furnaceContent = furnace.querySelector('.alchemy-content');
        const contentRect = furnaceContent.getBoundingClientRect();
        
        // ç¡®ä¿ SeamCarver å·²åˆå§‹åŒ–å¹¶å¤„ç†äº†å½“å‰å°ºå¯¸
        if (!state.seamCarver) {
          initSeamCarver();
        }
        
        // ä½¿ç”¨ SeamCarver å¤„ç†åçš„å›¾åƒæ•°æ®
        const targetWidth = Math.floor(contentRect.width * state.seamCarver.scaleFactor);
        const processedImageData = state.seamCarver.resize(targetWidth);
        
        // åˆ›å»ºä¸´æ—¶ canvas æ˜¾ç¤ºå¤„ç†åçš„å›¾åƒ
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = contentRect.width;
        canvas.height = contentRect.height;
        
        // åˆ›å»ºä¸´æ—¶ canvas å­˜æ”¾ SeamCarver å¤„ç†åçš„æ•°æ®
        const processedCanvas = document.createElement('canvas');
        const processedCtx = processedCanvas.getContext('2d');
        processedCanvas.width = processedImageData.width;
        processedCanvas.height = processedImageData.height;
        processedCtx.putImageData(processedImageData, 0, 0);
        
        // å°†å¤„ç†åçš„å›¾åƒç»˜åˆ¶åˆ°æœ€ç»ˆå°ºå¯¸
        ctx.drawImage(processedCanvas, 0, 0, contentRect.width, contentRect.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // è®¡ç®—ç½‘æ ¼èµ·å§‹ä½ç½®
        const startGridX = Math.floor((rect.left + window.scrollX) / window.grid.cellSize);
        const startGridY = Math.floor((rect.top + window.scrollY) / window.grid.cellSize);
        
        // è®¡ç®—æ¯ä¸ªç½‘æ ¼å•å…ƒå¯¹åº”çš„åƒç´ åŒºåŸŸ
        const pixelsPerCell = window.grid.cellSize;
        
        // éå†å›¾ç‰‡åŒºåŸŸ
        for (let y = 0; y < contentRect.height; y += pixelsPerCell) {
          for (let x = 0; x < contentRect.width; x += pixelsPerCell) {
            // è®¡ç®—å½“å‰ç½‘æ ¼å•å…ƒå¯¹åº”çš„åƒç´ åŒºåŸŸçš„å¹³å‡é¢œè‰²
            let r = 0, g = 0, b = 0, a = 0;
            let count = 0;
            
            // è®¡ç®—åŒºåŸŸå¹³å‡é¢œè‰²
            for (let py = y; py < Math.min(y + pixelsPerCell, contentRect.height); py++) {
              for (let px = x; px < Math.min(x + pixelsPerCell, contentRect.width); px++) {
                const i = (py * imageData.width + px) * 4;
                r += imageData.data[i];
                g += imageData.data[i + 1];
                b += imageData.data[i + 2];
                a += imageData.data[i + 3];
                count++;
              }
            }
            
            // è®¡ç®—å¹³å‡å€¼
            r = Math.round(r / count);
            g = Math.round(g / count);
            b = Math.round(b / count);
            a = Math.round(a / count);
            
            // è®¾ç½®ç½‘æ ¼å•å…ƒèƒŒæ™¯è‰²
            if (a > 0) { // åªå¤„ç†éå®Œå…¨é€æ˜çš„åƒç´ 
              const color = `rgba(${r},${g},${b},${a/255})`;
              const gridX = startGridX + Math.floor(x / pixelsPerCell);
              const gridY = startGridY + Math.floor(y / pixelsPerCell);
              window.grid.setCellBackground(gridX, gridY, color);
            }
          }
        }
      };

      const removeImageFromGrid = () => {
        const rect = furnace.getBoundingClientRect();
        const furnaceContent = furnace.querySelector('.alchemy-content');
        const contentRect = furnaceContent.getBoundingClientRect();
        
        const startGridX = Math.floor((rect.left + window.scrollX) / window.grid.cellSize);
        const startGridY = Math.floor((rect.top + window.scrollY) / window.grid.cellSize);
        const gridWidth = Math.ceil(contentRect.width / window.grid.cellSize);
        const gridHeight = Math.ceil(contentRect.height / window.grid.cellSize);
        
        // æ¸…é™¤å¯¹åº”åŒºåŸŸçš„èƒŒæ™¯è‰²
        for (let y = 0; y < gridHeight; y++) {
          for (let x = 0; x < gridWidth; x++) {
            window.grid.clearCellBackground(startGridX + x, startGridY + y);
          }
        }
      };

      applyButton.addEventListener('click', () => {
        state.isApplied = !state.isApplied;
        checkbox.textContent = state.isApplied ? '[*]' : '[ ]';
        
        if (state.isApplied) {
          applyImageToGrid();
        } else {
          removeImageFromGrid();
        }
      });

      // ä¿®æ”¹æ‹–æ‹½å¤„ç†ï¼Œåœ¨æ‹–æ‹½æ—¶æ›´æ–°ç½‘æ ¼
      const handleDrag = (e) => {
        if (state.isDragging) {
          // ... ä¿æŒç°æœ‰æ‹–æ‹½ä»£ç  ...
          
          // å¦‚æœå·²åº”ç”¨ï¼Œæ›´æ–°ç½‘æ ¼
          if (state.isApplied) {
            removeImageFromGrid();
            applyImageToGrid();
          }
        }
      };

      // ä¿®æ”¹è°ƒæ•´å¤§å°å¤„ç†ï¼Œåœ¨è°ƒæ•´å¤§å°æ—¶æ›´æ–°ç½‘æ ¼
      const handleResize = (e) => {
        if (state.isResizing) {
          // ... ä¿æŒç°æœ‰è°ƒæ•´å¤§å°ä»£ç  ...
          
          // å¦‚æœå·²åº”ç”¨ï¼Œæ›´æ–°ç½‘æ ¼
          if (state.isApplied) {
            removeImageFromGrid();
            applyImageToGrid();
          }
        }
      };

      return furnace;
    }

    // å°†çª—å£ç½®äºé¡¶å±‚çš„å‡½æ•°
    function bringToFront(furnace) {
      const maxZIndex = Array.from(document.querySelectorAll('.alchemy-furnace'))
        .reduce((max, f) => Math.max(max, parseInt(getComputedStyle(f).zIndex) || 0), 1000);
      furnace.style.zIndex = maxZIndex + 1;
    }

    function initAlchemyFurnace() {
      // å½“å‰æ‰“å¼€çš„çª—å£
      let currentFurnace = null;
      let isProcessingClick = false;  // æ·»åŠ ç‚¹å‡»å¤„ç†çŠ¶æ€æ ‡å¿—

      // å¤„ç†å›¾ç‰‡ç‚¹å‡»
      document.addEventListener('click', async (e) => {
        // åªå¤„ç† Portal ä¸­çš„å›¾ç‰‡ç‚¹å‡»
        if (e.target.tagName.toLowerCase() === 'img' && 
            e.target.closest('.notepad-content')) {
          
          e.preventDefault();
          e.stopPropagation();

          // é˜²æ­¢é‡å¤ç‚¹å‡»å¤„ç†
          if (isProcessingClick) return;
          isProcessingClick = true;

          try {
            // å¦‚æœå·²ç»æœ‰çª—å£æ‰“å¼€ï¼Œå…ˆå…³é—­å®ƒ
            if (currentFurnace && document.body.contains(currentFurnace)) {
              currentFurnace.remove();
            }
            
            // åˆ›å»ºæ–°çª—å£
            currentFurnace = createAlchemyFurnace(e.target.src);
            document.body.appendChild(currentFurnace);
            
            // è®¾ç½®çª—å£ä½ç½®ï¼ˆå±…ä¸­ï¼‰
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const furnaceWidth = 400;
            const furnaceHeight = 300;
            
            const left = (windowWidth - furnaceWidth) / 2;
            const top = (windowHeight - furnaceHeight) / 2;
            
            currentFurnace.style.left = `${left}px`;
            currentFurnace.style.top = `${top}px`;
            currentFurnace.style.width = `${furnaceWidth}px`;
            currentFurnace.style.height = `${furnaceHeight}px`;
            currentFurnace.style.display = 'flex';
            currentFurnace.style.zIndex = '9999';

            // å…³é—­æŒ‰é’®åŠŸèƒ½
            const closeButton = currentFurnace.querySelector('.title-button.close');
            closeButton.addEventListener('click', () => {
              currentFurnace.remove();
              currentFurnace = null;
            });
          } finally {
            isProcessingClick = false;
          }
        }
      });

      // å¤„ç†çª—å£å¤§å°æ”¹å˜
      window.addEventListener('resize', () => {
        if (currentFurnace && document.body.contains(currentFurnace)) {
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          const furnaceWidth = parseInt(currentFurnace.style.width);
          const furnaceHeight = parseInt(currentFurnace.style.height);
          
          // ç¡®ä¿çª—å£åœ¨è§†å›¾èŒƒå›´å†…
          let left = parseInt(currentFurnace.style.left);
          let top = parseInt(currentFurnace.style.top);
          
          left = Math.max(0, Math.min(left, windowWidth - furnaceWidth));
          top = Math.max(0, Math.min(top, windowHeight - furnaceHeight));
          
          currentFurnace.style.left = `${left}px`;
          currentFurnace.style.top = `${top}px`;
        }
      });
    }

    // ç¡®ä¿åªåˆå§‹åŒ–ä¸€æ¬¡
    let alchemyInitialized = false;

    // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing systems');
      grid = new CharacterGrid();
      initializeMenu();
      initializeColorControl();
      initializeMinimize();
      initNotepadDrag();
      
      // åªåœ¨æœªåˆå§‹åŒ–æ—¶è°ƒç”¨ä¸€æ¬¡
      if (!alchemyInitialized) {
        console.log('Initializing Alchemy Furnace functionality');
        initAlchemyFurnace();
        alchemyInitialized = true;
      }
    });
  </script>
</body>

</html>