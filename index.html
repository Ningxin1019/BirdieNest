<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nest Displacement</title>
  <script src="seam.js" defer></script>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    import {
      getDatabase,
      ref,
      onValue,
      update,
      set
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBzbTuyiCXml_9lqF2XJS7fF0tluvizV7g",
      authDomain: "nestdisplacement.firebaseapp.com",
      databaseURL: "https://nestdisplacement-default-rtdb.firebaseio.com",
      projectId: "nestdisplacement",
      storageBucket: "nestdisplacement.firebasestorage.app",
      messagingSenderId: "707900225193",
      appId: "1:707900225193:web:dca902938e4b41aed95bb8",
      measurementId: "G-M818THVNFF"
    };

    // 在 Firebase 初始化脚本中添加数据库连接测试
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        
        // 测试数据库连接和权限
        const testRef = ref(database, 'grid/test');
        try {
          await set(testRef, {
            timestamp: Date.now()
          });
          console.log('Firebase database connection and permissions verified');
          await set(testRef, null); // 清理测试数据
        } catch (error) {
          console.error('Firebase database permission error:', error);
          alert('Firebase database permission error. Please check database rules.');
          return;
        }
        
        // 保存 Firebase 实例到全局变量
        window.firebaseApp = app;
        window.firebaseAnalytics = analytics;
        window.firebaseDb = database;
        window.firebaseRef = ref(database, 'grid');
        window.firebaseUpdate = update;
        window.firebaseSet = set;
        window.onValue = onValue;  // 添加这一行，保存 onValue 函数到全局
        
        // 初始化网格
        window.grid = new CharacterGrid();
      } catch (error) {
        console.error('Error initializing Firebase:', error);
        alert('Failed to initialize Firebase. Please check console for details.');
      }
    });
  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: monospace; /* 使用等宽字体营造复古感 */
      background-color: #fff;
      color: #000;
      overflow: hidden;
      filter: grayscale(100%); /* 添加这一行，使整个页面变成黑白 */
    }

    .initial-state {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 1;
    }

    .initial-state > * {
      pointer-events: auto;
    }

    .hello {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.8);
      padding: 5px;
      border-radius: 3px;
    }

    .start-button {
      font-family: monospace;
      font-size: 16px;
      padding: 10px 20px;
      margin: 20px;
      background: none;
      border: 1px solid #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .start-button:hover {
      background-color: #000;
      color: #fff;
    }

    .skip-link {
      font-size: 12px;
      color: #666;
      text-decoration: none;
      margin-top: 10px;
    }

    .skip-link:hover {
      text-decoration: underline;
    }

    /* 隐藏的内容，等待解锁 */
    .hidden {
      display: none;
    }

    /* 解锁后的样式变化 */
    .stage-1 {
      background-color: #f5f5f5;
      transition: background-color 2s ease;
    }

    .stage-2 {
      font-family: 'Times New Roman', serif;
      transition: font-family 1s ease;
    }

    .stage-3 {
      color: #333;
      transition: color 1s ease;
    }

    /* 添加新的样式 */
    .journey-stage-1 {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 1s ease;
      z-index: 1000;
    }

    .journey-stage-1 > * {
      pointer-events: auto;
    }

    .text-fragment {
      position: absolute;
      padding: 10px;
      background: #fff;
      border: 1px solid #000;
      cursor: move;
      font-size: 14px;
      max-width: 300px;
      text-align: left;
      transition: all 0.3s ease;
      opacity: 0;
      line-height: 1.6;
      user-select: none;
      z-index: 1000;
      pointer-events: auto !important;
    }

    .text-fragment.visible {
      opacity: 1;
    }

    .text-fragment:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .collected-text {
      font-size: 12px;
      line-height: 1.6;
      margin: 0;
      padding: 5px 0;
      transition: all 0.5s ease;
    }

    .collected-text:not(:last-child) {
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .feather-outline {
      position: absolute;
      width: 500px;
      min-height: 300px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid;
      border-color: #dfdfdf #808080 #808080 #dfdfdf;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      transition: none;
      resize: both;
      overflow: auto;
      max-width: 90vw;
      max-height: 80vh;
      z-index: 2;
    }

    .feather-outline.dragging {
      transition: none;
      cursor: move;
    }

    /* 记事本标题栏 */
    .notepad-title {
      background: #000080;
      color: white;
      padding: 3px 5px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .notepad-title-buttons {
      display: flex;
      gap: 2px;
    }

    .title-button {
      width: 16px;
      height: 14px;
      background: #c0c0c0;
      border: 1px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
    }

    /* 最小化按钮样式 */
    .title-button.minimize {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
    }

    .title-button.minimize.active {
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
    }

    /* 放大和关闭按钮的禁用样式 */
    .title-button.maximize,
    .title-button.close {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
      background: #d4d4d4;
    }

    /* 记事本内容区 */
    .notepad-content {
      flex: 1;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #808080;
      border-top: 2px solid #808080;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-y: auto;
      min-height: 250px;
      outline: none;
      caret-color: #000;
      max-height: calc(80vh - 30px);
    }

    .notepad-content::selection {
      background: #000080;
      color: #fff;
    }

    /* 文本碎片的初始位置 */
    .text-fragment:nth-child(1) {
      top: 30%;
      left: 20%;
    }

    .text-fragment:nth-child(2) {
      top: 50%;
      right: 25%;
    }

    /* 简化提示元素的样式，移除过渡动画 */
    .unlock-text {
      position: absolute;
      left: 25%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
    }

    .unlock-emoji {
      position: absolute;
      right: 25%;
      top: 50%;
      transform: translate(50%, -50%);
      font-size: 48px;
      opacity: 0;
      visibility: hidden;
      z-index: 1000;
      cursor: pointer;
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* 添加弹性动画 */
    }

    /* 添加悬停效果 */
    .unlock-emoji:hover {
      transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      animation: wiggle 0.5s infinite alternate;
    }

    /* 添加摇晃动画 */
    @keyframes wiggle {
      0% {
        transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      }
      100% {
        transform: translate(50%, -50%) rotate(15deg) scale(1.2);
      }
    }

    /* 简化显示类 */
    .unlock-text.show,
    .unlock-emoji.show {
      opacity: 1;
      visibility: visible;
    }

    /* 修改星号按钮样式，确保只有一处定义颜色 */
    .star-button {
      position: fixed;
      top: 17px;
      left: 20px;
      font-family: monospace;
      font-size: 24px;
      user-select: none;
      z-index: 2000;
      display: none;
      color: #000 !important; /* 使用 !important 确保颜色不被其他样式覆盖 */
      pointer-events: none;
    }

    .star-button.unlocked {
      pointer-events: auto;
      cursor: pointer;
      /* 移除任何颜色相关的样式 */
    }

    /* 修改菜单样式 */
    .effects-menu {
      position: fixed;
      top: 0;
      left: 0;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      display: none;
      z-index: 1999;
      background: white;
    }

    .menu-title {
      margin-bottom: 20px;
      margin-left: 35px; /* 与星号对齐 */
      white-space: pre;
    }

    .section-title {
      white-space: pre;
      margin-left: 45px; /* 比星号位置稍微靠右一点 */
      margin-top: -20px; /* 上移到与星号同一水平线 */
    }

    .effects-list {
      margin-left: 2px;
      margin-top: 10px; /* 从20px改为10px，向上移动10像素 */
      white-space: pre;
    }

    .effect-item {
      display: flex;
      align-items: center;
      gap: 10px; /* 添加选项框和文字之间的间距 */
      color: #888;
      cursor: default;
    }

    .effect-item.unlocked {
      color: #000;
      cursor: pointer;
    }

    .checkbox {
      font-family: monospace;
      user-select: none;
    }

    /* 选中状态的样式 */
    .effect-item.checked .checkbox {
      content: '[*]';
    }

    /* 修改子菜单样式 */
    .color-submenu {
      position: fixed;
      top: 0;
      right: 0; /* 改为0，直接贴住右边 */
      background: white;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      display: none;
      z-index: 1998;
    }

    .slider-group {
      margin-bottom: 30px; /* 增加滑块组之间的间距 */
      width: 200px; /* 固定宽度 */
    }

    .slider-label {
      margin-bottom: 10px;
      white-space: pre;
    }

    .color-slider {
      width: 100%; /* 使用父元素的宽度 */
      -webkit-appearance: none;
      appearance: none;
      height: 2px;
      background: #000;
      outline: none;
      position: relative;
    }

    .color-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 20px;
      background: #000;
      cursor: pointer;
    }

    /* 添加滑块两端的线条 */
    .color-slider::before,
    .color-slider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 20px;
      height: 2px;
      background: #000;
    }

    .color-slider::before {
      left: -20px;
    }

    .color-slider::after {
      right: -20px;
    }

    /* 添加禁用状态的样式 */
    .effect-checkbox[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .effect-item {
      opacity: 0.5; /* 初始状态显示为半透明 */
      transition: opacity 0.3s ease;
    }

    .effect-item.unlocked {
      opacity: 1; /* 解锁后显示为完全不透明 */
      cursor: pointer;
    }

    /* 添加最小化相关的样式 */
    .minimized-notepad {
      position: fixed;
      left: 20px;
      bottom: 20px;
      cursor: pointer;
      z-index: 9999;
      display: none;
    }

    .notepad-icon {
      width: 64px;
      height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 5px;
      background: #fff;
      border: 1px solid #000;
      box-shadow: 2px 2px 0 #000;
    }

    .icon-image {
      font-size: 32px;
      display: inline-block;
      margin-bottom: 5px;
    }

    .icon-text {
      font-family: monospace;
      font-size: 12px;
      text-align: center;
    }

    /* 修改最小化按钮样式 */
    .title-button.minimize {
      cursor: default;
      pointer-events: none;
      opacity: 0.5;
    }

    .title-button.minimize.active {
      cursor: pointer;
      pointer-events: auto;
      opacity: 1;
    }

    .minimized-icon {
      position: fixed;
      left: 50%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-size: 48px;
      cursor: move;
      z-index: 9999;
      margin: 0;
      padding: 0;
      pointer-events: auto;
      user-select: none;
      text-align: center;
    }

    .icon-label {
      font-family: monospace;
      font-size: 14px;
      margin-top: 5px;
      color: #000;
      white-space: nowrap;
      text-align: center;
    }

    /* 拖动时的样式 */
    .minimized-icon.dragging {
      opacity: 0.7;
    }

    /* 添加重复提示的样式 */
    .repeat-text {
      position: fixed;
      left: 25%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .again-text {
      position: fixed;
      right: 25%;
      top: 50vh;
      transform: translate(50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .repeat-text.show,
    .again-text.show {
      opacity: 1;
      visibility: visible;
    }

    /* 添加炼金术解锁提示的样式 */
    .portal-text {
        position: absolute;
      left: 17%;
      top: 50vh;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .portal-emoji {
        position: absolute;
      right: 17%;
      top: 50vh;
      transform: translate(50%, -50%);
      font-size: 48px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
      transition: opacity 0.5s ease, visibility 0.5s ease, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .portal-emoji:hover {
      transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      animation: wiggle 0.5s infinite alternate;
    }

    .portal-text.show,
    .portal-emoji.show {
      opacity: 1;
      visibility: visible;
    }

    /* 添加 portal Setup 子菜单样式 */
    .portal-submenu {
      position: fixed;
      top: 0;
      right: 0;
      background: white;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      display: none;
      z-index: 1998;
    }

    .mode-option {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: #000;
      cursor: pointer;
    }

    .mode-option .checkbox {
      font-family: monospace;
      user-select: none;
    }

    .mode-option.checked .checkbox {
      content: '[*]';
    }

    /* 添加 placeholder 样式 */
    .notepad-content[data-placeholder]:empty:before {
      content: attr(data-placeholder);
      color: #999;
      font-style: italic;
    }

    /* 修改图片样式 */
    .notepad-content img {
      max-width: 100%;
      height: auto;
      cursor: pointer;
      transition: transform 0.2s ease;
      pointer-events: auto;  /* 确保图片可以接收点击事件 */
    }

    .notepad-content img:hover {
      transform: scale(1.02);
    }

    /* 修改字符网格样式 */
    .character-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: monospace;
      font-size: 16px;
      line-height: 1;
      white-space: pre;
      cursor: text;
      z-index: 0;
      background: transparent;
      pointer-events: auto;
      user-select: none;
    }

    .grid-cell {
      position: absolute;
      width: 8px;  /* 从 16px 改为 8px */
      height: 8px; /* 从 16px 改为 8px */
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      box-sizing: border-box;
      pointer-events: auto;
      border: none;
      color: #000;
      text-shadow: 0 0 1px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
      font-size: 8px;  /* 添加字体大小设置 */
      line-height: 1;  /* 确保文字垂直居中 */
    }

    .grid-cell.active {
      background: rgba(0, 0, 255, 0.1) !important;
      border: 1px solid rgba(0, 0, 255, 0.3);
    }

    .grid-cell:not(:empty) {
      background: rgba(255, 255, 255, 0.1);
    }

    /* 确保其他UI元素在网格之上但不阻挡点击 */
    .initial-state {
      pointer-events: none;
    }

    .initial-state > * {
      pointer-events: auto;
    }

    .journey-stage-1 {
      pointer-events: none;
    }

    .feather-outline,
    .unlock-emoji,
    .unlock-text,
    .effects-menu,
    .color-submenu,
    .portal-submenu,
    .start-button,
    .skip-link,
    .minimized-icon {
      pointer-events: auto;
    }

    /* 修改 Alchemy Furnace 样式 */
    .alchemy-furnace {
      position: fixed;
      background: #fff;
      border: 2px solid;
      border-color: #dfdfdf #808080 #808080 #dfdfdf;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      display: none;
      flex-direction: column;
      font-family: 'MS Sans Serif', Arial, sans-serif;
      overflow: hidden;
      width: 400px;
      height: 300px;
      min-width: 50px;  /* 减小最小宽度 */
      min-height: 50px; /* 减小最小高度 */
      z-index: 1001;
      position: relative;
    }

    /* 移除之前的 ::after 样式 */
    .alchemy-furnace::after {
      content: none;
    }

    /* 添加和 Portal 相同的调整大小指示器样式 */
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: transparent;
      z-index: 1002;
    }

    .resize-handle.bottom-right {
      right: 0;
      bottom: 0;
      cursor: se-resize;
    }

    .alchemy-title {
      background: #000080;
      color: white;
      padding: 3px 5px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: move;
      user-select: none;
    }

    .alchemy-content {
      flex: 1;
      padding: 0;
      margin: 0;
      background: #ffffff;
      display: flex;
      flex-direction: column;  /* 确保内容垂直排列 */
      overflow: hidden;
      position: relative;
    }

    .alchemy-content img {
      width: 100%;
      height: 100%;
      object-fit: cover;  /* 改为 cover 确保图片填充整个容器 */
      margin: 0;
      padding: 0;
      display: block;
    }

    /* 修改 Portal 中图片的样式 */
    .notepad-content img {
      max-width: 100%;
      height: auto;
      cursor: pointer;
      transition: transform 0.2s ease;
      pointer-events: auto;  /* 确保图片可以接收点击事件 */
    }

    .notepad-content img:hover {
      transform: scale(1.02);
    }

    /* 添加 Content-Aware Scale 切换按钮样式 */
    .scale-mode-toggle {
      position: absolute;
      right: 25px;
      top: 3px;
      font-size: 12px;
      color: white;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
    }

    .scale-mode-toggle .checkbox {
      margin-right: 5px;
      font-family: monospace;
    }

    .apply-button {
      background: #c0c0c0;
      border: 1px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      color: #000;
      padding: 1px 8px;
      margin-right: 10px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .apply-button .checkbox {
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="initial-state">
    <div class="hello">Hello, world!</div>
    <button class="start-button" onclick="startJourney()">Start</button>
    <a href="#" class="skip-link" onclick="skipToNest()">Skip to nest</a>
  </div>

  <!-- 隐藏的内容，等待解锁 -->
  <div id="journey-content" class="hidden">
    <div class="journey-stage-1">
      <div class="unlock-emoji">🎁</div>
      <div class="unlock-text">Colors unlocked</div>
      <div class="feather-outline">
        <div class="notepad-title">
          <span>Portal</span>
          <div class="notepad-title-buttons">
            <button class="title-button minimize">_</button>
            <button class="title-button maximize">□</button>
            <button class="title-button close">×</button>
          </div>
        </div>
        <div class="notepad-content" id="dropZone" contenteditable="true" spellcheck="false"></div>
      </div>
    </div>
  </div>

  <div id="nest-generator" class="hidden">
    <!-- 最终的生成器工具 -->
  </div>

  <!-- 修改菜单HTML结构 -->
  <div class="star-button">*</div>
  <div class="effects-menu">
    <div class="menu-title">Nest Displacement</div>
    <div class="menu-section">
      <div class="section-title">/EFFECTS</div>
      <div class="effects-list">
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">COLOR</span>
        </div>
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">SLICE TOOL</span>
        </div>
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">PORTAL SETUP</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加颜色控制子菜单 -->
  <div class="color-submenu">
    <div class="slider-group">
      <div class="slider-label">HUE</div>
      <input type="range" class="color-slider" id="hueSlider" min="0" max="360" value="180">
    </div>
    <div class="slider-group">
      <div class="slider-label">BRIGHTNESS</div>
      <input type="range" class="color-slider" id="brightnessSlider" min="0" max="100" value="50">
    </div>
    <div class="slider-group">
      <div class="slider-label">SATURATION</div>
      <input type="range" class="color-slider" id="saturationSlider" min="0" max="100" value="50">
    </div>
  </div>

  <!-- 添加 portal Setup 子菜单 -->
  <div class="portal-submenu">
    <div class="mode-option checked" data-mode="bird">
      <span class="checkbox">[*]</span>
      <span class="mode-name">Bird Mode</span>
    </div>
    <div class="mode-option" data-mode="free">
      <span class="checkbox">[ ]</span>
      <span class="mode-name">Free Mode</span>
    </div>
    <div class="mode-option" data-mode="hack">
      <span class="checkbox">[ ]</span>
      <span class="mode-name">Hack Mode</span>
    </div>
  </div>

  <!-- 在 body 中添加最小化后的图标容器 -->
  <div class="minimized-notepad">
    <div class="notepad-icon">
      <span class="icon-image">📝</span>
      <span class="icon-text">Portal</span>
    </div>
  </div>

  <div class="minimized-icon" style="display: none;">
    🗒️
    <div class="icon-label">Portal</div>
  </div>

  <!-- 添加重复提示的HTML -->
  <div class="repeat-text">Repeat</div>
  <div class="again-text">Again</div>

  <!-- 添加炼金术解锁提示的HTML -->
  <div class="portal-text">portal Setup Unlocked</div>
  <div class="portal-emoji">🎁</div>

  <!-- 添加 Alchemy Furnace HTML -->
  <div class="alchemy-furnace">
    <div class="alchemy-title">
      <span>Alchemy Furnace</span>
      <div style="display: flex; align-items: center;">
        <button class="apply-button">
          <span class="checkbox">[ ]</span>
          <span>Apply</span>
        </button>
        <div class="notepad-title-buttons">
          <button class="title-button minimize">_</button>
          <button class="title-button maximize">□</button>
          <button class="title-button close">×</button>
        </div>
      </div>
    </div>
    <div class="alchemy-content"></div>
  </div>

  <script>
    // 添加 SeamCarver 加载检查
    let seamCarverLoaded = false;
    document.addEventListener('DOMContentLoaded', () => {
      // 检查 SeamCarver 是否已加载
      if (typeof window.SeamCarver === 'undefined') {
        console.log('Waiting for SeamCarver to load...');
        const checkSeamCarver = setInterval(() => {
          if (typeof window.SeamCarver !== 'undefined') {
            console.log('SeamCarver loaded successfully!');
            seamCarverLoaded = true;
            clearInterval(checkSeamCarver);
          }
        }, 100);
      } else {
        console.log('SeamCarver already loaded!');
        seamCarverLoaded = true;
      }
    });

    // 添加文本数组
    const textSequence = [
      "Pet lovebirds often use their beaks to carefully cut pieces of paper and tuck them into their tail feathers.",
      "Despite being born and raised in artificial environments, they retain their instinctual drive as animals to collect diverse materials for nesting.",
      "Consequently, it's common to observe domestic lovebirds decorating themselves with objects produced by human society,",
      "resulting in a quirky yet fascinating sight. Inspired by this behavior,",
      "I've coined a new artistic term, Nest Displacement, to describe instinct-driven creative behaviors within artificial contexts, encompassing adaptation and mutation,",
      "or how individuals seek new possibilities within predefined structures.",
      "Another term, Nest-Grafting, combining the concepts of 'embedding' and 'nesting,'",
      "refers to an individual's appropriation and transformation of surrounding materials, describing artistic actions that incorporate heterogeneous elements into one's own system."
    ];

    let currentTextIndex = 0;
    let isColorUnlocked = false; // 添加一个状态标记
    let isMenuUnlocked = false;

    // 添加鸟类名称数组
    const birds = [
      'Rainbow_lorikeet',
      'Budgerigar',
      'Cockatiel',
      'Agapornis',  // 更改为学名
      'African_grey_parrot',
      'Galah',
      'Monk_parakeet',
      'Cockatoo',
      'Sun_conure',
      'Pacific_parrotlet'
    ];

    // 添加模式管理变量
    let currentMode = 'bird';
    let pendingMode = 'bird';
    let lastWord = '';
    let searchTimeout = null;

    function startJourney() {
      document.querySelector('.initial-state').style.display = 'none';
      const journeyContent = document.getElementById('journey-content');
      journeyContent.classList.remove('hidden');
      
      // 显示星号按钮，确保是黑色
      const starButton = document.querySelector('.star-button');
      starButton.style.display = 'block';
      starButton.style.color = '#000';
      
      setTimeout(() => {
        const stage1 = document.querySelector('.journey-stage-1');
        stage1.style.opacity = '1';
        
        // 确保记事本和其他UI元素可以正常交互
        const notepad = document.querySelector('.feather-outline');
        notepad.style.pointerEvents = 'auto';
        
        initDragAndDrop();
        initNotepad();
        showNextText();
      }, 100);
    }

    function skipToNest() {
      // 隐藏初始界面
      document.querySelector('.initial-state').style.display = 'none';
      const nestGenerator = document.getElementById('nest-generator');
      nestGenerator.classList.remove('hidden');
      
      // 移除黑白滤镜
      document.body.style.filter = 'grayscale(0%)';
      document.body.style.backgroundColor = getRandomPastelColor();
      
      // 显示并解锁星号按钮
      const starButton = document.querySelector('.star-button');
      starButton.style.display = 'block';
      starButton.classList.add('unlocked');
      isMenuUnlocked = true;
      isColorUnlocked = true;
      
      // 隐藏所有解锁提示
      const unlockEmoji = document.querySelector('.unlock-emoji');
      const unlockText = document.querySelector('.unlock-text');
      const portalText = document.querySelector('.portal-text');
      const portalEmoji = document.querySelector('.portal-emoji');
      const repeatText = document.querySelector('.repeat-text');
      const againText = document.querySelector('.again-text');
      
      [unlockEmoji, unlockText, portalText, portalEmoji, repeatText, againText].forEach(element => {
        if (element) {
          element.style.display = 'none';
          element.classList.remove('show');
        }
      });
      
      // 解锁所有效果选项
      const effectItems = document.querySelectorAll('.effect-item');
      effectItems.forEach(item => {
        item.classList.add('unlocked');
        const checkbox = item.querySelector('.checkbox');
        if (checkbox) checkbox.disabled = false;
      });
      
      // 激活最小化按钮
      const minimizeButton = document.querySelector('.title-button.minimize');
      minimizeButton.classList.add('active');
      
      // 初始化所有功能
      initDragAndDrop();
      initNotepad();
      
      // 显示记事本
      const journeyContent = document.getElementById('journey-content');
      journeyContent.classList.remove('hidden');
      const stage1 = document.querySelector('.journey-stage-1');
      stage1.style.opacity = '1';
      
      // 设置所有状态为已完成
      portalUnlocked = true;
      interactionCount = 4;
      isFirstRestore = false;  // 防止 Repeat/Again 提示显示
      portalShown = true;      // 防止 Portal Setup 提示显示
      
      // 移除相关事件监听器
      const minimizedIcon = document.querySelector('.minimized-icon');
      if (minimizedIcon) {
        minimizedIcon.removeEventListener('dblclick', showRepeatText);
      }
      if (portalEmoji) {
        portalEmoji.removeEventListener('click', unlockportalSetup);
      }
    }

    function initDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      const notepad = document.querySelector('.feather-outline');
      const titleBar = document.querySelector('.notepad-title');
      
      // 防止记事本窗口和标题栏接收拖放
      notepad.addEventListener('dragover', (e) => {
        if (e.target !== dropZone && !dropZone.contains(e.target)) {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      // 特别处理标题栏的拖放
      titleBar.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      titleBar.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      // 只允许内容区域接收拖放
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#f0f0f0';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = '#ffffff';
      });

      dropZone.addEventListener('drop', handleDrop);
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // 确保只有内容区域可以接收拖放
      const dropZone = document.getElementById('dropZone');
      if (e.target !== dropZone && !dropZone.contains(e.target)) {
        return;
      }

      dropZone.style.backgroundColor = '#ffffff';

      // 获取拖动的文本
      const text = e.dataTransfer.getData('text/plain');
      
      // 获取当前光标位置或末尾
      const selection = window.getSelection();
      let range;
      
      if (selection.rangeCount > 0) {
        range = selection.getRangeAt(0);
      } else {
        range = document.createRange();
        range.selectNodeContents(dropZone);
        range.collapse(false);
      }

      // 在光标位置插入文本
      const textNode = document.createTextNode(
        (dropZone.textContent ? '\n\n' : '') + text
      );
      range.insertNode(textNode);

      // 移动光标到插入文本的末尾
      range.setStartAfter(textNode);
      range.setEndAfter(textNode);
      selection.removeAllRanges();
      selection.addRange(range);

      // 移除原始拖动的文本
      const draggedText = document.querySelector('.text-fragment');
      if (draggedText && draggedText.textContent === text) {
      draggedText.remove();
      }

      // 显示下一段文本
      currentTextIndex++;
      showNextText();

      // 保持焦点
      dropZone.focus();
    }

    function showNextText() {
      if (currentTextIndex >= textSequence.length) {
        // 解锁菜单
        const starButton = document.querySelector('.star-button');
        starButton.classList.add('unlocked');
        
        // 解锁 COLOR 选项
        isColorUnlocked = true;
        const colorEffect = document.querySelector('.effect-item');
        colorEffect.classList.add('unlocked');
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.disabled = false;
        
        showUnlockEffects();
        startStage2();
        return;
      }

      const fragment = document.createElement('div');
      fragment.className = 'text-fragment';
      fragment.textContent = textSequence[currentTextIndex];
      fragment.draggable = true;
      
      // 随机位置
      const randomPosition = getRandomPosition();
      fragment.style.left = randomPosition.x + 'px';
      fragment.style.top = randomPosition.y + 'px';

      document.querySelector('.journey-stage-1').appendChild(fragment);

      // 添加拖拽事件
      fragment.addEventListener('dragstart', (e) => {
        e.stopPropagation();
        e.dataTransfer.setData('text/plain', fragment.textContent);
        e.target.style.opacity = '0.5';
      });

      fragment.addEventListener('dragend', (e) => {
        e.stopPropagation();
        e.target.style.opacity = '1';
      });

      fragment.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      setTimeout(() => fragment.classList.add('visible'), 100);
    }

    function getRandomPosition() {
      const padding = 50;
      const maxWidth = window.innerWidth - 400;
      const maxHeight = window.innerHeight - 100;
      
      // 避免生成在中央区域
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      let x, y;
      
      do {
        x = padding + Math.random() * (maxWidth - padding * 2);
      } while (Math.abs(x - centerX) < 300);
      
      do {
        y = padding + Math.random() * (maxHeight - padding * 2);
      } while (Math.abs(y - centerY) < 200);

      return { x, y };
    }

    function startStage2() {
      document.body.classList.add('stage-1');
      // 不再自动移除滤镜，等待用户点击礼物
    }

    function activateAllFeatures() {
      // 激活所有高级功能
      document.body.classList.add('stage-1', 'stage-2', 'stage-3');
      // 初始化生成器工具
      initNestGenerator();
      initDragAndDrop();
    }

    function initNestGenerator() {
      // 这里将实现最终的生成器工具功能
    }

    // 添加记事本初始化函数
    function initNotepad() {
      const dropZone = document.getElementById('dropZone');
      
      // 自动聚焦
      dropZone.focus();

      // 添加快捷键支持
      dropZone.addEventListener('keydown', (e) => {
        // Tab键支持
        if (e.key === 'Tab') {
          e.preventDefault();
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          const tabNode = document.createTextNode('    '); // 4个空格
          range.insertNode(tabNode);
          range.setStartAfter(tabNode);
          range.setEndAfter(tabNode);
          selection.removeAllRanges();
          selection.addRange(range);
        }
        
        // 在 Free Mode 下处理回车键
        if (currentMode === 'free' && e.key === 'Enter') {
          e.preventDefault(); // 阻止默认的换行行为
          
          // 获取当前输入的文本
          const text = dropZone.textContent.trim();
          console.log('Enter pressed, text:', text); // 添加日志
          
          // 如果文本不为空，执行搜索
          if (text) {
            // 获取最后一个单词
            const words = text.split(/\s+/);
            lastWord = words[words.length - 1].toLowerCase();
            console.log('Searching for word:', lastWord); // 添加日志
            
            // 执行搜索
            loadBirdImage();
          }
        }
      });

      // 处理输入事件
      dropZone.addEventListener('input', (e) => {
        if (currentMode === 'free') {
          // 获取当前输入的文本
          const text = dropZone.textContent.trim();
          
          // 如果文本为空，显示 placeholder
          if (!text) {
            dropZone.setAttribute('data-placeholder', 'Type any English word to search for related images');
          } else {
            dropZone.removeAttribute('data-placeholder');
          }
        }
      });
    }

    // 添加随机颜色生成函数
    function getRandomPastelColor() {
      // 生成柔和的颜色
      const hue = Math.floor(Math.random() * 360); // 随机色相
      const saturation = 30 + Math.random() * 20; // 30-50%的饱和度
      const lightness = 85 + Math.random() * 10; // 85-95%的亮度
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    // 修改 showUnlockEffects 函数
    function showUnlockEffects() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      const notepad = document.querySelector('.feather-outline');
      
      // 获取记事本的位置信息
      const notepadRect = notepad.getBoundingClientRect();
      const windowWidth = window.innerWidth;
      
      // 计算左右区域的中点
      const leftAreaCenter = notepadRect.left / 2;
      const rightAreaCenter = (windowWidth - notepadRect.right) / 2 + notepadRect.right;
      
      // 设置文字和emoji的位置
      text.style.left = `${leftAreaCenter}px`;
      emoji.style.right = `${windowWidth - rightAreaCenter}px`;
      
      // 显示元素
      text.classList.add('show');
      emoji.classList.add('show');

      // 添加点击事件
      emoji.addEventListener('click', unlockColors);
    }

    // 修改 unlockColors 函数
    function unlockColors() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      
      // 移除黑白滤镜
      document.body.style.transition = 'filter 1s ease, background-color 1s ease';
      document.body.style.filter = 'grayscale(0%)';
      
      // 设置随机背景色
      document.body.style.backgroundColor = getRandomPastelColor();
      
      // 移除提示元素
      emoji.style.visibility = 'hidden';
      text.style.visibility = 'hidden';
      
      // 解锁菜单
      isMenuUnlocked = true;
      const starButton = document.querySelector('.star-button');
      starButton.classList.add('unlocked');
      
      // 解锁 COLOR 选项
      isColorUnlocked = true;
      const colorEffect = document.querySelector('.effect-item');
      colorEffect.classList.add('unlocked');
      const checkbox = colorEffect.querySelector('.checkbox');
      checkbox.disabled = false;
      
      // 激活最小化按钮
      const minimizeButton = document.querySelector('.title-button.minimize');
      minimizeButton.classList.add('active');
      
      // 移除点击事件，防止重复触发
      emoji.removeEventListener('click', unlockColors);
    }

    // 添加位置检查和调整函数
    function adjustSubmenuPosition() {
      const submenu = document.querySelector('.color-submenu');
      if (!submenu || submenu.style.display === 'none') return;

      const rect = submenu.getBoundingClientRect();
      const windowHeight = window.innerHeight;

      // 检查是否超出视窗底部
      if (rect.bottom > windowHeight) {
        // 调整位置，确保在视窗内
        submenu.style.top = 'auto';
        submenu.style.bottom = '20px';
        submenu.style.transform = 'none';
      }
    }

    // 修改颜色控制逻辑
    function initializeColorControl() {
      const colorEffect = document.querySelector('.effect-item');
      const colorSubmenu = document.querySelector('.color-submenu');
      const portalEffect = document.querySelector('.effect-item:nth-child(3)');
      const portalSubmenu = document.querySelector('.portal-submenu');
      const modeOptions = document.querySelectorAll('.mode-option');
      const hueSlider = document.getElementById('hueSlider');
      const brightnessSlider = document.getElementById('brightnessSlider');
      const saturationSlider = document.getElementById('saturationSlider');
      let isColorChecked = false;
      let isportalChecked = false;

      // 初始化模式选项的点击事件
      modeOptions.forEach(option => {
        option.addEventListener('click', () => {
          const mode = option.dataset.mode;
          if (mode === currentMode) return; // 如果点击当前模式，不做任何事

          // 更新复选框状态
          modeOptions.forEach(opt => {
            const checkbox = opt.querySelector('.checkbox');
            if (opt.dataset.mode === mode) {
              checkbox.textContent = '[*]';
              opt.classList.add('checked');
            } else {
              checkbox.textContent = '[ ]';
              opt.classList.remove('checked');
            }
          });

          // 设置待切换的模式
          pendingMode = mode;
        });
      });

      // 点击 COLOR 选项的处理
      colorEffect.addEventListener('click', (e) => {
        if (!colorEffect.classList.contains('unlocked')) return;

        isColorChecked = !isColorChecked;
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.textContent = isColorChecked ? '[*]' : '[ ]';
        colorEffect.classList.toggle('checked');
        colorSubmenu.style.display = isColorChecked ? 'block' : 'none';
        
        // 如果 portal 菜单打开，则关闭它
        if (isColorChecked && isportalChecked) {
          isportalChecked = false;
          const portalCheckbox = portalEffect.querySelector('.checkbox');
          portalCheckbox.textContent = '[ ]';
          portalEffect.classList.remove('checked');
          portalSubmenu.style.display = 'none';
        }
      });

      // 点击 portal SETUP 选项的处理
      portalEffect.addEventListener('click', (e) => {
        if (!portalEffect.classList.contains('unlocked')) return;

        isportalChecked = !isportalChecked;
        const checkbox = portalEffect.querySelector('.checkbox');
        checkbox.textContent = isportalChecked ? '[*]' : '[ ]';
        portalEffect.classList.toggle('checked');
        portalSubmenu.style.display = isportalChecked ? 'block' : 'none';
        
        // 如果 Color 菜单打开，则关闭它
        if (isportalChecked && isColorChecked) {
          isColorChecked = false;
          const colorCheckbox = colorEffect.querySelector('.checkbox');
          colorCheckbox.textContent = '[ ]';
          colorEffect.classList.remove('checked');
          colorSubmenu.style.display = 'none';
        }
      });

      // 滑块控制颜色
      function updateColor() {
        const hue = hueSlider.value;
        const brightness = brightnessSlider.value;
        const saturation = saturationSlider.value;
        
        document.body.style.backgroundColor = 
          `hsl(${hue}, ${saturation}%, ${brightness}%)`;
      }

      // 添加滑块事件监听
      hueSlider.addEventListener('input', updateColor);
      brightnessSlider.addEventListener('input', updateColor);
      saturationSlider.addEventListener('input', updateColor);
    }

    // 修改星号按钮的初始化
    function initializeMenu() {
      const starButton = document.querySelector('.star-button');
      const menu = document.querySelector('.effects-menu');
      let isMenuOpen = false;

      starButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!isMenuUnlocked) return;

        isMenuOpen = !isMenuOpen;
        menu.style.display = isMenuOpen ? 'block' : 'none';
      });

      document.addEventListener('click', (e) => {
        if (isMenuOpen && !menu.contains(e.target)) {
          isMenuOpen = false;
          menu.style.display = 'none';
        }
      });

      initializeColorControl();
    }

    // 添加窗口大小改变时的位置调整
    window.addEventListener('resize', adjustSubmenuPosition);

    // 添加最小化功能相关的代码
    function initializeMinimize() {
      const minimizeButton = document.querySelector('.title-button');
      const notepad = document.querySelector('.feather-outline');
      const minimizedIcon = document.querySelector('.minimized-icon');
      const dropZone = document.getElementById('dropZone');
      const repeatText = document.querySelector('.repeat-text');
      const againText = document.querySelector('.again-text');
      const portalText = document.querySelector('.portal-text');
      const portalEmoji = document.querySelector('.portal-emoji');
      let isFirstRestore = true;
      let interactionCount = 0;
      let portalUnlocked = false;
      let portalShown = false;
      
      // 初始状态设置为禁用
      minimizeButton.classList.add('minimize');

      // 在解锁颜色时激活最小化按钮
      function activateMinimizeButton() {
        minimizeButton.classList.add('active');
      }

      // 获取随机鸟类图片
      async function getRandomBirdImage() {
        const randomBird = birds[Math.floor(Math.random() * birds.length)];
        try {
          // 使用更可靠的 REST API 端点，添加更大的图片尺寸
          const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${randomBird}`;
          
          console.log('Fetching image for:', randomBird); // 调试日志
          const response = await fetch(url);
          if (!response.ok) throw new Error('Network response was not ok');
          
          const data = await response.json();
          console.log('API response:', data); // 调试日志
          
          // 如果没有缩略图，尝试获取原始图片
          if (!data.originalimage && (!data.thumbnail || !data.thumbnail.source)) {
            throw new Error('No image found');
          }
          
          // 优先使用原始图片，如果没有则使用缩略图
          const imageUrl = data.originalimage ? data.originalimage.source : data.thumbnail.source;
          
          // 预加载图片
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(imageUrl);
            img.onerror = () => reject(new Error('Failed to load image'));
            img.src = imageUrl;
          });
        } catch (error) {
          console.error('Error fetching bird image:', error);
          return null;
        }
      }

      // 显示重复提示
      function showRepeatText() {
        // 确保元素可见
        repeatText.style.display = 'block';
        againText.style.display = 'block';
        
        // 添加show类触发过渡效果
        setTimeout(() => {
          repeatText.classList.add('show');
          againText.classList.add('show');
        }, 50);
      }

      // 隐藏重复提示
      function hideRepeatText() {
        repeatText.classList.remove('show');
        againText.classList.remove('show');
        
        // 等待过渡效果完成后隐藏元素
        setTimeout(() => {
          repeatText.style.display = 'none';
          againText.style.display = 'none';
        }, 500);
      }

      // 显示炼金术解锁提示
      function showportalUnlock() {
        if (!portalShown) {
          // 确保元素可见
          portalText.style.display = 'block';
          portalEmoji.style.display = 'block';
          
          // 添加show类触发过渡效果
          setTimeout(() => {
            portalText.classList.add('show');
            portalEmoji.classList.add('show');
          }, 50);
          
          portalShown = true;

          // 添加点击事件来解锁 portal SETUP 选项
          portalEmoji.style.pointerEvents = 'auto'; // 确保可以点击
          portalEmoji.addEventListener('click', unlockportalSetup);
        }
      }

      // 隐藏炼金术解锁提示
      function hideportalUnlock() {
        if (portalShown) {
          portalText.classList.remove('show');
          portalEmoji.classList.remove('show');
          
          setTimeout(() => {
            portalText.style.display = 'none';
            portalEmoji.style.display = 'none';
          }, 500);
          
          portalShown = false;
        }
      }

      // 修改解锁 portal SETUP 的函数
      function unlockportalSetup() {
        console.log('Unlocking portal Setup...'); // 添加调试日志
        
        // 获取所有 effect-item 元素
        const effectItems = document.querySelectorAll('.effect-item');
        // portal SETUP 是第三个选项
        const portalEffect = effectItems[2];
        
        if (portalEffect) {
          console.log('Found portal Setup option'); // 添加调试日志
          
          // 解锁选项
          portalEffect.classList.add('unlocked');
          const checkbox = portalEffect.querySelector('.checkbox');
          if (checkbox) {
            checkbox.disabled = false;
          }
          
          // 隐藏解锁提示
          hideportalUnlock();
          
          // 移除点击事件，防止重复触发
          portalEmoji.removeEventListener('click', unlockportalSetup);
        } else {
          console.log('portal Setup option not found'); // 添加调试日志
        }
      }

      // 检查交互次数
      function checkInteractions() {
        // 只在最小化时增加计数
        if (notepad.style.display === 'none') {
          interactionCount++;
          console.log('Interaction count:', interactionCount);
          
          if (interactionCount === 3 && !portalUnlocked) {
            portalUnlocked = true;
            showportalUnlock();
          }
          // 移除在第四次交互时自动隐藏提示的逻辑
        }
      }

      // 最小化动画
      function minimizeNotepad() {
        if (!minimizeButton.classList.contains('active')) return;
        notepad.style.display = 'none';
        minimizedIcon.style.display = 'block';
        hideRepeatText();
        checkInteractions();
      }

      // 修改加载图片的函数
      async function loadBirdImage() {
        console.log('Loading image in mode:', currentMode);
        
        try {
          if (currentMode === 'bird') {
            // Bird Mode 的逻辑保持不变
            dropZone.innerHTML = 'Loading image...';
            dropZone.style.padding = '10px';
          const imageUrl = await getRandomBirdImage();
          
          if (imageUrl) {
            dropZone.style.padding = '0';
            dropZone.innerHTML = '';
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
              max-width: 100%;
              height: auto;
              display: block;
              margin: 0 auto;
              object-fit: contain;
            `;
            dropZone.appendChild(img);
            
            if (isFirstRestore) {
              showRepeatText();
              isFirstRestore = false;
            }
            }
          } else if (currentMode === 'free') {
            // Free Mode 改为图片上传功能
            if (dropZone.querySelector('.upload-container') === null) {
              // 清空内容
              dropZone.innerHTML = '';
              dropZone.style.padding = '20px';
              
              // 创建上传容器
              const uploadContainer = document.createElement('div');
              uploadContainer.className = 'upload-container';
              uploadContainer.style.cssText = `
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                width: 100%;
                height: 100%;
                min-height: 200px;
                border: 2px dashed #999;
                border-radius: 5px;
                padding: 20px;
                box-sizing: border-box;
              `;
              
              // 添加提示文本
              const uploadText = document.createElement('div');
              uploadText.textContent = 'Drop image here or click to upload';
              uploadText.style.cssText = `
                font-size: 16px;
                color: #666;
                text-align: center;
              `;
              
              // 添加文件输入框
              const fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.style.display = 'none';
              
              // 添加上传按钮
              const uploadButton = document.createElement('button');
              uploadButton.textContent = 'Choose File';
              uploadButton.style.cssText = `
                padding: 8px 16px;
                background: none;
                border: 1px solid #666;
                border-radius: 4px;
                cursor: pointer;
                font-family: monospace;
                transition: all 0.3s ease;
              `;
              
              uploadButton.addEventListener('mouseover', () => {
                uploadButton.style.background = '#000';
                uploadButton.style.color = '#fff';
              });
              
              uploadButton.addEventListener('mouseout', () => {
                uploadButton.style.background = 'none';
                uploadButton.style.color = '#000';
              });
              
              // 处理文件选择
              fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.cssText = `
                      max-width: 100%;
                      height: auto;
                      display: block;
                      margin: 20px auto;
                      object-fit: contain;
                    `;
                    dropZone.innerHTML = '';
                    dropZone.style.padding = '0';
                    dropZone.appendChild(img);
                  };
                  reader.readAsDataURL(file);
                }
              });
              
              // 处理拖放
              uploadContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadContainer.style.borderColor = '#000';
                uploadContainer.style.background = 'rgba(0,0,0,0.05)';
              });
              
              uploadContainer.addEventListener('dragleave', () => {
                uploadContainer.style.borderColor = '#999';
                uploadContainer.style.background = 'none';
              });
              
              uploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadContainer.style.borderColor = '#999';
                uploadContainer.style.background = 'none';
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                  const reader = new FileReader();
                  reader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.cssText = `
                      max-width: 100%;
                      height: auto;
                      display: block;
                      margin: 20px auto;
                      object-fit: contain;
                    `;
                    dropZone.innerHTML = '';
                    dropZone.style.padding = '0';
                    dropZone.appendChild(img);
                  };
                  reader.readAsDataURL(file);
                }
              });
              
              // 点击按钮触发文件选择
              uploadButton.addEventListener('click', () => {
                fileInput.click();
              });
              
              // 组装上传界面
              uploadContainer.appendChild(uploadText);
              uploadContainer.appendChild(uploadButton);
              uploadContainer.appendChild(fileInput);
              dropZone.appendChild(uploadContainer);
            }
          }
        } catch (error) {
          console.error('Error displaying content:', error);
          if (currentMode === 'bird') {
            dropZone.innerHTML = 'Failed to load image';
          dropZone.style.padding = '10px';
          }
        }
      }

      // 还原记事本
      async function restoreNotepad() {
        minimizedIcon.style.display = 'none';
        notepad.style.display = 'flex';
        
        // 应用待切换的模式
        if (pendingMode !== currentMode) {
          currentMode = pendingMode;
          console.log('Mode switched to:', currentMode);
        }
        
        // 根据当前模式加载内容
        await loadBirdImage();
      }

      // 添加拖拽功能
      let isDragging = false;
      let currentX;
      let currentY;
      let initialX;
      let initialY;
      let xOffset = 0;
      let yOffset = 0;

      function dragStart(e) {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;

        if (e.target === minimizedIcon) {
          isDragging = true;
          minimizedIcon.classList.add('dragging');
        }
      }

      function dragEnd() {
        initialX = currentX;
        initialY = currentY;
        isDragging = false;
        minimizedIcon.classList.remove('dragging');
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          currentX = e.clientX - initialX;
          currentY = e.clientY - initialY;
          xOffset = currentX;
          yOffset = currentY;

          minimizedIcon.style.transform = `translate(${currentX}px, ${currentY}px)`;
        }
      }

      // 添加事件监听
      minimizedIcon.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);
      minimizeButton.addEventListener('click', minimizeNotepad);
      minimizedIcon.addEventListener('dblclick', restoreNotepad);
    }

    // 修改获取维基百科图片的函数
    async function getWikiImage(searchTerm) {
      console.log('Searching for:', searchTerm);
      try {
        const url = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(searchTerm)}`;
        console.log('API URL:', url);
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('No entry found');
        }
        
        const data = await response.json();
        console.log('API response:', data);
        
        if (!data.thumbnail || !data.thumbnail.source) {
          throw new Error('No image found');
        }
        
        // 返回图片 URL 和描述文本
        return {
          imageUrl: data.thumbnail.source,
          title: data.title,
          extract: data.extract
        };
      } catch (error) {
        console.error('Error fetching wiki image:', error);
        return null;
      }
    }

    // 修改记事本拖拽功能的脚本
    function initNotepadDrag() {
      const notepad = document.querySelector('.feather-outline');
      const titleBar = document.querySelector('.notepad-title');
      let isDragging = false;
      let startX;
      let startY;
      let notepadX;
      let notepadY;

      function dragStart(e) {
        if (e.target.closest('.notepad-title-buttons')) return;
        
        // 获取记事本当前位置
        const rect = notepad.getBoundingClientRect();
        notepadX = rect.left;
        notepadY = rect.top;
        
        // 获取鼠标起始位置
        startX = e.clientX;
        startY = e.clientY;

        if (e.target.closest('.notepad-title')) {
          isDragging = true;
          notepad.classList.add('dragging');
          
          // 移除transform，改用top和left定位
          notepad.style.transform = 'none';
          notepad.style.left = notepadX + 'px';
          notepad.style.top = notepadY + 'px';
        }
      }

      function dragEnd() {
        isDragging = false;
        notepad.classList.remove('dragging');
      }

      function drag(e) {
        if (isDragging) {
          e.preventDefault();
          
          // 计算移动距离
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;
          
          // 更新记事本位置
          let newX = notepadX + dx;
          let newY = notepadY + dy;
          
          // 获取记事本和窗口尺寸
          const rect = notepad.getBoundingClientRect();
          const maxX = window.innerWidth - rect.width;
          const maxY = window.innerHeight - rect.height;
          
          // 确保记事本不会完全移出视窗
          newX = Math.max(-rect.width / 2, Math.min(newX, maxX + rect.width / 2));
          newY = Math.max(-rect.height / 2, Math.min(newY, maxY + rect.height / 2));
          
          notepad.style.left = newX + 'px';
          notepad.style.top = newY + 'px';
        }
      }

      titleBar.addEventListener('mousedown', dragStart);
      document.addEventListener('mousemove', drag);
      document.addEventListener('mouseup', dragEnd);

      // 处理窗口大小变化
      window.addEventListener('resize', () => {
        const rect = notepad.getBoundingClientRect();
        const maxX = window.innerWidth - rect.width;
        const maxY = window.innerHeight - rect.height;
        
        // 如果记事本超出视窗，调整位置
        if (rect.right > window.innerWidth || rect.bottom > window.innerHeight) {
          let newX = parseFloat(notepad.style.left);
          let newY = parseFloat(notepad.style.top);
          
          if (rect.right > window.innerWidth) {
            newX = Math.max(0, maxX);
          }
          if (rect.bottom > window.innerHeight) {
            newY = Math.max(0, maxY);
          }
          
          notepad.style.left = newX + 'px';
          notepad.style.top = newY + 'px';
        }
      });
    }

    // 修改图片加载函数
    function handleImageLoad(img) {
      const maxWidth = window.innerWidth * 0.8;  // 80% 的视窗宽度
      const maxHeight = window.innerHeight * 0.7;  // 70% 的视窗高度

      const ratio = Math.min(
        maxWidth / img.naturalWidth,
        maxHeight / img.naturalHeight,
        1  // 不要放大图片
      );

      img.style.width = `${img.naturalWidth * ratio}px`;
      img.style.height = `${img.naturalHeight * ratio}px`;
    }

    // 修改字符网格系统的脚本
    class CharacterGrid {
      constructor() {
        this.container = document.createElement('div');
        this.container.className = 'character-grid';
        document.body.appendChild(this.container);
        
        this.cells = new Map();
        this.activeCellPos = null;
        this.cellSize = 8;
        
        this.setupEventListeners();
        this.createInitialGrid();
        
        // 初始化 Firebase 监听
        if (window.firebaseRef) {
          this.initializeFirebase();
        } else {
          console.warn('Waiting for Firebase to initialize...');
          const checkInterval = setInterval(() => {
            if (window.firebaseRef) {
              console.log('Firebase now available, initializing...');
              this.initializeFirebase();
              clearInterval(checkInterval);
            }
          }, 100);
          
          // 设置超时，避免无限等待
          setTimeout(() => {
            clearInterval(checkInterval);
            console.error('Firebase initialization timeout');
          }, 5000);
        }
      }

      initializeFirebase() {
        try {
          console.log('Setting up Firebase listeners...');
          if (!window.firebaseRef) {
            console.error('Firebase reference not available');
            return;
          }

          // 使用 window.onValue 而不是直接使用 onValue
          window.onValue(window.firebaseRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
              Object.entries(data).forEach(([key, value]) => {
                if (value === null) return; // 跳过已删除的节点
                
                const [x, y] = key.split(',').map(Number);
                const cell = this.getCell(x, y);
                
                if (value.char) cell.textContent = value.char;
                if (value.backgroundColor) cell.style.backgroundColor = value.backgroundColor;
              });
            }
          }, (error) => {
            if (error.code === 'PERMISSION_DENIED') {
              console.error('Firebase permission denied. Please check database rules.');
              alert('Permission denied. Please check Firebase database rules.');
            } else {
              console.error('Firebase onValue error:', error);
            }
          });
        } catch (error) {
          console.error('Error in initializeFirebase:', error);
        }
      }

      async updateCell(x, y, char, backgroundColor, shouldSync = true) {
        try {
          const cell = this.getCell(x, y);
          
          // 更新本地显示
          if (char !== null) cell.textContent = char;
          if (backgroundColor !== null) cell.style.backgroundColor = backgroundColor;
          
          // 同步到 Firebase
          if (shouldSync && window.firebaseRef && window.firebaseUpdate) {
            const key = `${x},${y}`;
            const updates = {};
            
            // 只保存非空值
            if (char !== null || backgroundColor !== null) {
              updates[key] = {
                char: char || cell.textContent,
                backgroundColor: backgroundColor || cell.style.backgroundColor || 'transparent'
              };
              
              // 如果数据为空，则删除该节点
              if (!updates[key].char && (!updates[key].backgroundColor || updates[key].backgroundColor === 'transparent')) {
                updates[key] = null;
              }
              
              try {
                await window.firebaseUpdate(window.firebaseRef, updates);
                console.log('Cell updated successfully:', key);
              } catch (error) {
                if (error.code === 'PERMISSION_DENIED') {
                  console.error('Firebase permission denied. Please check database rules.');
                  alert('Permission denied. Please check Firebase database rules.');
                } else {
                  console.error('Failed to update Firebase:', error);
                }
              }
            }
          }
        } catch (error) {
          console.error('Error in updateCell:', error);
        }
      }

      // 修改 setCharacter 方法
      setCharacter(x, y, char) {
        this.updateCell(x, y, char, null, true);
      }

      // 修改 setCellBackground 方法
      setCellBackground(x, y, color) {
        this.updateCell(x, y, null, color, true);
      }

      // 新增 updateCell 方法
      updateCell(x, y, char, backgroundColor, shouldSync = true) {
        const cell = this.getCell(x, y);
        const key = `${x},${y}`;
        
        // 更新本地显示
        if (char !== null) cell.textContent = char;
        if (backgroundColor !== null) cell.style.backgroundColor = backgroundColor;
        
        // 同步到 Firebase
        if (shouldSync && window.firebaseRef && window.firebaseUpdate) {
          const updates = {};
          updates[key] = {
            char: char !== null ? char : cell.textContent,
            backgroundColor: backgroundColor !== null ? backgroundColor : cell.style.backgroundColor || 'transparent'
          };
          window.firebaseUpdate(window.firebaseRef, updates).catch(error => {
            console.error('Failed to update Firebase:', error);
          });
        }
      }

      // 修改 clearCellBackground 方法
      clearCellBackground(x, y) {
        this.updateCell(x, y, null, 'transparent', true);
      }

      createInitialGrid() {
        const viewportWidth = Math.ceil(window.innerWidth / this.cellSize);
        const viewportHeight = Math.ceil(window.innerHeight / this.cellSize);
        
        for (let y = 0; y < viewportHeight; y++) {
          for (let x = 0; x < viewportWidth; x++) {
            this.getCell(x, y);
          }
        }
        
        // 添加窗口大小改变时重新创建网格的处理
        window.addEventListener('resize', () => {
          this.createInitialGrid();
        });
      }

      setupEventListeners() {
        // 添加拖放事件监听
        this.container.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'copy';
        });

        this.container.addEventListener('drop', (e) => this.handleGridDrop(e));

        // 点击事件处理
        document.addEventListener('click', (e) => {
          const skipElements = [
            '.feather-outline',
            '.effects-menu',
            '.color-submenu',
            '.portal-submenu',
            '.start-button',
            '.skip-link',
            '.unlock-emoji',
            '.minimized-icon'
          ];

          for (const selector of skipElements) {
            if (e.target.closest(selector)) return;
          }

          const { x, y } = this.positionToGrid(e.clientX, e.clientY);
          
          if (this.activeCellPos) {
            this.getCell(this.activeCellPos.x, this.activeCellPos.y).classList.remove('active');
          }
          this.activeCellPos = { x, y };
          this.getCell(x, y).classList.add('active');
        });

        // 键盘输入处理
        document.addEventListener('keypress', (e) => {
          if (!this.activeCellPos || 
              document.activeElement.tagName === 'INPUT' || 
              document.activeElement.tagName === 'TEXTAREA' ||
              e.target.closest('.feather-outline')) {
            return;
          }
          
          const char = String.fromCharCode(e.keyCode);
          this.setCharacter(this.activeCellPos.x, this.activeCellPos.y, char);
          this.moveCursor(1, 0); // 向右移动一格
        });

        // 方向键和退格键处理
        document.addEventListener('keydown', (e) => {
          if (!this.activeCellPos || 
              document.activeElement.tagName === 'INPUT' || 
              document.activeElement.tagName === 'TEXTAREA' ||
              e.target.closest('.feather-outline')) {
            return;
          }
          
          switch(e.key) {
            case 'ArrowLeft':
              e.preventDefault();
              this.moveCursor(-1, 0);
              break;
            case 'ArrowRight':
              e.preventDefault();
              this.moveCursor(1, 0);
              break;
            case 'ArrowUp':
              e.preventDefault();
              this.moveCursor(0, -1);
              break;
            case 'ArrowDown':
              e.preventDefault();
              this.moveCursor(0, 1);
              break;
            case 'Backspace':
              e.preventDefault();
              this.setCharacter(this.activeCellPos.x, this.activeCellPos.y, '');
              this.moveCursor(-1, 0);
              break;
          }
        });
      }

      handleGridDrop(e) {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (!file || !file.type.startsWith('image/')) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => this.processImage(img, Math.floor(e.clientX / this.cellSize), Math.floor(e.clientY / this.cellSize));
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }

      processImage(img, startX, startY) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // 设置合适的尺寸以保持图片比例
        const maxWidth = 50; // 最大字符宽度
        const scale = maxWidth / img.width;
        const width = Math.floor(img.width * scale);
        const height = Math.floor(img.height * scale);
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        
        const imageData = ctx.getImageData(0, 0, width, height);
        const data = imageData.data;
        
        // 遍历像素并转换为字符
        for (let y = 0; y < height; y++) {
          for (let x = 0; x < width; x++) {
            const i = (y * width + x) * 4;
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // 计算亮度 (0-255)
            const brightness = Math.floor((r + g + b) / 3);
            
            // 将亮度映射到ASCII字符
            const charIndex = Math.floor(brightness / 256 * this.asciiRamp.length);
            const char = this.asciiRamp[charIndex];
            
            // 在网格中设置字符
            this.setCharacter(startX + x, startY + y, char);
          }
        }
      }

      createCell(x, y) {
        const cell = document.createElement('div');
        cell.className = 'grid-cell';
        cell.style.left = `${x * this.cellSize}px`;
        cell.style.top = `${y * this.cellSize}px`;
        this.container.appendChild(cell);
        return cell;
      }

      getCell(x, y) {
        const key = `${x},${y}`;
        if (!this.cells.has(key)) {
          this.cells.set(key, this.createCell(x, y));
        }
        return this.cells.get(key);
      }

      positionToGrid(clientX, clientY) {
        const rect = this.container.getBoundingClientRect();
        const x = Math.floor((clientX - rect.left) / this.cellSize);
        const y = Math.floor((clientY - rect.top) / this.cellSize);
        return { x, y };
      }

      moveCursor(dx, dy) {
        if (!this.activeCellPos) return;
        
        this.getCell(this.activeCellPos.x, this.activeCellPos.y).classList.remove('active');
        this.activeCellPos.x += dx;
        this.activeCellPos.y += dy;
        
        // 确保坐标不为负
        this.activeCellPos.x = Math.max(0, this.activeCellPos.x);
        this.activeCellPos.y = Math.max(0, this.activeCellPos.y);
        
        this.getCell(this.activeCellPos.x, this.activeCellPos.y).classList.add('active');
      }

      // 添加设置彩色字符的方法
      setColoredCharacter(x, y, color, char = null) {
        const cell = this.getCell(x, y);
        if (!char) {
          // 如果没有指定字符，使用随机字符
          char = this.randomChars[Math.floor(Math.random() * this.randomChars.length)];
        }
        cell.textContent = char;
        cell.style.color = color;
      }
    }

    // 添加 Alchemy Furnace 功能
    function createAlchemyFurnace(imgSrc) {
      const furnace = document.createElement('div');
      furnace.className = 'alchemy-furnace';
      furnace.style.position = 'fixed';
      
      // 创建标题栏，添加 Apply 按钮
      const titleBar = document.createElement('div');
      titleBar.className = 'alchemy-title';
      titleBar.innerHTML = `
        <span>Alchemy Furnace</span>
        <div style="display: flex; align-items: center;">
          <button class="apply-button">
            <span class="checkbox">[ ]</span>
            <span>Apply</span>
          </button>
          <div class="notepad-title-buttons">
            <button class="title-button minimize">_</button>
            <button class="title-button maximize">□</button>
            <button class="title-button close">×</button>
          </div>
        </div>
      `;

      // 创建内容区域
      const content = document.createElement('div');
      content.className = 'alchemy-content';
      
      // 创建图片元素
      const img = document.createElement('img');
      img.src = imgSrc;
      content.appendChild(img);

      // 组装窗口
      furnace.appendChild(titleBar);
      furnace.appendChild(content);
      
      // 添加调整大小的手柄
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'resize-handle bottom-right';
      furnace.appendChild(resizeHandle);

      // 窗口状态
      const state = {
        isDragging: false,
        isResizing: false,
        startX: 0,
        startY: 0,
        furnaceX: 0,
        furnaceY: 0,
        startWidth: 0,
        startHeight: 0,
        seamCarver: null,
        isApplied: false
      };

      // 初始化 SeamCarver
      const initSeamCarver = () => {
        const tempCanvas = document.createElement('canvas');
        const tctx = tempCanvas.getContext('2d');
        const imgEl = furnace.querySelector('img');

        const MAX_SIZE = 800;
        let scaleFactor = 1;
        if (imgEl.naturalWidth > MAX_SIZE || imgEl.naturalHeight > MAX_SIZE) {
          scaleFactor = MAX_SIZE / Math.max(imgEl.naturalWidth, imgEl.naturalHeight);
          tempCanvas.width = imgEl.naturalWidth * scaleFactor;
          tempCanvas.height = imgEl.naturalHeight * scaleFactor;
        } else {
          tempCanvas.width = imgEl.naturalWidth;
          tempCanvas.height = imgEl.naturalHeight;
        }

        tctx.drawImage(imgEl, 0, 0, tempCanvas.width, tempCanvas.height);
        const imageData = tctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);

        state.seamCarver = new window.SeamCarver(imageData);
        state.seamCarver.scaleFactor = scaleFactor;
      };

      // 拖拽功能
      titleBar.addEventListener('mousedown', (e) => {
        if (e.target.closest('.notepad-title-buttons')) return;
        
        e.preventDefault();
        e.stopPropagation();
        state.isDragging = true;
        furnace.classList.add('dragging');
        
        const rect = furnace.getBoundingClientRect();
        state.furnaceX = rect.left;
        state.furnaceY = rect.top;
        state.startX = e.clientX;
        state.startY = e.clientY;
      });

      // 调整大小功能
      resizeHandle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        state.isResizing = true;
        
        const rect = furnace.getBoundingClientRect();
        state.startX = e.clientX;
        state.startY = e.clientY;
        state.startWidth = rect.width;
        state.startHeight = rect.height;

        // 确保 SeamCarver 已初始化
        if (!state.seamCarver) {
          initSeamCarver();
        }
      });

      // 处理鼠标移动
      const handleMouseMove = (e) => {
        if (state.isDragging) {
          const dx = e.clientX - state.startX;
          const dy = e.clientY - state.startY;
          
          let newX = state.furnaceX + dx;
          let newY = state.furnaceY + dy;
          
          // 限制窗口不完全移出视图
          const rect = furnace.getBoundingClientRect();
          const maxX = window.innerWidth - rect.width / 2;
          const maxY = window.innerHeight - rect.height / 2;
          const minX = -rect.width / 2;
          const minY = -rect.height / 2;
          
          newX = Math.max(minX, Math.min(maxX, newX));
          newY = Math.max(minY, Math.min(maxY, newY));
          
          furnace.style.left = `${newX}px`;
          furnace.style.top = `${newY}px`;
        }
        
        if (state.isResizing && state.seamCarver) {
          const dx = e.clientX - state.startX;
          const dy = e.clientY - state.startY;
          
          const minWidth = 50;
          const maxWidth = window.innerWidth * 0.9;
          const newWidth = Math.max(minWidth, Math.min(maxWidth, state.startWidth + dx));
          
          const minHeight = 50;
          const maxHeight = window.innerHeight * 0.9;
          const newHeight = Math.max(minHeight, Math.min(maxHeight, state.startHeight + dy));
          
          furnace.style.width = `${newWidth}px`;
          furnace.style.height = `${newHeight}px`;
          
          const imgEl = furnace.querySelector('img');
          const targetWidth = Math.floor(newWidth * state.seamCarver.scaleFactor);
          const scaled = state.seamCarver.resize(targetWidth);
          const resultCanvas = document.createElement('canvas');
          resultCanvas.width = scaled.width;
          resultCanvas.height = scaled.height;
          resultCanvas.getContext('2d').putImageData(scaled, 0, 0);
          imgEl.src = resultCanvas.toDataURL();
        }
      };

      // 处理鼠标抬起
      const handleMouseUp = () => {
        if (state.isDragging || state.isResizing) {
          state.isDragging = false;
          state.isResizing = false;
          furnace.classList.remove('dragging');
        }
      };

      // 添加事件监听器
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      // 图片加载完成后初始化 SeamCarver
      img.onload = initSeamCarver;

      // 添加 Apply 功能
      const applyButton = titleBar.querySelector('.apply-button');
      const checkbox = applyButton.querySelector('.checkbox');
      
      const applyImageToGrid = () => {
        const rect = furnace.getBoundingClientRect();
        const furnaceContent = furnace.querySelector('.alchemy-content');
        const contentRect = furnaceContent.getBoundingClientRect();
        
        // 确保 SeamCarver 已初始化并处理了当前尺寸
        if (!state.seamCarver) {
          initSeamCarver();
        }
        
        // 使用 SeamCarver 处理后的图像数据
        const targetWidth = Math.floor(contentRect.width * state.seamCarver.scaleFactor);
        const processedImageData = state.seamCarver.resize(targetWidth);
        
        // 创建临时 canvas 显示处理后的图像
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = contentRect.width;
        canvas.height = contentRect.height;
        
        // 创建临时 canvas 存放 SeamCarver 处理后的数据
        const processedCanvas = document.createElement('canvas');
        const processedCtx = processedCanvas.getContext('2d');
        processedCanvas.width = processedImageData.width;
        processedCanvas.height = processedImageData.height;
        processedCtx.putImageData(processedImageData, 0, 0);
        
        // 将处理后的图像绘制到最终尺寸
        ctx.drawImage(processedCanvas, 0, 0, contentRect.width, contentRect.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // 计算网格起始位置
        const startGridX = Math.floor((rect.left + window.scrollX) / window.grid.cellSize);
        const startGridY = Math.floor((rect.top + window.scrollY) / window.grid.cellSize);
        
        // 计算每个网格单元对应的像素区域
        const pixelsPerCell = window.grid.cellSize;
        
        // 遍历图片区域
        for (let y = 0; y < contentRect.height; y += pixelsPerCell) {
          for (let x = 0; x < contentRect.width; x += pixelsPerCell) {
            // 计算当前网格单元对应的像素区域的平均颜色
            let r = 0, g = 0, b = 0, a = 0;
            let count = 0;
            
            // 计算区域平均颜色
            for (let py = y; py < Math.min(y + pixelsPerCell, contentRect.height); py++) {
              for (let px = x; px < Math.min(x + pixelsPerCell, contentRect.width); px++) {
                const i = (py * imageData.width + px) * 4;
                r += imageData.data[i];
                g += imageData.data[i + 1];
                b += imageData.data[i + 2];
                a += imageData.data[i + 3];
                count++;
              }
            }
            
            // 计算平均值
            r = Math.round(r / count);
            g = Math.round(g / count);
            b = Math.round(b / count);
            a = Math.round(a / count);
            
            // 设置网格单元背景色
            if (a > 0) { // 只处理非完全透明的像素
              const color = `rgba(${r},${g},${b},${a/255})`;
              const gridX = startGridX + Math.floor(x / pixelsPerCell);
              const gridY = startGridY + Math.floor(y / pixelsPerCell);
              window.grid.setCellBackground(gridX, gridY, color);
            }
          }
        }
      };

      const removeImageFromGrid = () => {
        const rect = furnace.getBoundingClientRect();
        const furnaceContent = furnace.querySelector('.alchemy-content');
        const contentRect = furnaceContent.getBoundingClientRect();
        
        const startGridX = Math.floor((rect.left + window.scrollX) / window.grid.cellSize);
        const startGridY = Math.floor((rect.top + window.scrollY) / window.grid.cellSize);
        const gridWidth = Math.ceil(contentRect.width / window.grid.cellSize);
        const gridHeight = Math.ceil(contentRect.height / window.grid.cellSize);
        
        // 清除对应区域的背景色
        for (let y = 0; y < gridHeight; y++) {
          for (let x = 0; x < gridWidth; x++) {
            window.grid.clearCellBackground(startGridX + x, startGridY + y);
          }
        }
      };

      applyButton.addEventListener('click', () => {
        state.isApplied = !state.isApplied;
        checkbox.textContent = state.isApplied ? '[*]' : '[ ]';
        
        if (state.isApplied) {
          applyImageToGrid();
        } else {
          removeImageFromGrid();
        }
      });

      // 修改拖拽处理，在拖拽时更新网格
      const handleDrag = (e) => {
        if (state.isDragging) {
          // ... 保持现有拖拽代码 ...
          
          // 如果已应用，更新网格
          if (state.isApplied) {
            removeImageFromGrid();
            applyImageToGrid();
          }
        }
      };

      // 修改调整大小处理，在调整大小时更新网格
      const handleResize = (e) => {
        if (state.isResizing) {
          // ... 保持现有调整大小代码 ...
          
          // 如果已应用，更新网格
          if (state.isApplied) {
            removeImageFromGrid();
            applyImageToGrid();
          }
        }
      };

      return furnace;
    }

    // 将窗口置于顶层的函数
    function bringToFront(furnace) {
      const maxZIndex = Array.from(document.querySelectorAll('.alchemy-furnace'))
        .reduce((max, f) => Math.max(max, parseInt(getComputedStyle(f).zIndex) || 0), 1000);
      furnace.style.zIndex = maxZIndex + 1;
    }

    function initAlchemyFurnace() {
      // 当前打开的窗口
      let currentFurnace = null;
      let isProcessingClick = false;  // 添加点击处理状态标志

      // 处理图片点击
      document.addEventListener('click', async (e) => {
        // 只处理 Portal 中的图片点击
        if (e.target.tagName.toLowerCase() === 'img' && 
            e.target.closest('.notepad-content')) {
          
          e.preventDefault();
          e.stopPropagation();

          // 防止重复点击处理
          if (isProcessingClick) return;
          isProcessingClick = true;

          try {
            // 如果已经有窗口打开，先关闭它
            if (currentFurnace && document.body.contains(currentFurnace)) {
              currentFurnace.remove();
            }
            
            // 创建新窗口
            currentFurnace = createAlchemyFurnace(e.target.src);
            document.body.appendChild(currentFurnace);
            
            // 设置窗口位置（居中）
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const furnaceWidth = 400;
            const furnaceHeight = 300;
            
            const left = (windowWidth - furnaceWidth) / 2;
            const top = (windowHeight - furnaceHeight) / 2;
            
            currentFurnace.style.left = `${left}px`;
            currentFurnace.style.top = `${top}px`;
            currentFurnace.style.width = `${furnaceWidth}px`;
            currentFurnace.style.height = `${furnaceHeight}px`;
            currentFurnace.style.display = 'flex';
            currentFurnace.style.zIndex = '9999';

            // 关闭按钮功能
            const closeButton = currentFurnace.querySelector('.title-button.close');
            closeButton.addEventListener('click', () => {
              currentFurnace.remove();
              currentFurnace = null;
            });
          } finally {
            isProcessingClick = false;
          }
        }
      });

      // 处理窗口大小改变
      window.addEventListener('resize', () => {
        if (currentFurnace && document.body.contains(currentFurnace)) {
          const windowWidth = window.innerWidth;
          const windowHeight = window.innerHeight;
          const furnaceWidth = parseInt(currentFurnace.style.width);
          const furnaceHeight = parseInt(currentFurnace.style.height);
          
          // 确保窗口在视图范围内
          let left = parseInt(currentFurnace.style.left);
          let top = parseInt(currentFurnace.style.top);
          
          left = Math.max(0, Math.min(left, windowWidth - furnaceWidth));
          top = Math.max(0, Math.min(top, windowHeight - furnaceHeight));
          
          currentFurnace.style.left = `${left}px`;
          currentFurnace.style.top = `${top}px`;
        }
      });
    }

    // 确保只初始化一次
    let alchemyInitialized = false;

    // 在文档加载完成后初始化
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing systems');
      grid = new CharacterGrid();
      initializeMenu();
      initializeColorControl();
      initializeMinimize();
      initNotepadDrag();
      
      // 只在未初始化时调用一次
      if (!alchemyInitialized) {
        console.log('Initializing Alchemy Furnace functionality');
        initAlchemyFurnace();
        alchemyInitialized = true;
      }
    });
  </script>
</body>

</html>