<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nest Displacement</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: monospace; /* 使用等宽字体营造复古感 */
      background-color: #fff;
      color: #000;
      overflow: hidden;
      filter: grayscale(100%); /* 添加这一行，使整个页面变成黑白 */
    }

    .initial-state {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .hello {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 14px;
    }

    .start-button {
      font-family: monospace;
      font-size: 16px;
      padding: 10px 20px;
      margin: 20px;
      background: none;
      border: 1px solid #000;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .start-button:hover {
      background-color: #000;
      color: #fff;
    }

    .skip-link {
      font-size: 12px;
      color: #666;
      text-decoration: none;
      margin-top: 10px;
    }

    .skip-link:hover {
      text-decoration: underline;
    }

    /* 隐藏的内容，等待解锁 */
    .hidden {
      display: none;
    }

    /* 解锁后的样式变化 */
    .stage-1 {
      background-color: #f5f5f5;
      transition: background-color 2s ease;
    }

    .stage-2 {
      font-family: 'Times New Roman', serif;
      transition: font-family 1s ease;
    }

    .stage-3 {
      color: #333;
      transition: color 1s ease;
    }

    /* 添加新的样式 */
    .journey-stage-1 {
      position: fixed;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 1s ease;
    }

    .text-fragment {
      position: absolute;
      padding: 10px;
      background: #fff;
      border: 1px solid #000;
      cursor: move;
      font-size: 14px;
      max-width: 300px;
      text-align: left;
      transition: all 0.3s ease;
      opacity: 0;
      line-height: 1.6;
      user-select: none;
    }

    .text-fragment.visible {
      opacity: 1;
    }

    .text-fragment:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .collected-text {
      font-size: 12px;
      line-height: 1.6;
      margin: 0;
      padding: 5px 0;
      transition: all 0.5s ease;
    }

    .collected-text:not(:last-child) {
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .feather-outline {
      position: absolute;
      width: 500px;
      min-height: 300px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid;
      border-color: #dfdfdf #808080 #808080 #dfdfdf;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      font-family: 'MS Sans Serif', Arial, sans-serif;
    }

    /* 记事本标题栏 */
    .notepad-title {
      background: #000080;
      color: white;
      padding: 3px 5px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notepad-title-buttons {
      display: flex;
      gap: 2px;
    }

    .title-button {
      width: 16px;
      height: 14px;
      background: #c0c0c0;
      border: 1px solid;
      border-color: #ffffff #808080 #808080 #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
    }

    /* 记事本内容区 */
    .notepad-content {
      flex: 1;
      padding: 10px;
      background: #ffffff;
      border: 1px solid #808080;
      border-top: 2px solid #808080;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      overflow-y: auto;
      min-height: 250px;
      outline: none;
      caret-color: #000;
    }

    .notepad-content::selection {
      background: #000080;
      color: #fff;
    }

    /* 文本碎片的初始位置 */
    .text-fragment:nth-child(1) {
      top: 30%;
      left: 20%;
    }

    .text-fragment:nth-child(2) {
      top: 50%;
      right: 25%;
    }

    /* 简化提示元素的样式，移除过渡动画 */
    .unlock-text {
      position: absolute;
      left: 25%;
      top: 50%;
      transform: translate(-50%, -50%);
      font-family: monospace;
      font-size: 18px;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      white-space: nowrap;
      z-index: 1000;
    }

    .unlock-emoji {
      position: absolute;
      right: 25%;
      top: 50%;
      transform: translate(50%, -50%);
      font-size: 48px;
      opacity: 0;
      visibility: hidden;
      z-index: 1000;
      cursor: pointer;
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* 添加弹性动画 */
    }

    /* 添加悬停效果 */
    .unlock-emoji:hover {
      transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      animation: wiggle 0.5s infinite alternate;
    }

    /* 添加摇晃动画 */
    @keyframes wiggle {
      0% {
        transform: translate(50%, -50%) rotate(-15deg) scale(1.2);
      }
      100% {
        transform: translate(50%, -50%) rotate(15deg) scale(1.2);
      }
    }

    /* 简化显示类 */
    .unlock-text.show,
    .unlock-emoji.show {
      opacity: 1;
      visibility: visible;
    }

    /* 修改星号按钮样式，确保只有一处定义颜色 */
    .star-button {
      position: fixed;
      top: 17px;
      left: 20px;
      font-family: monospace;
      font-size: 24px;
      user-select: none;
      z-index: 2000;
      display: none;
      color: #000 !important; /* 使用 !important 确保颜色不被其他样式覆盖 */
      pointer-events: none;
    }

    .star-button.unlocked {
      pointer-events: auto;
      cursor: pointer;
      /* 移除任何颜色相关的样式 */
    }

    /* 修改菜单样式 */
    .effects-menu {
      position: fixed;
      top: 0;
      left: 0;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      display: none;
      z-index: 1999;
      background: white;
    }

    .menu-title {
      margin-bottom: 20px;
      margin-left: 35px; /* 与星号对齐 */
      white-space: pre;
    }

    .section-title {
      white-space: pre;
      margin-left: 45px; /* 比星号位置稍微靠右一点 */
      margin-top: -20px; /* 上移到与星号同一水平线 */
    }

    .effects-list {
      margin-left: 2px;
      margin-top: 10px; /* 从20px改为10px，向上移动10像素 */
      white-space: pre;
    }

    .effect-item {
      display: flex;
      align-items: center;
      gap: 10px; /* 添加选项框和文字之间的间距 */
      color: #888;
      cursor: default;
    }

    .effect-item.unlocked {
      color: #000;
      cursor: pointer;
    }

    .checkbox {
      font-family: monospace;
      user-select: none;
    }

    /* 选中状态的样式 */
    .effect-item.checked .checkbox {
      content: '[*]';
    }

    /* 修改子菜单样式 */
    .color-submenu {
      position: fixed;
      top: 0;
      right: 0; /* 改为0，直接贴住右边 */
      background: white;
      padding: 20px;
      font-family: monospace;
      font-size: 14px;
      display: none;
      z-index: 1998;
    }

    .slider-group {
      margin-bottom: 30px; /* 增加滑块组之间的间距 */
      width: 200px; /* 固定宽度 */
    }

    .slider-label {
      margin-bottom: 10px;
      white-space: pre;
    }

    .color-slider {
      width: 100%; /* 使用父元素的宽度 */
      -webkit-appearance: none;
      height: 2px;
      background: #000;
      outline: none;
      position: relative;
    }

    .color-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 10px;
      height: 20px;
      background: #000;
      cursor: pointer;
    }

    /* 添加滑块两端的线条 */
    .color-slider::before,
    .color-slider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 20px;
      height: 2px;
      background: #000;
    }

    .color-slider::before {
      left: -20px;
    }

    .color-slider::after {
      right: -20px;
    }

    /* 添加禁用状态的样式 */
    .effect-checkbox[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .effect-item {
      opacity: 0.5; /* 初始状态显示为半透明 */
      transition: opacity 0.3s ease;
    }

    .effect-item.unlocked {
      opacity: 1; /* 解锁后显示为完全不透明 */
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="initial-state">
    <div class="hello">Hello, world!</div>
    <button class="start-button" onclick="startJourney()">Start</button>
    <a href="#" class="skip-link" onclick="skipToNest()">Skip to nest</a>
  </div>

  <!-- 隐藏的内容，等待解锁 -->
  <div id="journey-content" class="hidden">
    <div class="journey-stage-1">
      <div class="unlock-emoji">🎁</div>
      <div class="unlock-text">Colors unlocked</div>
      <div class="feather-outline">
        <div class="notepad-title">
          <span>Untitled - Notepad</span>
          <div class="notepad-title-buttons">
            <button class="title-button">_</button>
            <button class="title-button">□</button>
            <button class="title-button">×</button>
          </div>
        </div>
        <div class="notepad-content" id="dropZone" contenteditable="true" spellcheck="false"></div>
      </div>
    </div>
  </div>

  <div id="nest-generator" class="hidden">
    <!-- 最终的生成器工具 -->
  </div>

  <!-- 修改菜单HTML结构 -->
  <div class="star-button">*</div>
  <div class="effects-menu">
    <div class="menu-title">Nest Displacement</div>
    <div class="menu-section">
      <div class="section-title">/EFFECTS</div>
      <div class="effects-list">
        <div class="effect-item">
          <span class="checkbox">[ ]</span>
          <span class="effect-name">COLOR</span>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加颜色控制子菜单 -->
  <div class="color-submenu">
    <div class="slider-group">
      <div class="slider-label">HUE</div>
      <input type="range" class="color-slider" id="hueSlider" min="0" max="360" value="180">
    </div>
    <div class="slider-group">
      <div class="slider-label">BRIGHTNESS</div>
      <input type="range" class="color-slider" id="brightnessSlider" min="0" max="100" value="50">
    </div>
    <div class="slider-group">
      <div class="slider-label">SATURATION</div>
      <input type="range" class="color-slider" id="saturationSlider" min="0" max="100" value="50">
    </div>
  </div>

  <script>
    // 添加文本数组
    const textSequence = [
      "Pet lovebirds often use their beaks to carefully cut pieces of paper and tuck them into their tail feathers.",
      "Despite being born and raised in artificial environments, they retain their instinctual drive as animals to collect diverse materials for nesting.",
      "Consequently, it's common to observe domestic lovebirds decorating themselves with objects produced by human society,",
      "resulting in a quirky yet fascinating sight. Inspired by this behavior,",
      "I've coined a new artistic term, Nest Displacement, to describe instinct-driven creative behaviors within artificial contexts, encompassing adaptation and mutation,",
      "or how individuals seek new possibilities within predefined structures.",
      "Another term, Nest-Grafting, combining the concepts of 'embedding' and 'nesting,'",
      "refers to an individual's appropriation and transformation of surrounding materials, describing artistic actions that incorporate heterogeneous elements into one's own system."
    ];

    let currentTextIndex = 0;
    let isColorUnlocked = false; // 添加一个状态标记
    let isMenuUnlocked = false;

    function startJourney() {
      document.querySelector('.initial-state').style.display = 'none';
      const journeyContent = document.getElementById('journey-content');
      journeyContent.classList.remove('hidden');
      
      // 显示星号按钮，确保是黑色
      const starButton = document.querySelector('.star-button');
      starButton.style.display = 'block';
      starButton.style.color = '#000'; // 确保显示时就是黑色
      
      setTimeout(() => {
        const stage1 = document.querySelector('.journey-stage-1');
        stage1.style.opacity = '1';
        initDragAndDrop();
        initNotepad();
        showNextText();
      }, 100);
    }

    function skipToNest() {
      document.querySelector('.initial-state').style.display = 'none';
      const nestGenerator = document.getElementById('nest-generator');
      nestGenerator.classList.remove('hidden');
      // 直接激活所有功能
      activateAllFeatures();
    }

    function initDragAndDrop() {
      const dropZone = document.getElementById('dropZone');
      const notepad = document.querySelector('.feather-outline');
      
      // 防止记事本窗口接收拖放
      notepad.addEventListener('dragover', (e) => {
        if (e.target !== dropZone && !dropZone.contains(e.target)) {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      // 只允许内容区域接收拖放
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.backgroundColor = '#f0f0f0';
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.style.backgroundColor = '#ffffff';
      });

      dropZone.addEventListener('drop', handleDrop);
    }

    function showNextText() {
      if (currentTextIndex >= textSequence.length) {
        // 解锁菜单
        const starButton = document.querySelector('.star-button');
        starButton.classList.add('unlocked');
        
        // 解锁 COLOR 选项
        isColorUnlocked = true;
        const colorEffect = document.querySelector('.effect-item');
        colorEffect.classList.add('unlocked');
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.disabled = false;
        
        showUnlockEffects();
        startStage2();
        return;
      }

      const fragment = document.createElement('div');
      fragment.className = 'text-fragment';
      fragment.textContent = textSequence[currentTextIndex];
      fragment.draggable = true;
      
      // 随机位置
      const randomPosition = getRandomPosition();
      fragment.style.left = randomPosition.x + 'px';
      fragment.style.top = randomPosition.y + 'px';

      document.querySelector('.journey-stage-1').appendChild(fragment);

      // 添加拖拽事件
      fragment.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', fragment.textContent);
        e.target.style.opacity = '0.5';
      });

      fragment.addEventListener('dragend', (e) => {
        e.target.style.opacity = '1';
      });

      setTimeout(() => fragment.classList.add('visible'), 100);
    }

    function handleDrop(e) {
      e.preventDefault();
      
      // 确保只有内容区域可以接收拖放
      const dropZone = document.getElementById('dropZone');
      if (e.target !== dropZone && !dropZone.contains(e.target)) {
        return; // 如果不是拖到内容区域，直接返回
      }

      dropZone.style.backgroundColor = '#ffffff';

      // 获取拖动的文本
      const text = e.dataTransfer.getData('text/plain');
      
      // 获取当前光标位置或末尾
      const selection = window.getSelection();
      let range;
      
      if (selection.rangeCount > 0) {
        range = selection.getRangeAt(0);
      } else {
        range = document.createRange();
        range.selectNodeContents(dropZone);
        range.collapse(false);
      }

      // 在光标位置插入文本
      const textNode = document.createTextNode(
        (dropZone.textContent ? '\n\n' : '') + text
      );
      range.insertNode(textNode);

      // 移动光标到插入文本的末尾
      range.setStartAfter(textNode);
      range.setEndAfter(textNode);
      selection.removeAllRanges();
      selection.addRange(range);

      // 移除原始拖动的文本
      const draggedText = document.querySelector('.text-fragment');
      draggedText.remove();

      // 显示下一段文本
      currentTextIndex++;
      showNextText();

      // 保持焦点
      dropZone.focus();
    }

    function getRandomPosition() {
      const padding = 50;
      const maxWidth = window.innerWidth - 400;
      const maxHeight = window.innerHeight - 100;
      
      // 避免生成在中央区域
      const centerX = window.innerWidth / 2;
      const centerY = window.innerHeight / 2;
      let x, y;
      
      do {
        x = padding + Math.random() * (maxWidth - padding * 2);
      } while (Math.abs(x - centerX) < 300);
      
      do {
        y = padding + Math.random() * (maxHeight - padding * 2);
      } while (Math.abs(y - centerY) < 200);

      return { x, y };
    }

    function startStage2() {
      document.body.classList.add('stage-1');
      // 不再自动移除滤镜，等待用户点击礼物
    }

    function activateAllFeatures() {
      // 激活所有高级功能
      document.body.classList.add('stage-1', 'stage-2', 'stage-3');
      // 初始化生成器工具
      initNestGenerator();
      initDragAndDrop();
    }

    function initNestGenerator() {
      // 这里将实现最终的生成器工具功能
    }

    // 添加记事本初始化函数
    function initNotepad() {
      const dropZone = document.getElementById('dropZone');
      
      // 自动聚焦
      dropZone.focus();

      // 添加快捷键支持
      dropZone.addEventListener('keydown', (e) => {
        // Tab键支持
        if (e.key === 'Tab') {
          e.preventDefault();
          const selection = window.getSelection();
          const range = selection.getRangeAt(0);
          const tabNode = document.createTextNode('    '); // 4个空格
          range.insertNode(tabNode);
          range.setStartAfter(tabNode);
          range.setEndAfter(tabNode);
          selection.removeAllRanges();
          selection.addRange(range);
        }
      });
    }

    // 添加随机颜色生成函数
    function getRandomPastelColor() {
      // 生成柔和的颜色
      const hue = Math.floor(Math.random() * 360); // 随机色相
      const saturation = 30 + Math.random() * 20; // 30-50%的饱和度
      const lightness = 85 + Math.random() * 10; // 85-95%的亮度
      return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    // 修改 showUnlockEffects 函数
    function showUnlockEffects() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      const notepad = document.querySelector('.feather-outline');
      
      // 获取记事本的位置信息
      const notepadRect = notepad.getBoundingClientRect();
      const windowWidth = window.innerWidth;
      
      // 计算左右区域的中点
      const leftAreaCenter = notepadRect.left / 2;
      const rightAreaCenter = (windowWidth - notepadRect.right) / 2 + notepadRect.right;
      
      // 设置文字和emoji的位置
      text.style.left = `${leftAreaCenter}px`;
      emoji.style.right = `${windowWidth - rightAreaCenter}px`;
      
      // 显示元素
      text.classList.add('show');
      emoji.classList.add('show');

      // 添加点击事件
      emoji.addEventListener('click', unlockColors);
    }

    // 修改 unlockColors 函数
    function unlockColors() {
      const emoji = document.querySelector('.unlock-emoji');
      const text = document.querySelector('.unlock-text');
      
      // 移除黑白滤镜
      document.body.style.transition = 'filter 1s ease, background-color 1s ease';
      document.body.style.filter = 'grayscale(0%)';
      
      // 设置随机背景色
      document.body.style.backgroundColor = getRandomPastelColor();
      
      // 移除提示元素
      emoji.style.visibility = 'hidden';
      text.style.visibility = 'hidden';
      
      // 解锁菜单
      isMenuUnlocked = true;
      const starButton = document.querySelector('.star-button');
      starButton.classList.add('unlocked');
      
      // 解锁 COLOR 选项
      isColorUnlocked = true;
      const colorEffect = document.querySelector('.effect-item');
      colorEffect.classList.add('unlocked');
      const checkbox = colorEffect.querySelector('.checkbox');
      checkbox.disabled = false;
      
      // 移除点击事件，防止重复触发
      emoji.removeEventListener('click', unlockColors);
    }

    // 添加位置检查和调整函数
    function adjustSubmenuPosition() {
      const submenu = document.querySelector('.color-submenu');
      if (!submenu || submenu.style.display === 'none') return;

      const rect = submenu.getBoundingClientRect();
      const windowHeight = window.innerHeight;

      // 检查是否超出视窗底部
      if (rect.bottom > windowHeight) {
        // 调整位置，确保在视窗内
        submenu.style.top = 'auto';
        submenu.style.bottom = '20px';
        submenu.style.transform = 'none';
      }
    }

    // 修改颜色控制逻辑
    function initializeColorControl() {
      const colorEffect = document.querySelector('.effect-item');
      const colorSubmenu = document.querySelector('.color-submenu');
      const hueSlider = document.getElementById('hueSlider');
      const brightnessSlider = document.getElementById('brightnessSlider');
      const saturationSlider = document.getElementById('saturationSlider');
      let isChecked = false;

      // 点击 COLOR 选项的处理
      colorEffect.addEventListener('click', (e) => {
        if (!colorEffect.classList.contains('unlocked')) return;

        isChecked = !isChecked;
        const checkbox = colorEffect.querySelector('.checkbox');
        checkbox.textContent = isChecked ? '[*]' : '[ ]';
        colorEffect.classList.toggle('checked');
        colorSubmenu.style.display = isChecked ? 'block' : 'none';
      });

      // 滑块控制颜色
      function updateColor() {
        const hue = hueSlider.value;
        const brightness = brightnessSlider.value;
        const saturation = saturationSlider.value;
        
        document.body.style.backgroundColor = 
          `hsl(${hue}, ${saturation}%, ${brightness}%)`;
      }

      // 添加滑块事件监听
      hueSlider.addEventListener('input', updateColor);
      brightnessSlider.addEventListener('input', updateColor);
      saturationSlider.addEventListener('input', updateColor);
    }

    // 修改星号按钮的初始化
    function initializeMenu() {
      const starButton = document.querySelector('.star-button');
      const menu = document.querySelector('.effects-menu');
      let isMenuOpen = false;

      starButton.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!isMenuUnlocked) return;

        isMenuOpen = !isMenuOpen;
        menu.style.display = isMenuOpen ? 'block' : 'none';
      });

      document.addEventListener('click', (e) => {
        if (isMenuOpen && !menu.contains(e.target)) {
          isMenuOpen = false;
          menu.style.display = 'none';
        }
      });

      initializeColorControl();
    }

    // 添加窗口大小改变时的位置调整
    window.addEventListener('resize', adjustSubmenuPosition);

    document.addEventListener('DOMContentLoaded', initializeMenu);
  </script>
</body>
</html>